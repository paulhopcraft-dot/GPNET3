{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Enhanced Features Schema for Ralph Autonomous Execution",
  "description": "Extended features.json schema with user stories and browser verification support",
  "type": "object",
  "properties": {
    "features": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "Unique feature identifier"
          },
          "name": {
            "type": "string",
            "description": "Feature name"
          },
          "description": {
            "type": "string",
            "description": "Feature description"
          },
          "status": {
            "type": "string",
            "enum": ["pending", "in_progress", "completed", "blocked"],
            "description": "Overall feature status"
          },
          "priority": {
            "type": "string",
            "enum": ["low", "medium", "high", "critical"],
            "description": "Feature priority level"
          },
          "userStories": {
            "type": "array",
            "description": "User stories for Ralph autonomous execution",
            "items": {
              "type": "object",
              "properties": {
                "id": {
                  "type": "string",
                  "description": "Unique story identifier"
                },
                "story": {
                  "type": "string",
                  "description": "User story in 'As a [user], I want [goal] so that [reason]' format"
                },
                "acceptanceCriteria": {
                  "type": "array",
                  "description": "Browser-verifiable acceptance criteria",
                  "items": {
                    "type": "string",
                    "pattern": "^(browser_verify:|manual_verify:|test_verify:)\\s+.+",
                    "description": "Must start with verification type (browser_verify, manual_verify, test_verify)"
                  },
                  "minItems": 1
                },
                "prerequisites": {
                  "type": "array",
                  "description": "Dependencies that must exist before Ralph starts this story",
                  "items": {
                    "type": "string"
                  }
                },
                "rollbackProcedure": {
                  "type": "string",
                  "description": "How to undo this story if it fails"
                },
                "edgeCases": {
                  "type": "array",
                  "description": "Edge cases and how to handle them",
                  "items": {
                    "type": "object",
                    "properties": {
                      "scenario": {
                        "type": "string",
                        "description": "Edge case scenario"
                      },
                      "handling": {
                        "type": "string",
                        "description": "How Ralph should handle this case"
                      }
                    },
                    "required": ["scenario", "handling"]
                  }
                },
                "estimatedMinutes": {
                  "type": "number",
                  "maximum": 30,
                  "description": "Estimated time for Ralph to complete (max 30 minutes)"
                },
                "passes": {
                  "type": "boolean",
                  "description": "Whether this story passes all acceptance criteria"
                },
                "gsdTaskRef": {
                  "type": "string",
                  "description": "Reference to original GSD task ID when converted from GSD plan"
                },
                "attempts": {
                  "type": "array",
                  "description": "Ralph execution attempts for this story",
                  "items": {
                    "type": "object",
                    "properties": {
                      "timestamp": {
                        "type": "string",
                        "format": "date-time"
                      },
                      "success": {
                        "type": "boolean"
                      },
                      "browserResults": {
                        "type": "array",
                        "items": {
                          "type": "object",
                          "properties": {
                            "criterion": {
                              "type": "string"
                            },
                            "passed": {
                              "type": "boolean"
                            },
                            "error": {
                              "type": "string"
                            }
                          }
                        }
                      },
                      "notes": {
                        "type": "string"
                      }
                    },
                    "required": ["timestamp", "success"]
                  }
                }
              },
              "required": ["id", "story", "acceptanceCriteria", "rollbackProcedure", "passes"]
            }
          },
          "integrationTests": {
            "type": "array",
            "description": "Tests Ralph should run after completing user stories",
            "items": {
              "type": "string"
            }
          },
          "completeRollback": {
            "type": "string",
            "description": "How to rollback the entire feature if needed"
          },
          "environmentRequirements": {
            "type": "object",
            "description": "Environment setup required for this feature",
            "properties": {
              "services": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "Services that must be running (e.g., database, redis)"
              },
              "envVars": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "Environment variables that must be set"
              },
              "ports": {
                "type": "array",
                "items": {
                  "type": "number"
                },
                "description": "Ports that must be available"
              }
            }
          },
          "gsdIntegration": {
            "type": "object",
            "description": "GSD integration metadata when feature was converted from GSD plan",
            "properties": {
              "sourcePhase": {
                "type": "number",
                "description": "GSD phase number this feature was converted from"
              },
              "convertedAt": {
                "type": "string",
                "format": "date-time",
                "description": "When the GSD plan was converted to Ralph format"
              },
              "sourcePath": {
                "type": "string",
                "description": "Path to the original GSD PLAN.md file"
              },
              "planChecksum": {
                "type": "string",
                "description": "Checksum of source plan for change detection"
              }
            }
          }
        },
        "required": ["id", "name", "status", "userStories"]
      }
    },
    "gsdConfig": {
      "type": "object",
      "description": "GSD integration configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false,
          "description": "Whether this features.json was generated from GSD"
        },
        "projectPath": {
          "type": "string",
          "description": "Path to .planning directory"
        },
        "autoSync": {
          "type": "boolean",
          "default": true,
          "description": "Automatically sync results back to GSD format"
        },
        "phaseMapping": {
          "type": "object",
          "description": "Mapping of GSD phases to feature IDs",
          "additionalProperties": {
            "type": "string"
          }
        }
      }
    },
    "ralphConfig": {
      "type": "object",
      "description": "Ralph execution configuration",
      "properties": {
        "maxIterations": {
          "type": "number",
          "default": 10,
          "description": "Maximum iterations Ralph will attempt"
        },
        "serverUrl": {
          "type": "string",
          "default": "http://localhost:3000",
          "description": "URL for browser verification"
        },
        "browserTimeout": {
          "type": "number",
          "default": 30000,
          "description": "Browser operation timeout in milliseconds"
        },
        "rollbackOnFailure": {
          "type": "boolean",
          "default": true,
          "description": "Whether Ralph should auto-rollback on failure"
        },
        "commitEachStory": {
          "type": "boolean",
          "default": true,
          "description": "Whether to commit after each successful story"
        }
      }
    },
    "ralphApproval": {
      "type": "object",
      "description": "PRD approval status for Ralph execution",
      "properties": {
        "approved": {
          "type": "boolean",
          "description": "Whether this PRD is approved for Ralph execution"
        },
        "approvedBy": {
          "type": "string",
          "description": "Who approved the PRD"
        },
        "approvedAt": {
          "type": "string",
          "format": "date-time",
          "description": "When the PRD was approved"
        },
        "validationResults": {
          "type": "object",
          "description": "Results of PRD hardening validation"
        }
      }
    }
  },
  "required": ["features"]
}