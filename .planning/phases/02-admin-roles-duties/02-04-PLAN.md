---
phase: 02-admin-roles-duties
plan: 04
type: execute
wave: 2
depends_on: ["02-02"]
files_modified:
  - client/src/pages/admin/duties/DutiesList.tsx
  - client/src/pages/admin/duties/DutyForm.tsx
  - client/src/components/DemandMatrix.tsx
  - client/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can see list of duties for a role"
    - "Admin can create a duty with demands matrix"
    - "Admin can set all physical demands (12 categories)"
    - "Admin can set cognitive demands (3 categories)"
    - "Admin can set weight limits for lifting/carrying"
    - "Admin can mark duty as modifiable"
    - "Admin can add risk flags"
    - "Admin can edit duty and update demands"
    - "Admin can delete duty"
  artifacts:
    - path: "client/src/pages/admin/duties/DutiesList.tsx"
      provides: "Duty list page for a role"
      min_lines: 100
    - path: "client/src/pages/admin/duties/DutyForm.tsx"
      provides: "Create/Edit duty form with demands"
      min_lines: 200
    - path: "client/src/components/DemandMatrix.tsx"
      provides: "Reusable physical/cognitive demands matrix component"
      min_lines: 100
  key_links:
    - from: "client/src/pages/admin/duties/DutyForm.tsx"
      to: "DemandMatrix.tsx"
      via: "Component import"
      pattern: "import.*DemandMatrix"
    - from: "client/src/pages/admin/duties/DutiesList.tsx"
      to: "/api/admin/duties/role/:roleId"
      via: "TanStack Query"
      pattern: "queryKey.*admin/duties"
---

<objective>
Create frontend pages for managing RTW duties with physical/cognitive demand matrices (ADMIN-05 to ADMIN-11 UI).

Purpose: Provide the admin interface for employers to define duties with complete demand specifications.
Output: React list page, form page, and reusable DemandMatrix component.
</objective>

<execution_context>
@C:\Users\Paul\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Paul\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-admin-roles-duties/02-RESEARCH.md
@client/src/pages/admin/CompanyList.tsx (list page pattern)
@client/src/pages/admin/CompanyForm.tsx (form page pattern)
@shared/schema.ts (rtwDutyDemands fields - lines 1686-1716)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DemandMatrix component</name>
  <files>client/src/components/DemandMatrix.tsx</files>
  <action>
Create a reusable component for displaying and editing physical/cognitive demands:

1. Define constants:
   FREQUENCIES = ["never", "occasionally", "frequently", "constantly"]

   PHYSICAL_DEMANDS = [
     { key: "bending", label: "Bending" },
     { key: "squatting", label: "Squatting" },
     { key: "kneeling", label: "Kneeling" },
     { key: "twisting", label: "Twisting" },
     { key: "reachingOverhead", label: "Reaching Overhead" },
     { key: "reachingForward", label: "Reaching Forward" },
     { key: "lifting", label: "Lifting", hasWeight: true, weightKey: "liftingMaxKg" },
     { key: "carrying", label: "Carrying", hasWeight: true, weightKey: "carryingMaxKg" },
     { key: "standing", label: "Standing" },
     { key: "sitting", label: "Sitting" },
     { key: "walking", label: "Walking" },
     { key: "repetitiveMovements", label: "Repetitive Movements" },
   ]

   COGNITIVE_DEMANDS = [
     { key: "concentration", label: "Concentration" },
     { key: "stressTolerance", label: "Stress Tolerance" },
     { key: "workPace", label: "Work Pace" },
   ]

2. Props interface:
   interface DemandMatrixProps {
     value: DemandValues;
     onChange: (value: DemandValues) => void;
     readonly?: boolean;
   }

3. Layout:
   - Header row with frequency labels (N, O, F, C)
   - Physical demands section with label
   - Each demand: label + radio buttons for frequency
   - For lifting/carrying: show weight input when frequency != "never"
   - Cognitive demands section with label
   - Each demand: label + radio buttons

4. Styling:
   - Use grid layout for alignment
   - Frequency buttons styled as small circles or abbreviated labels
   - Weight inputs: small Input with "kg" suffix
   - Color hint: N=gray, O=blue, F=yellow, C=red (use subtle bg colors)

5. Handler:
   - handleFrequencyChange: update value and clear weight if "never"
   - handleWeightChange: update weight value
  </action>
  <verify>
Run: npm run build
Expected: No TypeScript errors in DemandMatrix.tsx
  </verify>
  <done>
DemandMatrix component compiles with all 15 demand categories and weight inputs
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DutiesList page</name>
  <files>client/src/pages/admin/duties/DutiesList.tsx</files>
  <action>
Create a duty list page for a specific role:

1. Get roleId from URL params: const { roleId } = useParams()

2. Fetch role data to show role name in header:
   useQuery for /api/admin/roles/:roleId

3. Fetch duties:
   useQuery for /api/admin/duties/role/:roleId

4. Page header:
   - Back button to /admin/roles
   - Title: "Duties for [Role Name]"
   - "Add Duty" button linking to /admin/roles/:roleId/duties/new

5. Table with columns:
   - Name
   - Modifiable (Yes/No badge)
   - Risk Flags (comma-separated or count)
   - Demands Summary (e.g., "8 demands set")
   - Actions (Edit, Delete)

6. Edit button: navigate to /admin/roles/:roleId/duties/:dutyId
7. Delete button: AlertDialog confirmation, DELETE mutation

8. Empty state if no duties: "No duties defined. Add your first duty."

9. Copy Role button in header:
   - Opens dialog for new role name
   - POST /api/admin/duties/role/:roleId/copy
   - On success: navigate to new role's duties page
  </action>
  <verify>
Run: npm run build
Expected: No TypeScript errors in DutiesList.tsx
  </verify>
  <done>
DutiesList page compiles, shows duties for role with CRUD actions and copy feature
  </done>
</task>

<task type="auto">
  <name>Task 3: Create DutyForm page</name>
  <files>client/src/pages/admin/duties/DutyForm.tsx</files>
  <action>
Create a duty form page with demand matrix:

1. Get params: const { roleId, dutyId } = useParams()
   - Edit mode: dutyId exists

2. Form schema with Zod:
   const dutySchema = z.object({
     name: z.string().min(1, "Duty name is required"),
     description: z.string().optional(),
     isModifiable: z.boolean().default(false),
     riskFlags: z.array(z.string()).default([]),
     demands: z.object({
       bending: z.string().default("never"),
       squatting: z.string().default("never"),
       // ... all 12 physical + 3 cognitive
       liftingMaxKg: z.number().nullable().optional(),
       carryingMaxKg: z.number().nullable().optional(),
     }),
   });

3. Form sections:
   a) Basic Info:
      - Name (required Input)
      - Description (optional Textarea)
      - Modifiable (Switch with explanation text)

   b) Risk Flags:
      - Multi-select or tag input
      - Suggestions: "Lifting Hazard", "Fall Risk", "Repetitive Strain", "Hearing Protection", "Chemical Exposure"
      - Allow custom entries

   c) Physical Demands (use DemandMatrix component)

   d) Cognitive Demands (part of DemandMatrix)

4. Fetch existing duty in edit mode:
   - useQuery for /api/admin/duties/:dutyId
   - form.reset() with loaded data including demands

5. Submit mutations:
   - Create: POST /api/admin/duties with roleId in body
   - Update: PUT /api/admin/duties/:dutyId
   - Include demands object in payload

6. Navigation:
   - Back button to /admin/roles/:roleId/duties
   - On success: navigate to duties list
  </action>
  <verify>
Run: npm run build
Expected: No TypeScript errors in DutyForm.tsx
  </verify>
  <done>
DutyForm page compiles with full demand matrix integration
  </done>
</task>

<task type="auto">
  <name>Task 4: Register duty routes in App.tsx</name>
  <files>client/src/App.tsx</files>
  <action>
Add routes for the duties pages:

1. Import components:
   import DutiesList from "@/pages/admin/duties/DutiesList";
   import DutyForm from "@/pages/admin/duties/DutyForm";

2. Add routes (near other admin routes):
   <Route path="/admin/roles/:roleId/duties" element={<DutiesList />} />
   <Route path="/admin/roles/:roleId/duties/new" element={<DutyForm />} />
   <Route path="/admin/roles/:roleId/duties/:dutyId" element={<DutyForm />} />

3. Ensure proper nesting/protection consistent with existing routes
  </action>
  <verify>
Run: npm run dev
Navigate to: http://localhost:5173/admin/roles/[role-id]/duties
Expected: Duties list page renders
  </verify>
  <done>
Duty routes registered, pages accessible in browser
  </done>
</task>

</tasks>

<verification>
- [ ] npm run build passes
- [ ] DemandMatrix shows all 15 demand categories
- [ ] Weight inputs appear only when frequency != "never"
- [ ] /admin/roles/:roleId/duties shows duties list
- [ ] /admin/roles/:roleId/duties/new shows create form
- [ ] Create duty saves with demands
- [ ] Edit duty loads and saves demands
- [ ] Delete duty removes from list
- [ ] Copy role creates new role with duties
</verification>

<success_criteria>
Admin can fully manage duties with physical and cognitive demand matrices. Weight limits conditional on frequency. Risk flags editable. Role copy works.
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-roles-duties/02-04-SUMMARY.md`
</output>
