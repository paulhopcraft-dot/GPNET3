---
phase: 02-admin-roles-duties
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/routes/admin/roles.ts
  - server/routes/admin/index.ts
autonomous: true

must_haves:
  truths:
    - "Admin can list all roles for their organization"
    - "Admin can create a new role with name and description"
    - "Admin can edit an existing role"
    - "Admin can soft-delete a role (blocked if active plans exist)"
  artifacts:
    - path: "server/routes/admin/roles.ts"
      provides: "Roles CRUD API endpoints"
      exports: ["router"]
    - path: "server/routes/admin/index.ts"
      provides: "Route registration"
      contains: "roles"
  key_links:
    - from: "server/routes/admin/roles.ts"
      to: "rtwRoles table"
      via: "Drizzle ORM"
      pattern: "db\\.select\\(\\)\\.from\\(rtwRoles\\)"
    - from: "server/routes/admin/roles.ts"
      to: "rtwPlans table"
      via: "Active plan check on delete"
      pattern: "rtwPlans"
---

<objective>
Create backend API routes for managing RTW job roles (ADMIN-01 to ADMIN-04).

Purpose: Provide the data layer for employers to define their job roles for the RTW planner system.
Output: Express router with GET (list/single), POST (create), PUT (update), DELETE (soft delete) endpoints.
</objective>

<execution_context>
@C:\Users\Paul\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Paul\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-admin-roles-duties/02-RESEARCH.md
@server/routes/admin/organizations.ts (CRUD pattern reference)
@shared/schema.ts (rtwRoles, rtwPlans tables - lines 1655-1741)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create roles CRUD router</name>
  <files>server/routes/admin/roles.ts</files>
  <action>
Create a new Express router following the organizations.ts pattern exactly. Include:

1. GET / - List all roles for organization (ADMIN-01)
   - Filter by req.user.organizationId
   - Include duty count via subquery
   - Support optional search query param
   - Order by name ascending

2. GET /:id - Get single role by ID
   - Include duties with their demands (left join)
   - Filter by organization for security

3. POST / - Create new role (ADMIN-02)
   - Validate with Zod schema: name (required), description (optional)
   - Set organizationId from req.user
   - Return 201 with created role

4. PUT /:id - Update existing role (ADMIN-03)
   - Verify role belongs to user's organization
   - Validate partial update
   - Set updatedAt

5. DELETE /:id - Soft delete role (ADMIN-04)
   - Check for active RTW plans (status != 'draft') referencing this role
   - If plans exist: return 409 with "Cannot delete role - has active RTW plans"
   - If no plans: set isActive = false

Apply authorize(["admin"]) middleware to all routes.
Use logger.api.error for error logging (match organizations.ts pattern).
  </action>
  <verify>
Run: npm run build
Expected: No TypeScript errors in server/routes/admin/roles.ts
  </verify>
  <done>
Routes file compiles without errors, all 5 endpoints defined with proper typing
  </done>
</task>

<task type="auto">
  <name>Task 2: Register roles router</name>
  <files>server/routes/admin/index.ts</files>
  <action>
Edit the admin routes index file to register the new roles router:

1. Import roles router: `import rolesRouter from "./roles";`
2. Mount at /roles path: `router.use("/roles", rolesRouter);`
3. Follow same pattern as organizations and insurers imports

This will make the routes available at /api/admin/roles/*
  </action>
  <verify>
Run: npm run dev
Then: curl http://localhost:5000/api/admin/roles -H "Authorization: Bearer [token]"
Expected: 200 response with roles array (empty is fine)
  </verify>
  <done>
Roles router registered and accessible at /api/admin/roles
  </done>
</task>

<task type="auto">
  <name>Task 3: Manual API test verification</name>
  <files></files>
  <action>
Test all endpoints manually using curl or similar:

1. Create role:
   POST /api/admin/roles with {"name": "Test Role", "description": "Test"}
   Expected: 201 with role object

2. List roles:
   GET /api/admin/roles
   Expected: 200 with array containing test role

3. Get single:
   GET /api/admin/roles/:id (use ID from step 1)
   Expected: 200 with role object

4. Update role:
   PUT /api/admin/roles/:id with {"description": "Updated"}
   Expected: 200 with updated role

5. Delete role:
   DELETE /api/admin/roles/:id
   Expected: 200 success (soft delete)

6. Verify soft delete:
   GET /api/admin/roles should not include the deleted role
  </action>
  <verify>
All 6 operations complete successfully
  </verify>
  <done>
CRUD operations verified working via manual API testing
  </done>
</task>

</tasks>

<verification>
- [ ] npm run build passes
- [ ] GET /api/admin/roles returns organization-scoped roles
- [ ] POST /api/admin/roles creates role with organizationId
- [ ] PUT /api/admin/roles/:id updates role
- [ ] DELETE /api/admin/roles/:id soft-deletes and checks for active plans
- [ ] All responses follow { success: true, data: ... } format
</verification>

<success_criteria>
Admin user can perform CRUD operations on roles via API. Organization isolation enforced. Active plan protection works on delete.
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-roles-duties/02-01-SUMMARY.md`
</output>
