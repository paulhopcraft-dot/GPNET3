---
phase: 02-admin-roles-duties
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - server/routes/admin/duties.ts
  - server/routes/admin/index.ts
autonomous: true

must_haves:
  truths:
    - "Admin can list all duties for a specific role"
    - "Admin can create a duty with name, description, and modifiable flag"
    - "Admin can set physical and cognitive demands for a duty"
    - "Admin can mark duty risk flags"
    - "Admin can edit duty and its demands"
    - "Admin can soft-delete a duty"
    - "Admin can copy a role with all its duties"
  artifacts:
    - path: "server/routes/admin/duties.ts"
      provides: "Duties CRUD API endpoints including demands"
      exports: ["router"]
  key_links:
    - from: "server/routes/admin/duties.ts"
      to: "rtwDuties table"
      via: "Drizzle ORM"
      pattern: "db\\.insert\\(rtwDuties\\)"
    - from: "server/routes/admin/duties.ts"
      to: "rtwDutyDemands table"
      via: "Cascade create/update"
      pattern: "rtwDutyDemands"
---

<objective>
Create backend API routes for managing RTW duties and their demand matrices (ADMIN-05 to ADMIN-12).

Purpose: Provide the data layer for employers to define duties with physical and cognitive demands for each job role.
Output: Express router with full CRUD for duties, demand matrix management, and role copy functionality.
</objective>

<execution_context>
@C:\Users\Paul\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Paul\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-admin-roles-duties/02-RESEARCH.md
@server/routes/admin/organizations.ts (CRUD pattern reference)
@shared/schema.ts (rtwDuties, rtwDutyDemands tables - lines 1668-1716)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create duties CRUD router with demands</name>
  <files>server/routes/admin/duties.ts</files>
  <action>
Create a new Express router for duties management. Include:

1. GET /role/:roleId - List all duties for a role (ADMIN-05)
   - Filter by roleId and organizationId
   - Include demands via left join
   - Filter isActive = true
   - Order by name ascending

2. GET /:id - Get single duty with demands
   - Left join rtwDutyDemands
   - Verify organization access

3. POST / - Create new duty (ADMIN-06, 07, 08, 09)
   - Validate with Zod schema:
     - roleId (required)
     - name (required)
     - description (optional)
     - isModifiable (boolean, default false)
     - riskFlags (string array, optional)
     - demands object (all physical + cognitive fields)
   - Insert duty record first
   - Then insert rtwDutyDemands record with dutyId
   - Use transaction to ensure both succeed or both fail

4. PUT /:id - Update duty and demands (ADMIN-10)
   - Update rtwDuties fields
   - Upsert rtwDutyDemands (update if exists, create if not)
   - Use transaction

5. DELETE /:id - Soft delete duty (ADMIN-11)
   - Set isActive = false on rtwDuties
   - Demands table has cascade delete but we're soft-deleting so leave demands

6. POST /role/:roleId/copy - Copy role with all duties (ADMIN-12)
   - Accept newName in body (optional, defaults to "Original Name (Copy)")
   - Create new rtwRoles record
   - Get all duties for source role
   - For each duty:
     - Create new duty record linked to new role
     - Copy demands record linked to new duty
   - Return new role with duties

Physical demand fields: bending, squatting, kneeling, twisting, reachingOverhead, reachingForward, lifting, liftingMaxKg, carrying, carryingMaxKg, standing, sitting, walking, repetitiveMovements
Cognitive demand fields: concentration, stressTolerance, workPace

Frequency values: "never" | "occasionally" | "frequently" | "constantly"
Weight limits (liftingMaxKg, carryingMaxKg): integer or null

Apply authorize(["admin"]) middleware to all routes.
  </action>
  <verify>
Run: npm run build
Expected: No TypeScript errors in server/routes/admin/duties.ts
  </verify>
  <done>
Routes file compiles without errors, all 6 endpoints defined with proper transaction handling
  </done>
</task>

<task type="auto">
  <name>Task 2: Register duties router</name>
  <files>server/routes/admin/index.ts</files>
  <action>
Edit the admin routes index file to register the duties router:

1. Import duties router: `import dutiesRouter from "./duties";`
2. Mount at /duties path: `router.use("/duties", dutiesRouter);`

This makes endpoints available at:
- /api/admin/duties/role/:roleId (list by role)
- /api/admin/duties/:id (get/update/delete single)
- /api/admin/duties (create)
- /api/admin/duties/role/:roleId/copy (copy role)
  </action>
  <verify>
Run: npm run dev
Then: curl http://localhost:5000/api/admin/duties/role/test-role-id -H "Authorization: Bearer [token]"
Expected: 200 response (even if empty array)
  </verify>
  <done>
Duties router registered and accessible at /api/admin/duties/*
  </done>
</task>

<task type="auto">
  <name>Task 3: Test duty lifecycle with demands</name>
  <files></files>
  <action>
Test the complete duty lifecycle:

1. Create role first (via /api/admin/roles)
2. Create duty with demands:
   POST /api/admin/duties
   Body: {
     "roleId": "[role-id]",
     "name": "Manual Lifting",
     "description": "Lift boxes from floor to shelf",
     "isModifiable": true,
     "riskFlags": ["lifting_hazard"],
     "demands": {
       "lifting": "frequently",
       "liftingMaxKg": 15,
       "bending": "occasionally",
       "standing": "constantly"
     }
   }
   Expected: 201 with duty and demands

3. List duties for role:
   GET /api/admin/duties/role/:roleId
   Expected: Array with created duty, demands included

4. Update duty:
   PUT /api/admin/duties/:id
   Body: { "isModifiable": false, "demands": { "liftingMaxKg": 10 } }
   Expected: Updated duty

5. Copy role:
   POST /api/admin/duties/role/:roleId/copy
   Body: { "newName": "Warehouse Role Copy" }
   Expected: New role with copied duties

6. Delete duty:
   DELETE /api/admin/duties/:id
   Expected: Soft delete success
  </action>
  <verify>
All 6 operations complete successfully via curl or API testing tool
  </verify>
  <done>
Complete duty lifecycle with demands verified working
  </done>
</task>

</tasks>

<verification>
- [ ] npm run build passes
- [ ] GET /api/admin/duties/role/:roleId returns duties with demands
- [ ] POST /api/admin/duties creates duty AND demands in transaction
- [ ] PUT /api/admin/duties/:id updates duty and demands
- [ ] DELETE /api/admin/duties/:id soft-deletes duty
- [ ] POST /api/admin/duties/role/:roleId/copy creates complete copy
- [ ] All physical and cognitive demand fields handled
</verification>

<success_criteria>
Admin can perform full CRUD on duties with demand matrices. Role copy creates complete copies. Transaction safety on multi-table operations.
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-roles-duties/02-02-SUMMARY.md`
</output>
