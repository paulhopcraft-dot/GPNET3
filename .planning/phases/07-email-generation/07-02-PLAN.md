---
phase: 07-email-generation
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - client/src/components/rtw/ManagerEmailSection.tsx
  - server/routes/rtwPlans.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can click Send Email button to send the manager notification"
    - "User must confirm recipient email address before sending"
    - "Email is sent via SMTP (or logged in dev mode)"
    - "Email send is logged to audit trail"
    - "User sees confirmation when email sent successfully"
  artifacts:
    - path: "client/src/components/rtw/ManagerEmailSection.tsx"
      provides: "Send Email button and confirmation modal"
      contains: "Send Email"
    - path: "server/routes/rtwPlans.ts"
      provides: "POST /email/send endpoint"
      contains: "email/send"
  key_links:
    - from: "client/src/components/rtw/ManagerEmailSection.tsx"
      to: "/api/rtw-plans/:planId/email/send"
      via: "fetch POST call"
      pattern: "fetch.*email/send"
    - from: "server/routes/rtwPlans.ts"
      to: "server/services/emailService.ts"
      via: "sendEmail import"
      pattern: "import.*sendEmail"
---

<objective>
Add SMTP email sending capability for RTW plan manager notifications

Purpose: Enable users to send RTW plan emails directly to managers without manual copy-paste (EMAIL-10)
Output: Send Email button in UI, confirmation dialog, and backend API endpoint using existing emailService
</objective>

<execution_context>
@C:\Users\Paul\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Paul\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-email-generation/07-RESEARCH.md

# Prior work - email service and UI component exist from Phase 6
@server/services/emailService.ts
@client/src/components/rtw/ManagerEmailSection.tsx
@server/routes/rtwPlans.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add POST /email/send endpoint to backend</name>
  <files>
    server/routes/rtwPlans.ts
  </files>
  <action>
1. Import sendEmail from emailService:

```typescript
import { sendEmail } from "../services/emailService";
```

2. Add new endpoint after the existing /email/regenerate endpoint:

```typescript
/**
 * POST /api/rtw-plans/:planId/email/send
 * Send RTW plan notification email to manager (EMAIL-10)
 */
router.post("/:planId/email/send", async (req, res) => {
  try {
    const { planId } = req.params;
    const { recipientEmail, subject, body } = req.body;

    // Validate required fields
    if (!recipientEmail || !subject || !body) {
      return res.status(400).json({
        success: false,
        error: "Missing required fields: recipientEmail, subject, body",
      });
    }

    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(recipientEmail)) {
      return res.status(400).json({
        success: false,
        error: "Invalid email address format",
      });
    }

    // Get the plan to verify it exists
    const plan = await storage.getRTWPlanById(planId);
    if (!plan) {
      return res.status(404).json({
        success: false,
        error: "Plan not found",
      });
    }

    // Send the email
    const result = await sendEmail({
      to: recipientEmail,
      subject,
      body,
    });

    if (!result.success) {
      logger.api.error("Failed to send RTW plan email", {
        planId,
        recipientEmail,
        error: result.error,
      });
      return res.status(500).json({
        success: false,
        error: result.error || "Failed to send email",
      });
    }

    // Log to audit trail
    await storage.createAuditEvent({
      entityType: "rtw_plan",
      entityId: planId,
      action: "email_sent",
      userId: req.user?.id,
      dataJson: {
        recipientEmail,
        subject,
        messageId: result.messageId,
        sentAt: new Date().toISOString(),
      },
    });

    logger.api.info("RTW plan email sent successfully", {
      planId,
      recipientEmail,
      messageId: result.messageId,
    });

    return res.json({
      success: true,
      data: {
        messageId: result.messageId,
        recipientEmail,
      },
    });
  } catch (error) {
    logger.api.error("Error sending RTW plan email", { planId: req.params.planId }, error);
    return res.status(500).json({
      success: false,
      error: "Failed to send email",
    });
  }
});
```

3. Verify the route is properly registered.
  </action>
  <verify>
    npm run build passes
    grep -n "email/send" server/routes/rtwPlans.ts shows the new endpoint
    grep -n "sendEmail" server/routes/rtwPlans.ts shows the import
  </verify>
  <done>
    POST /email/send endpoint created
    Email validation implemented
    Audit logging for email sends
    Error handling with proper status codes
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Send Email button with confirmation dialog</name>
  <files>
    client/src/components/rtw/ManagerEmailSection.tsx
  </files>
  <action>
1. Add state for the send dialog:

```typescript
const [showSendDialog, setShowSendDialog] = useState(false);
const [recipientEmail, setRecipientEmail] = useState("");
```

2. Add send email mutation:

```typescript
// Send email mutation
const sendMutation = useMutation({
  mutationFn: async (data: { recipientEmail: string; subject: string; body: string }) => {
    const response = await fetch(`/api/rtw-plans/${planId}/email/send`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data),
    });
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || "Failed to send email");
    }
    return response.json();
  },
  onSuccess: (data) => {
    setShowSendDialog(false);
    setRecipientEmail("");
    toast({ title: `Email sent to ${data.data.recipientEmail}` });
  },
  onError: (error: Error) => {
    toast({ title: "Failed to send email", description: error.message, variant: "destructive" });
  },
});
```

3. Add the Send Email button next to Copy to Clipboard:

```typescript
<Button
  onClick={() => setShowSendDialog(true)}
  variant="default"
  size="sm"
  disabled={!subject || !body}
>
  <Mail className="h-4 w-4 mr-2" />
  Send Email
</Button>
```

4. Add the confirmation dialog (use AlertDialog from shadcn/ui):

```typescript
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";

// Add at the end of the component, before closing Card:
<AlertDialog open={showSendDialog} onOpenChange={setShowSendDialog}>
  <AlertDialogContent>
    <AlertDialogHeader>
      <AlertDialogTitle>Send Email to Manager</AlertDialogTitle>
      <AlertDialogDescription>
        This email contains medical information about the worker.
        Please verify the recipient email address before sending.
      </AlertDialogDescription>
    </AlertDialogHeader>
    <div className="py-4">
      <Label htmlFor="recipient-email">Manager Email Address</Label>
      <Input
        id="recipient-email"
        type="email"
        value={recipientEmail}
        onChange={(e) => setRecipientEmail(e.target.value)}
        placeholder="manager@company.com"
        className="mt-2"
      />
    </div>
    <AlertDialogFooter>
      <AlertDialogCancel>Cancel</AlertDialogCancel>
      <AlertDialogAction
        onClick={() => {
          sendMutation.mutate({
            recipientEmail,
            subject,
            body,
          });
        }}
        disabled={!recipientEmail || sendMutation.isPending}
      >
        {sendMutation.isPending ? (
          <>
            <Loader2 className="h-4 w-4 mr-2 animate-spin" />
            Sending...
          </>
        ) : (
          "Send Email"
        )}
      </AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```

5. Make sure AlertDialog component exists. If not, generate it:
   npx shadcn@latest add alert-dialog
  </action>
  <verify>
    npm run build passes
    grep -n "Send Email" client/src/components/rtw/ManagerEmailSection.tsx shows button
    grep -n "AlertDialog" client/src/components/rtw/ManagerEmailSection.tsx shows dialog
    grep -n "sendMutation" client/src/components/rtw/ManagerEmailSection.tsx shows mutation
  </verify>
  <done>
    Send Email button visible in UI
    Confirmation dialog prompts for email address
    Privacy warning displayed to user
    Loading state during send
    Success/error toast notifications
  </done>
</task>

</tasks>

<verification>
1. TypeScript builds without errors: `npm run build`
2. Send Email button appears in ManagerEmailSection
3. Clicking Send Email opens dialog with email input
4. Sending email shows loading state and success toast (or error)
5. In dev mode (no SMTP), email is logged instead of sent
</verification>

<success_criteria>
- Send Email button visible next to Copy to Clipboard
- Confirmation dialog requires recipient email address
- Privacy warning displayed before sending
- Email sent via SMTP (or logged in dev mode)
- Success/error feedback via toast
- Audit trail entry created for email sends
</success_criteria>

<output>
After completion, create `.planning/phases/07-email-generation/07-02-SUMMARY.md`
</output>
