---
phase: 05-plan-generator
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - client/src/hooks/usePlanDraft.ts
  - client/src/components/rtw/PlanGeneratorWizard.tsx
  - client/src/components/rtw/PlanTypeSelector.tsx
  - client/src/components/rtw/ScheduleEditor.tsx
  - client/src/components/rtw/DutySelector.tsx
  - client/src/components/rtw/PlanPreview.tsx
autonomous: true

must_haves:
  truths:
    - "User can step through wizard: Plan Type -> Schedule -> Duties -> Preview"
    - "Plan type shows auto-recommendation with manual override option"
    - "Schedule editor shows week-by-week with editable hours/days"
    - "Duty selector shows only suitable/with-modification duties pre-checked"
    - "Preview shows complete plan summary before saving"
    - "Draft persists across page refresh via sessionStorage"
  artifacts:
    - path: "client/src/hooks/usePlanDraft.ts"
      provides: "sessionStorage draft persistence hook"
      exports: ["usePlanDraft"]
    - path: "client/src/components/rtw/PlanGeneratorWizard.tsx"
      provides: "Multi-step wizard container with navigation"
      exports: ["PlanGeneratorWizard"]
    - path: "client/src/components/rtw/PlanTypeSelector.tsx"
      provides: "Plan type selection with recommendation display"
      exports: ["PlanTypeSelector"]
    - path: "client/src/components/rtw/ScheduleEditor.tsx"
      provides: "Week-by-week schedule editor with validation"
      exports: ["ScheduleEditor"]
    - path: "client/src/components/rtw/DutySelector.tsx"
      provides: "Duty selection with suitability indicators"
      exports: ["DutySelector"]
    - path: "client/src/components/rtw/PlanPreview.tsx"
      provides: "Plan preview with save action"
      exports: ["PlanPreview"]
  key_links:
    - from: "client/src/components/rtw/PlanGeneratorWizard.tsx"
      to: "/api/rtw-plans/recommend"
      via: "TanStack Query fetch"
      pattern: "rtw-plans/recommend"
    - from: "client/src/components/rtw/PlanGeneratorWizard.tsx"
      to: "/api/rtw-plans"
      via: "useMutation POST"
      pattern: "rtw-plans.*POST"
    - from: "client/src/hooks/usePlanDraft.ts"
      to: "sessionStorage"
      via: "setItem/getItem"
      pattern: "sessionStorage"
---

<objective>
Create multi-step RTW plan wizard UI implementing GEN-09 (preview) and GEN-10 (save draft).

Purpose: User-facing interface for generating RTW plans with step-by-step guidance, auto-populated recommendations, and draft persistence.

Output:
- usePlanDraft hook for sessionStorage persistence
- PlanGeneratorWizard orchestrating 4-step flow
- Individual step components: PlanTypeSelector, ScheduleEditor, DutySelector, PlanPreview
</objective>

<execution_context>
@C:\Users\Paul\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Paul\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-plan-generator/05-RESEARCH.md

# Existing UI patterns
@client/src/pages/admin/duties/DutyForm.tsx
@client/src/pages/admin/roles/RoleForm.tsx
@client/src/components/rtw/FunctionalAbilityMatrix.tsx

# UI components available
@client/src/components/ui/card.tsx
@client/src/components/ui/button.tsx
@client/src/components/ui/progress.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Draft Persistence Hook</name>
  <files>client/src/hooks/usePlanDraft.ts</files>
  <action>
Create sessionStorage-based draft persistence hook:

```typescript
/**
 * usePlanDraft Hook
 *
 * Persists RTW plan form data to sessionStorage for recovery after
 * accidental navigation or page refresh. Data cleared on successful save.
 *
 * sessionStorage vs localStorage:
 * - sessionStorage: Cleared when tab closes (prevents stale drafts)
 * - Perfect for in-progress form data
 * - Survives page refresh but not tab close
 */

import { useEffect, useState, useCallback } from "react";

export interface PlanDraftData {
  caseId: string;
  roleId: string;
  planType: "normal_hours" | "partial_hours" | "graduated_return";
  startDate: string;
  schedule: Array<{
    weekNumber: number;
    hoursPerDay: number;
    daysPerWeek: number;
  }>;
  selectedDutyIds: string[];
  lastSaved: string;
}

export function usePlanDraft(caseId: string) {
  const storageKey = `rtw-plan-draft-${caseId}`;
  const [draft, setDraft] = useState<PlanDraftData | null>(null);
  const [isLoaded, setIsLoaded] = useState(false);

  // Load draft on mount
  useEffect(() => {
    try {
      const stored = sessionStorage.getItem(storageKey);
      if (stored) {
        const parsed = JSON.parse(stored) as PlanDraftData;
        // Verify draft is for this case
        if (parsed.caseId === caseId) {
          setDraft(parsed);
        }
      }
    } catch (err) {
      console.error("Failed to parse draft:", err);
      sessionStorage.removeItem(storageKey);
    }
    setIsLoaded(true);
  }, [storageKey, caseId]);

  // Save draft
  const saveDraft = useCallback((data: Partial<PlanDraftData>) => {
    const updated: PlanDraftData = {
      caseId,
      roleId: data.roleId || draft?.roleId || "",
      planType: data.planType || draft?.planType || "graduated_return",
      startDate: data.startDate || draft?.startDate || new Date().toISOString(),
      schedule: data.schedule || draft?.schedule || [],
      selectedDutyIds: data.selectedDutyIds || draft?.selectedDutyIds || [],
      lastSaved: new Date().toISOString(),
    };

    sessionStorage.setItem(storageKey, JSON.stringify(updated));
    setDraft(updated);
  }, [storageKey, caseId, draft]);

  // Clear draft (after successful save)
  const clearDraft = useCallback(() => {
    sessionStorage.removeItem(storageKey);
    setDraft(null);
  }, [storageKey]);

  // Check if draft exists and is recent (< 24 hours)
  const hasDraft = draft !== null && isLoaded;
  const draftAge = draft?.lastSaved
    ? Date.now() - new Date(draft.lastSaved).getTime()
    : Infinity;
  const isRecentDraft = draftAge < 24 * 60 * 60 * 1000; // 24 hours

  return {
    draft,
    isLoaded,
    hasDraft,
    isRecentDraft,
    saveDraft,
    clearDraft,
  };
}
```

Export from hooks index if one exists, otherwise standalone export is fine.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit client/src/hooks/usePlanDraft.ts`</verify>
  <done>usePlanDraft hook exports draft persistence functions using sessionStorage</done>
</task>

<task type="auto">
  <name>Task 2: Create Plan Generator Wizard</name>
  <files>client/src/components/rtw/PlanGeneratorWizard.tsx</files>
  <action>
Create the main wizard container component:

```tsx
/**
 * PlanGeneratorWizard
 * GEN-09: Preview plan (Step 4)
 * GEN-10: Save as draft (final action)
 *
 * 4-step wizard:
 * 1. Plan Type - Auto-selected with override
 * 2. Schedule - Week-by-week hours
 * 3. Duties - Select suitable duties
 * 4. Preview - Review and save
 */

import { useState, useEffect } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Progress } from "@/components/ui/progress";
import { useToast } from "@/hooks/use-toast";
import { usePlanDraft, PlanDraftData } from "@/hooks/usePlanDraft";
import { PlanTypeSelector } from "./PlanTypeSelector";
import { ScheduleEditor } from "./ScheduleEditor";
import { DutySelector } from "./DutySelector";
import { PlanPreview } from "./PlanPreview";
import { AlertCircle, CheckCircle2 } from "lucide-react";

interface Props {
  caseId: string;
  roleId: string;
  onComplete: (planId: string) => void;
  onCancel: () => void;
}

interface RecommendationResponse {
  recommendation: {
    planType: string;
    reason: string;
    confidence: string;
    warnings: string[];
  };
  defaultSchedule: Array<{
    weekNumber: number;
    hoursPerDay: number;
    daysPerWeek: number;
    totalHoursPerWeek: number;
    startDate: string;
    endDate: string;
    notes?: string;
  }>;
  restrictionReviewDate: string | null;
  restrictions: {
    maxHoursPerDay: number | null;
    maxDaysPerWeek: number | null;
  };
  duties: Array<{
    dutyId: string;
    dutyName: string;
    suitability: string;
    isIncluded: boolean;
    modificationNotes: string | null;
    excludedReason: string | null;
  }>;
}

const STEPS = [
  { id: 1, name: "Plan Type", description: "Auto-selected based on restrictions" },
  { id: 2, name: "Schedule", description: "Week-by-week hours" },
  { id: 3, name: "Duties", description: "Select suitable duties" },
  { id: 4, name: "Preview", description: "Review and save" },
];

export function PlanGeneratorWizard({ caseId, roleId, onComplete, onCancel }: Props) {
  const [currentStep, setCurrentStep] = useState(1);
  const { toast } = useToast();
  const queryClient = useQueryClient();

  // Draft persistence
  const { draft, isLoaded, hasDraft, saveDraft, clearDraft } = usePlanDraft(caseId);

  // Form state
  const [planType, setPlanType] = useState<string>("graduated_return");
  const [startDate, setStartDate] = useState<string>(new Date().toISOString().split("T")[0]);
  const [schedule, setSchedule] = useState<Array<{
    weekNumber: number;
    hoursPerDay: number;
    daysPerWeek: number;
  }>>([]);
  const [selectedDutyIds, setSelectedDutyIds] = useState<string[]>([]);

  // Fetch recommendation
  const { data: recommendation, isLoading: isLoadingRecommendation } = useQuery<RecommendationResponse>({
    queryKey: ["rtw-plan-recommend", caseId, roleId],
    queryFn: async () => {
      const response = await fetch(
        `/api/rtw-plans/recommend?caseId=${encodeURIComponent(caseId)}&roleId=${encodeURIComponent(roleId)}`,
        { credentials: "include" }
      );
      if (!response.ok) throw new Error("Failed to load recommendation");
      const json = await response.json();
      return json.data;
    },
    enabled: !!caseId && !!roleId,
  });

  // Initialize from recommendation or draft
  useEffect(() => {
    if (!isLoaded) return;

    if (hasDraft && draft) {
      // Restore from draft
      setPlanType(draft.planType);
      setStartDate(draft.startDate.split("T")[0]);
      setSchedule(draft.schedule);
      setSelectedDutyIds(draft.selectedDutyIds);
      toast({
        title: "Draft Restored",
        description: "Your previous progress has been restored.",
      });
    } else if (recommendation) {
      // Initialize from recommendation
      setPlanType(recommendation.recommendation.planType);
      setSchedule(recommendation.defaultSchedule.map(s => ({
        weekNumber: s.weekNumber,
        hoursPerDay: s.hoursPerDay,
        daysPerWeek: s.daysPerWeek,
      })));
      setSelectedDutyIds(
        recommendation.duties
          .filter(d => d.isIncluded)
          .map(d => d.dutyId)
      );
    }
  }, [isLoaded, hasDraft, draft, recommendation, toast]);

  // Auto-save draft on changes
  useEffect(() => {
    if (isLoaded && (planType || schedule.length > 0 || selectedDutyIds.length > 0)) {
      saveDraft({
        caseId,
        roleId,
        planType: planType as PlanDraftData["planType"],
        startDate,
        schedule,
        selectedDutyIds,
      });
    }
  }, [planType, startDate, schedule, selectedDutyIds, isLoaded, saveDraft, caseId, roleId]);

  // Save mutation
  const saveMutation = useMutation({
    mutationFn: async () => {
      const response = await fetch("/api/rtw-plans", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({
          caseId,
          roleId,
          planType,
          startDate: new Date(startDate).toISOString(),
          schedule,
          selectedDutyIds,
        }),
      });
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || "Failed to save plan");
      }
      return response.json();
    },
    onSuccess: (data) => {
      clearDraft();
      queryClient.invalidateQueries({ queryKey: ["rtw-plans", caseId] });
      toast({
        title: "Plan Saved",
        description: "RTW plan created as draft.",
      });
      onComplete(data.planId);
    },
    onError: (error: Error) => {
      toast({
        title: "Save Failed",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  const handleNext = () => {
    if (currentStep < STEPS.length) {
      setCurrentStep(currentStep + 1);
    }
  };

  const handleBack = () => {
    if (currentStep > 1) {
      setCurrentStep(currentStep - 1);
    }
  };

  const handleSave = () => {
    saveMutation.mutate();
  };

  const progress = (currentStep / STEPS.length) * 100;

  if (isLoadingRecommendation || !isLoaded) {
    return (
      <Card>
        <CardContent className="py-8">
          <div className="text-center text-muted-foreground">
            Loading plan recommendations...
          </div>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-6">
      {/* Progress */}
      <Card>
        <CardHeader>
          <CardTitle>Generate RTW Plan</CardTitle>
          <div className="space-y-2">
            <Progress value={progress} />
            <div className="flex justify-between text-sm text-muted-foreground">
              {STEPS.map((step) => (
                <div
                  key={step.id}
                  className={step.id === currentStep ? "font-medium text-foreground" : ""}
                >
                  {step.name}
                </div>
              ))}
            </div>
          </div>
        </CardHeader>
      </Card>

      {/* Step Content */}
      <Card>
        <CardContent className="pt-6">
          {currentStep === 1 && recommendation && (
            <PlanTypeSelector
              recommendation={recommendation.recommendation}
              selectedType={planType}
              onTypeChange={setPlanType}
              restrictions={recommendation.restrictions}
            />
          )}
          {currentStep === 2 && recommendation && (
            <ScheduleEditor
              schedule={schedule}
              onScheduleChange={setSchedule}
              startDate={startDate}
              onStartDateChange={setStartDate}
              restrictions={recommendation.restrictions}
              restrictionReviewDate={recommendation.restrictionReviewDate}
            />
          )}
          {currentStep === 3 && recommendation && (
            <DutySelector
              duties={recommendation.duties}
              selectedIds={selectedDutyIds}
              onSelectionChange={setSelectedDutyIds}
            />
          )}
          {currentStep === 4 && recommendation && (
            <PlanPreview
              planType={planType}
              startDate={startDate}
              schedule={schedule}
              selectedDuties={recommendation.duties.filter(d =>
                selectedDutyIds.includes(d.dutyId)
              )}
              excludedDuties={recommendation.duties.filter(d =>
                !d.isIncluded
              )}
            />
          )}
        </CardContent>
      </Card>

      {/* Navigation */}
      <div className="flex justify-between">
        <div className="space-x-2">
          <Button variant="outline" onClick={onCancel}>
            Cancel
          </Button>
          {currentStep > 1 && (
            <Button variant="outline" onClick={handleBack}>
              Back
            </Button>
          )}
        </div>
        <div className="space-x-2">
          {currentStep < STEPS.length ? (
            <Button onClick={handleNext}>
              Next
            </Button>
          ) : (
            <Button
              onClick={handleSave}
              disabled={saveMutation.isPending || selectedDutyIds.length === 0}
            >
              {saveMutation.isPending ? "Saving..." : "Save as Draft"}
            </Button>
          )}
        </div>
      </div>
    </div>
  );
}
```

Key features:
- 4-step wizard with progress indicator
- Auto-loads recommendation from API
- Restores from sessionStorage draft if exists
- Auto-saves to draft on every change
- Clears draft on successful save
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit client/src/components/rtw/PlanGeneratorWizard.tsx`</verify>
  <done>PlanGeneratorWizard renders 4-step flow with draft persistence and API integration</done>
</task>

<task type="auto">
  <name>Task 3: Create Step Components</name>
  <files>
    client/src/components/rtw/PlanTypeSelector.tsx
    client/src/components/rtw/ScheduleEditor.tsx
    client/src/components/rtw/DutySelector.tsx
    client/src/components/rtw/PlanPreview.tsx
  </files>
  <action>
Create the four step components:

**PlanTypeSelector.tsx:**
```tsx
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { AlertCircle, CheckCircle2, Clock } from "lucide-react";

interface Props {
  recommendation: {
    planType: string;
    reason: string;
    confidence: string;
    warnings: string[];
  };
  selectedType: string;
  onTypeChange: (type: string) => void;
  restrictions: {
    maxHoursPerDay: number | null;
    maxDaysPerWeek: number | null;
  };
}

const PLAN_TYPES = [
  {
    value: "normal_hours",
    label: "Normal Hours",
    description: "Full 8 hours/day, 5 days/week from start",
    icon: CheckCircle2,
  },
  {
    value: "partial_hours",
    label: "Partial Hours",
    description: "Reduced but consistent hours throughout",
    icon: Clock,
  },
  {
    value: "graduated_return",
    label: "Graduated Return",
    description: "Progressive increase: 4 -> 6 -> 8 hours/day",
    icon: Clock,
  },
];

export function PlanTypeSelector({ recommendation, selectedType, onTypeChange, restrictions }: Props) {
  const isRecommended = (type: string) => type === recommendation.planType;

  return (
    <div className="space-y-6">
      {/* Recommendation banner */}
      <Card className="border-blue-200 bg-blue-50">
        <CardContent className="pt-4">
          <div className="flex items-start gap-3">
            <CheckCircle2 className="h-5 w-5 text-blue-600 mt-0.5" />
            <div>
              <p className="font-medium text-blue-900">
                Recommended: {PLAN_TYPES.find(t => t.value === recommendation.planType)?.label}
              </p>
              <p className="text-sm text-blue-700 mt-1">{recommendation.reason}</p>
              {recommendation.warnings.length > 0 && (
                <div className="mt-2 space-y-1">
                  {recommendation.warnings.map((w, i) => (
                    <p key={i} className="text-sm text-amber-700 flex items-center gap-1">
                      <AlertCircle className="h-3 w-3" /> {w}
                    </p>
                  ))}
                </div>
              )}
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Current restrictions */}
      {(restrictions.maxHoursPerDay || restrictions.maxDaysPerWeek) && (
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm">Current Medical Restrictions</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex gap-4 text-sm">
              {restrictions.maxHoursPerDay && (
                <span>Max {restrictions.maxHoursPerDay} hours/day</span>
              )}
              {restrictions.maxDaysPerWeek && (
                <span>Max {restrictions.maxDaysPerWeek} days/week</span>
              )}
            </div>
          </CardContent>
        </Card>
      )}

      {/* Plan type selection */}
      <RadioGroup value={selectedType} onValueChange={onTypeChange}>
        <div className="grid gap-4">
          {PLAN_TYPES.map((type) => {
            const Icon = type.icon;
            return (
              <Label
                key={type.value}
                htmlFor={type.value}
                className={`flex items-start gap-4 p-4 border rounded-lg cursor-pointer hover:bg-accent ${
                  selectedType === type.value ? "border-primary bg-accent" : ""
                }`}
              >
                <RadioGroupItem value={type.value} id={type.value} />
                <div className="flex-1">
                  <div className="flex items-center gap-2">
                    <Icon className="h-4 w-4" />
                    <span className="font-medium">{type.label}</span>
                    {isRecommended(type.value) && (
                      <Badge variant="secondary">Recommended</Badge>
                    )}
                  </div>
                  <p className="text-sm text-muted-foreground mt-1">
                    {type.description}
                  </p>
                </div>
              </Label>
            );
          })}
        </div>
      </RadioGroup>
    </div>
  );
}
```

**ScheduleEditor.tsx:**
```tsx
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Button } from "@/components/ui/button";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Plus, Trash2, AlertCircle } from "lucide-react";
import { format, addWeeks, parseISO } from "date-fns";

interface WeekSchedule {
  weekNumber: number;
  hoursPerDay: number;
  daysPerWeek: number;
}

interface Props {
  schedule: WeekSchedule[];
  onScheduleChange: (schedule: WeekSchedule[]) => void;
  startDate: string;
  onStartDateChange: (date: string) => void;
  restrictions: {
    maxHoursPerDay: number | null;
    maxDaysPerWeek: number | null;
  };
  restrictionReviewDate: string | null;
}

export function ScheduleEditor({
  schedule,
  onScheduleChange,
  startDate,
  onStartDateChange,
  restrictions,
  restrictionReviewDate,
}: Props) {
  const updateWeek = (weekNumber: number, field: "hoursPerDay" | "daysPerWeek", value: number) => {
    onScheduleChange(
      schedule.map((w) =>
        w.weekNumber === weekNumber ? { ...w, [field]: value } : w
      )
    );
  };

  const addWeekRow = () => {
    const nextWeek = schedule.length + 1;
    const lastWeek = schedule[schedule.length - 1];
    onScheduleChange([
      ...schedule,
      {
        weekNumber: nextWeek,
        hoursPerDay: lastWeek?.hoursPerDay || 4,
        daysPerWeek: lastWeek?.daysPerWeek || 3,
      },
    ]);
  };

  const removeWeek = (weekNumber: number) => {
    onScheduleChange(
      schedule
        .filter((w) => w.weekNumber !== weekNumber)
        .map((w, i) => ({ ...w, weekNumber: i + 1 }))
    );
  };

  const getWeekDates = (weekNum: number) => {
    const start = addWeeks(parseISO(startDate), weekNum - 1);
    const end = addWeeks(start, 1);
    return `${format(start, "MMM d")} - ${format(end, "MMM d")}`;
  };

  const exceedsRestrictions = (week: WeekSchedule) => {
    if (restrictions.maxHoursPerDay && week.hoursPerDay > restrictions.maxHoursPerDay) {
      return true;
    }
    if (restrictions.maxDaysPerWeek && week.daysPerWeek > restrictions.maxDaysPerWeek) {
      return true;
    }
    return false;
  };

  return (
    <div className="space-y-6">
      {/* Start date */}
      <div className="grid gap-2">
        <Label htmlFor="startDate">Plan Start Date</Label>
        <Input
          id="startDate"
          type="date"
          value={startDate}
          onChange={(e) => onStartDateChange(e.target.value)}
          className="w-48"
        />
      </div>

      {/* Restriction review warning */}
      {restrictionReviewDate && (
        <Card className="border-amber-200 bg-amber-50">
          <CardContent className="pt-4 flex items-center gap-2">
            <AlertCircle className="h-4 w-4 text-amber-600" />
            <span className="text-sm text-amber-800">
              Medical restrictions review date: {format(parseISO(restrictionReviewDate), "MMM d, yyyy")}
              . Plan should not extend beyond this date.
            </span>
          </CardContent>
        </Card>
      )}

      {/* Schedule table */}
      <Card>
        <CardHeader>
          <CardTitle className="text-base">Week-by-Week Schedule</CardTitle>
        </CardHeader>
        <CardContent>
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead className="w-24">Week</TableHead>
                <TableHead>Dates</TableHead>
                <TableHead className="w-32">Hours/Day</TableHead>
                <TableHead className="w-32">Days/Week</TableHead>
                <TableHead className="w-24">Total</TableHead>
                <TableHead className="w-12"></TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {schedule.map((week) => (
                <TableRow
                  key={week.weekNumber}
                  className={exceedsRestrictions(week) ? "bg-red-50" : ""}
                >
                  <TableCell className="font-medium">Week {week.weekNumber}</TableCell>
                  <TableCell className="text-muted-foreground text-sm">
                    {getWeekDates(week.weekNumber)}
                  </TableCell>
                  <TableCell>
                    <Input
                      type="number"
                      min={1}
                      max={12}
                      value={week.hoursPerDay}
                      onChange={(e) =>
                        updateWeek(week.weekNumber, "hoursPerDay", parseInt(e.target.value) || 1)
                      }
                      className="w-20"
                    />
                  </TableCell>
                  <TableCell>
                    <Input
                      type="number"
                      min={1}
                      max={7}
                      value={week.daysPerWeek}
                      onChange={(e) =>
                        updateWeek(week.weekNumber, "daysPerWeek", parseInt(e.target.value) || 1)
                      }
                      className="w-20"
                    />
                  </TableCell>
                  <TableCell className="font-medium">
                    {week.hoursPerDay * week.daysPerWeek} hrs
                  </TableCell>
                  <TableCell>
                    {schedule.length > 1 && (
                      <Button
                        variant="ghost"
                        size="icon"
                        onClick={() => removeWeek(week.weekNumber)}
                      >
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    )}
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
          <Button variant="outline" className="mt-4" onClick={addWeekRow}>
            <Plus className="h-4 w-4 mr-2" /> Add Week
          </Button>
        </CardContent>
      </Card>
    </div>
  );
}
```

**DutySelector.tsx:**
```tsx
import { Card, CardContent } from "@/components/ui/card";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { getSuitabilityColor, getSuitabilityBgColor, formatSuitability } from "@/lib/suitabilityUtils";
import { CheckCircle2, AlertTriangle, XCircle } from "lucide-react";

interface Duty {
  dutyId: string;
  dutyName: string;
  suitability: string;
  isIncluded: boolean;
  modificationNotes: string | null;
  excludedReason: string | null;
}

interface Props {
  duties: Duty[];
  selectedIds: string[];
  onSelectionChange: (ids: string[]) => void;
}

const SUITABILITY_ICONS = {
  suitable: CheckCircle2,
  suitable_with_modification: AlertTriangle,
  not_suitable: XCircle,
};

export function DutySelector({ duties, selectedIds, onSelectionChange }: Props) {
  const includableDuties = duties.filter((d) => d.suitability !== "not_suitable");
  const excludedDuties = duties.filter((d) => d.suitability === "not_suitable");

  const toggleDuty = (dutyId: string) => {
    if (selectedIds.includes(dutyId)) {
      onSelectionChange(selectedIds.filter((id) => id !== dutyId));
    } else {
      onSelectionChange([...selectedIds, dutyId]);
    }
  };

  const selectAll = () => {
    onSelectionChange(includableDuties.map((d) => d.dutyId));
  };

  const selectNone = () => {
    onSelectionChange([]);
  };

  return (
    <div className="space-y-6">
      {/* Selection actions */}
      <div className="flex gap-2">
        <button
          type="button"
          onClick={selectAll}
          className="text-sm text-blue-600 hover:underline"
        >
          Select all suitable
        </button>
        <span className="text-muted-foreground">|</span>
        <button
          type="button"
          onClick={selectNone}
          className="text-sm text-blue-600 hover:underline"
        >
          Clear selection
        </button>
      </div>

      {/* Includable duties */}
      <div className="space-y-2">
        <h3 className="font-medium">Available Duties ({includableDuties.length})</h3>
        <div className="grid gap-2">
          {includableDuties.map((duty) => {
            const Icon = SUITABILITY_ICONS[duty.suitability as keyof typeof SUITABILITY_ICONS] || CheckCircle2;
            const colorClass = getSuitabilityColor(duty.suitability);

            return (
              <Label
                key={duty.dutyId}
                htmlFor={duty.dutyId}
                className={`flex items-start gap-3 p-3 border rounded-lg cursor-pointer hover:bg-accent ${
                  selectedIds.includes(duty.dutyId) ? "border-primary bg-accent" : ""
                }`}
              >
                <Checkbox
                  id={duty.dutyId}
                  checked={selectedIds.includes(duty.dutyId)}
                  onCheckedChange={() => toggleDuty(duty.dutyId)}
                />
                <div className="flex-1">
                  <div className="flex items-center gap-2">
                    <Icon className={`h-4 w-4 ${colorClass}`} />
                    <span className="font-medium">{duty.dutyName}</span>
                    <Badge variant="outline" className={getSuitabilityBgColor(duty.suitability)}>
                      {formatSuitability(duty.suitability)}
                    </Badge>
                  </div>
                  {duty.modificationNotes && (
                    <p className="text-sm text-muted-foreground mt-1">
                      {duty.modificationNotes}
                    </p>
                  )}
                </div>
              </Label>
            );
          })}
        </div>
      </div>

      {/* Excluded duties */}
      {excludedDuties.length > 0 && (
        <div className="space-y-2">
          <h3 className="font-medium text-muted-foreground">
            Excluded Duties ({excludedDuties.length})
          </h3>
          <Card className="bg-muted/50">
            <CardContent className="pt-4">
              <div className="space-y-2">
                {excludedDuties.map((duty) => (
                  <div key={duty.dutyId} className="flex items-start gap-2 text-sm">
                    <XCircle className="h-4 w-4 text-red-500 mt-0.5" />
                    <div>
                      <span className="font-medium">{duty.dutyName}</span>
                      {duty.excludedReason && (
                        <p className="text-muted-foreground">{duty.excludedReason}</p>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </div>
      )}
    </div>
  );
}
```

**PlanPreview.tsx:**
```tsx
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { CalendarDays, Clock, Briefcase, AlertCircle, CheckCircle2 } from "lucide-react";

interface Props {
  planType: string;
  startDate: string;
  schedule: Array<{
    weekNumber: number;
    hoursPerDay: number;
    daysPerWeek: number;
  }>;
  selectedDuties: Array<{
    dutyId: string;
    dutyName: string;
    suitability: string;
    modificationNotes: string | null;
  }>;
  excludedDuties: Array<{
    dutyId: string;
    dutyName: string;
    excludedReason: string | null;
  }>;
}

const PLAN_TYPE_LABELS: Record<string, string> = {
  normal_hours: "Normal Hours",
  partial_hours: "Partial Hours",
  graduated_return: "Graduated Return",
};

export function PlanPreview({ planType, startDate, schedule, selectedDuties, excludedDuties }: Props) {
  const totalWeeks = schedule.length;
  const maxHours = Math.max(...schedule.map((w) => w.hoursPerDay));
  const totalDuties = selectedDuties.length;

  return (
    <div className="space-y-6">
      {/* Summary cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              Plan Type
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-2">
              <CalendarDays className="h-4 w-4 text-muted-foreground" />
              <span className="text-lg font-semibold">
                {PLAN_TYPE_LABELS[planType] || planType}
              </span>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              Duration
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-2">
              <Clock className="h-4 w-4 text-muted-foreground" />
              <span className="text-lg font-semibold">
                {totalWeeks} weeks (up to {maxHours} hrs/day)
              </span>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              Duties Included
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-2">
              <Briefcase className="h-4 w-4 text-muted-foreground" />
              <span className="text-lg font-semibold">{totalDuties} duties</span>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Schedule preview */}
      <Card>
        <CardHeader>
          <CardTitle className="text-base">Week-by-Week Schedule</CardTitle>
        </CardHeader>
        <CardContent>
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Week</TableHead>
                <TableHead>Hours/Day</TableHead>
                <TableHead>Days/Week</TableHead>
                <TableHead>Total Hours</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {schedule.map((week) => (
                <TableRow key={week.weekNumber}>
                  <TableCell className="font-medium">Week {week.weekNumber}</TableCell>
                  <TableCell>{week.hoursPerDay}</TableCell>
                  <TableCell>{week.daysPerWeek}</TableCell>
                  <TableCell className="font-medium">
                    {week.hoursPerDay * week.daysPerWeek} hours
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </CardContent>
      </Card>

      {/* Duties preview */}
      <Card>
        <CardHeader>
          <CardTitle className="text-base">Included Duties</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-2">
            {selectedDuties.map((duty) => (
              <div key={duty.dutyId} className="flex items-start gap-2">
                <CheckCircle2 className="h-4 w-4 text-green-600 mt-0.5" />
                <div>
                  <span className="font-medium">{duty.dutyName}</span>
                  {duty.suitability === "suitable_with_modification" && (
                    <Badge variant="outline" className="ml-2 text-xs">
                      With modification
                    </Badge>
                  )}
                  {duty.modificationNotes && (
                    <p className="text-sm text-muted-foreground">{duty.modificationNotes}</p>
                  )}
                </div>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>

      {/* Excluded duties (GEN-06) */}
      {excludedDuties.length > 0 && (
        <Card className="border-amber-200">
          <CardHeader>
            <CardTitle className="text-base text-amber-800">
              Excluded Duties ({excludedDuties.length})
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-2">
              {excludedDuties.map((duty) => (
                <div key={duty.dutyId} className="flex items-start gap-2">
                  <AlertCircle className="h-4 w-4 text-amber-600 mt-0.5" />
                  <div>
                    <span className="font-medium">{duty.dutyName}</span>
                    {duty.excludedReason && (
                      <p className="text-sm text-muted-foreground">{duty.excludedReason}</p>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      )}

      {/* Save reminder */}
      <Card className="border-blue-200 bg-blue-50">
        <CardContent className="pt-4">
          <div className="flex items-start gap-3">
            <CheckCircle2 className="h-5 w-5 text-blue-600 mt-0.5" />
            <div>
              <p className="font-medium text-blue-900">Ready to Save</p>
              <ul className="text-sm text-blue-800 mt-2 space-y-1">
                <li>Plan will be saved as draft</li>
                <li>Can be edited before submission</li>
                <li>Manager approval required to activate</li>
              </ul>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
```
  </action>
  <verify>TypeScript compiles: `npm run build` (client build includes all components)</verify>
  <done>All four step components created with proper typing and UI patterns</done>
</task>

</tasks>

<verification>
1. TypeScript: `npm run build` completes without errors (both client and server)
2. Components render: Manual test - navigate to wizard, steps display correctly
3. Draft persistence: Refresh page, draft is restored
4. API integration: Wizard loads recommendations from API
</verification>

<success_criteria>
- [ ] usePlanDraft hook persists/restores form state via sessionStorage
- [ ] PlanGeneratorWizard orchestrates 4-step flow with navigation
- [ ] PlanTypeSelector shows recommendation with override option
- [ ] ScheduleEditor allows editing week-by-week schedule
- [ ] DutySelector shows suitable duties with checkboxes, excluded with reason
- [ ] PlanPreview shows complete summary with save button
- [ ] Draft auto-saves on every change, clears on successful save
</success_criteria>

<output>
After completion, create `.planning/phases/05-plan-generator/05-03-SUMMARY.md`
</output>
