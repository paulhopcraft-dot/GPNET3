---
phase: 05-plan-generator
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Full wizard flow works end-to-end: load case -> generate plan -> save"
    - "Plan type auto-selects correctly based on restrictions"
    - "Schedule respects restriction review date"
    - "Only suitable/modified duties selectable"
    - "Saved plan persists to database with correct status"
---

<objective>
End-to-end verification of Phase 5 Plan Generator implementation.

Purpose: Confirm all GEN-01 to GEN-10 requirements work together in a real scenario.

Output: Verification that plan generation works correctly before moving to Phase 6.
</objective>

<execution_context>
@C:\Users\Paul\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Paul\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-plan-generator/05-RESEARCH.md

# Prior plan summaries
# Reference 05-01, 05-02, 05-03 SUMMARY.md files after execution
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run All Unit Tests</name>
  <files></files>
  <action>
Run the complete test suite to verify all plan generator services work correctly:

```bash
# Run plan generator unit tests
npm test -- --run server/services/planGenerator.test.ts

# Run full test suite to ensure no regressions
npm test -- --run
```

Verify:
- All plan generator tests pass
- No regressions in other tests
- Coverage includes GEN-01 through GEN-08
  </action>
  <verify>`npm test -- --run server/services/planGenerator.test.ts` shows all tests passing</verify>
  <done>All unit tests pass, no regressions</done>
</task>

<task type="auto">
  <name>Task 2: Verify API Endpoints</name>
  <files></files>
  <action>
Test API endpoints with curl or similar:

1. Start the server: `npm run dev`

2. Get auth token by logging in (use existing admin account)

3. Test recommend endpoint:
```bash
# Replace with actual caseId and roleId from database
curl -X GET "http://localhost:5000/api/rtw-plans/recommend?caseId=CASE_ID&roleId=ROLE_ID" \
  -H "Cookie: token=YOUR_JWT"
```

Expected response:
- 200 status
- recommendation object with planType, reason, confidence
- defaultSchedule array with week objects
- duties array with suitability info

4. Test create endpoint:
```bash
curl -X POST "http://localhost:5000/api/rtw-plans" \
  -H "Content-Type: application/json" \
  -H "Cookie: token=YOUR_JWT" \
  -d '{
    "caseId": "CASE_ID",
    "roleId": "ROLE_ID",
    "planType": "graduated_return",
    "startDate": "2026-02-01T00:00:00.000Z",
    "schedule": [
      {"weekNumber": 1, "hoursPerDay": 4, "daysPerWeek": 3},
      {"weekNumber": 2, "hoursPerDay": 4, "daysPerWeek": 5},
      {"weekNumber": 3, "hoursPerDay": 6, "daysPerWeek": 5},
      {"weekNumber": 4, "hoursPerDay": 8, "daysPerWeek": 5}
    ],
    "selectedDutyIds": ["DUTY_ID_1", "DUTY_ID_2"]
  }'
```

Expected response:
- 201 status
- planId and versionId returned
- Plan saved with status "draft"

5. Verify plan in database:
```sql
SELECT * FROM rtw_plans WHERE id = 'PLAN_ID';
SELECT * FROM rtw_plan_versions WHERE plan_id = 'PLAN_ID';
SELECT * FROM rtw_plan_schedule WHERE plan_version_id = 'VERSION_ID';
SELECT * FROM rtw_plan_duties WHERE plan_version_id = 'VERSION_ID';
```
  </action>
  <verify>API returns expected responses, plan persists to all related tables</verify>
  <done>API endpoints work correctly, plan saved to database</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete RTW Plan Generator (Phase 5) implementing GEN-01 to GEN-10:

**Backend:**
- planGenerator.ts: Auto-selects plan type based on restrictions and duty suitability
- scheduleCalculator.ts: Generates graduated schedules (4->6->8 hours) with validation
- rtwPlans.ts router: /recommend and create endpoints with full validation
- Storage methods: createRTWPlan with transaction, getRoleDutiesWithDemands

**Frontend:**
- PlanGeneratorWizard: 4-step wizard with progress indicator
- PlanTypeSelector: Shows recommendation, allows override
- ScheduleEditor: Week-by-week editor with restriction warnings
- DutySelector: Checkboxes for suitable duties, shows excluded
- PlanPreview: Summary view with save action
- usePlanDraft: sessionStorage persistence
  </what-built>
  <how-to-verify>
1. **Start the application:**
   ```bash
   npm run dev
   ```

2. **Login as admin user** in the Employer Portal

3. **Navigate to a case that has:**
   - Medical certificate with restrictions (from Phase 3)
   - Role with duties defined (from Phase 2)

4. **Open RTW Planner and start plan wizard:**
   - Should load recommendation from API
   - Check: Plan type recommendation displays with reason

5. **Step through wizard:**
   - **Step 1 - Plan Type:**
     - [ ] Shows recommended type with explanation
     - [ ] Can select different type (override)
     - [ ] Shows current restrictions

   - **Step 2 - Schedule:**
     - [ ] Default schedule shows 4->6->8 progression
     - [ ] Can edit hours/days per week
     - [ ] Shows total hours per week
     - [ ] Warning if schedule exceeds review date

   - **Step 3 - Duties:**
     - [ ] Suitable duties pre-checked
     - [ ] With-modification duties show notes
     - [ ] Not-suitable duties shown as excluded (can't select)
     - [ ] Select all / clear selection works

   - **Step 4 - Preview:**
     - [ ] Shows plan type, duration, duty count
     - [ ] Shows week-by-week schedule table
     - [ ] Shows included duties with modifications
     - [ ] Shows excluded duties with reasons

6. **Test draft persistence:**
   - Make changes in wizard
   - Refresh page
   - [ ] Form state restored from sessionStorage

7. **Save plan:**
   - Click "Save as Draft"
   - [ ] Success toast appears
   - [ ] Plan created in database with status "draft"

8. **Verify in database:**
   ```sql
   SELECT * FROM rtw_plans ORDER BY created_at DESC LIMIT 1;
   ```
   - [ ] Plan exists with correct case_id, role_id, plan_type
   - [ ] Status is "draft"
   - [ ] Version 1 created

**Edge cases to test:**
- [ ] Worker with no restrictions -> recommends normal_hours
- [ ] Worker with hour cap only -> recommends partial_hours
- [ ] Worker with multiple unsuitable duties -> recommends graduated_return
- [ ] Restriction review date in 2 weeks -> schedule truncates
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Checkpoint verification by human tester.
</verification>

<success_criteria>
- [ ] All unit tests pass
- [ ] API endpoints return expected data
- [ ] Wizard flow works end-to-end
- [ ] Plan saves correctly as draft
- [ ] Draft persistence works
- [ ] Edge cases handled appropriately
</success_criteria>

<output>
After verification approved, create `.planning/phases/05-plan-generator/05-04-SUMMARY.md` with:
- Verification status
- Any issues found and fixed
- Confirmation Phase 5 is complete
</output>
