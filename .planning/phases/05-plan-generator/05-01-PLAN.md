---
phase: 05-plan-generator
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/services/planGenerator.ts
  - server/services/scheduleCalculator.ts
  - server/services/planGenerator.test.ts
autonomous: true

must_haves:
  truths:
    - "Plan type correctly auto-selected based on restrictions and duty suitability"
    - "Graduated schedule generates 4->6->8 hour progression"
    - "Schedule truncates when restriction review date is near"
    - "Only suitable/with-modification duties included in plans"
    - "Not-suitable duties excluded with documented reason"
  artifacts:
    - path: "server/services/planGenerator.ts"
      provides: "recommendPlanType, filterDutiesForPlan, generatePlanDuties functions"
      exports: ["recommendPlanType", "filterDutiesForPlan", "generatePlanDuties", "PlanType", "PlanTypeRecommendation", "DutyForPlan"]
    - path: "server/services/scheduleCalculator.ts"
      provides: "generateDefaultSchedule, validateCustomSchedule, calculateWeeklyHours functions"
      exports: ["generateDefaultSchedule", "validateCustomSchedule", "calculateWeeklyHours", "WeekSchedule", "ScheduleConfig"]
    - path: "server/services/planGenerator.test.ts"
      provides: "Unit tests for plan generation services"
      min_lines: 200
  key_links:
    - from: "server/services/planGenerator.ts"
      to: "server/services/functionalAbilityCalculator.ts"
      via: "imports SuitabilityLevel type"
      pattern: "from.*functionalAbilityCalculator"
    - from: "server/services/scheduleCalculator.ts"
      to: "date-fns"
      via: "date arithmetic"
      pattern: "from.*date-fns"
---

<objective>
Create core plan generation services implementing GEN-01 to GEN-08.

Purpose: Backend logic for auto-selecting plan types, generating graduated schedules, and filtering duties based on suitability matrix results from Phase 4.

Output:
- planGenerator.ts: Plan type recommendation and duty filtering
- scheduleCalculator.ts: Graduated schedule generation with validation
- Unit tests covering all requirements
</objective>

<execution_context>
@C:\Users\Paul\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Paul\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-plan-generator/05-RESEARCH.md

# Phase 4 outputs (suitability calculation)
@server/services/functionalAbilityCalculator.ts
@server/services/modificationSuggester.ts

# Phase 3 outputs (restrictions)
@server/services/restrictionMapper.ts

# Schema (RTW plan tables)
@shared/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Plan Generator Service</name>
  <files>server/services/planGenerator.ts</files>
  <action>
Create plan generator service implementing GEN-01, GEN-05, GEN-06:

```typescript
/**
 * Plan Generator Service
 * GEN-01: Auto-select plan type based on restrictions and duty suitability
 * GEN-05: Include only suitable and suitable_with_modification duties
 * GEN-06: Exclude not_suitable duties with documented reason
 */

import type { FunctionalRestrictions, RTWDutyDB } from "@shared/schema";
import type { SuitabilityLevel } from "./functionalAbilityCalculator";

// Types
export type PlanType = "normal_hours" | "partial_hours" | "graduated_return";

export interface PlanTypeRecommendation {
  planType: PlanType;
  reason: string;
  confidence: "high" | "medium" | "low";
  warnings: string[];
}

export interface DutySuitabilityInput {
  duty: RTWDutyDB;
  suitability: SuitabilityLevel;
  modificationSuggestions?: string[];
}

export interface DutyForPlan {
  dutyId: string;
  dutyName: string;
  suitability: SuitabilityLevel;
  modificationNotes: string | null;
  excludedReason: string | null;
  isIncluded: boolean;
}

// Functions to implement:

/**
 * GEN-01: Auto-select RTW plan type
 *
 * Decision logic:
 * - normal_hours: No hour restrictions AND >= 80% duties suitable
 * - partial_hours: Hour restrictions but >= 80% duties suitable
 * - graduated_return: Hour restrictions AND/OR < 80% duties suitable
 */
export function recommendPlanType(
  restrictions: FunctionalRestrictions,
  dutySuitability: DutySuitabilityInput[]
): PlanTypeRecommendation;

/**
 * GEN-05, GEN-06: Filter duties for plan inclusion
 *
 * Rules:
 * - suitable: include without modification notes
 * - suitable_with_modification: include with modification notes
 * - not_suitable: exclude with documented reason
 */
export function filterDutiesForPlan(
  dutySuitability: DutySuitabilityInput[],
  includeModifications?: boolean
): DutyForPlan[];

/**
 * Generate plan duty records for database insertion
 */
export function generatePlanDuties(
  planVersionId: string,
  filteredDuties: DutyForPlan[]
): InsertRTWPlanDuty[];
```

Implementation details:
- Check maxWorkHoursPerDay and maxWorkDaysPerWeek for hour restrictions
- Calculate suitable percentage: (suitable + suitable_with_modification) / total
- Use 80% threshold for "duties OK" determination
- Default to graduated_return for safety when uncertain
- Include confidence level based on data completeness
- Generate warnings for edge cases (no suitable duties, missing restrictions)
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit server/services/planGenerator.ts`</verify>
  <done>planGenerator.ts exports recommendPlanType, filterDutiesForPlan, generatePlanDuties with correct types</done>
</task>

<task type="auto">
  <name>Task 2: Create Schedule Calculator Service</name>
  <files>server/services/scheduleCalculator.ts</files>
  <action>
Create schedule calculator service implementing GEN-02, GEN-03, GEN-04, GEN-07, GEN-08:

```typescript
/**
 * Schedule Calculator Service
 * GEN-02: Generate week-by-week schedule for graduated plans
 * GEN-03: Default graduation 4hrs -> 6hrs -> 8hrs over 3 weeks
 * GEN-04: Allow custom graduation schedule
 * GEN-07: Calculate total hours per week
 * GEN-08: Respect restriction review dates
 */

import { addWeeks, differenceInWeeks, isAfter, isBefore } from "date-fns";
import type { FunctionalRestrictions } from "@shared/schema";

// Types
export interface WeekSchedule {
  weekNumber: number;
  hoursPerDay: number;
  daysPerWeek: number;
  totalHoursPerWeek: number;
  startDate: Date;
  endDate: Date;
  notes?: string;
}

export interface ScheduleConfig {
  startDate: Date;
  restrictionReviewDate: Date | null;
  maxHoursPerDay: number | null;
  maxDaysPerWeek: number | null;
  targetHours?: number; // Goal hours/day (default 8)
  targetDays?: number;  // Goal days/week (default 5)
}

export interface ScheduleValidation {
  valid: boolean;
  errors: string[];
  warnings: string[];
}

// Functions to implement:

/**
 * GEN-02, GEN-03: Generate default graduated schedule
 *
 * Standard WorkSafe Victoria progression:
 * - Week 1: 4 hrs/day, 3 days/week (12 hrs/week)
 * - Week 2: 4 hrs/day, 5 days/week (20 hrs/week)
 * - Week 3: 6 hrs/day, 5 days/week (30 hrs/week)
 * - Week 4+: 8 hrs/day, 5 days/week (40 hrs/week)
 *
 * GEN-08: Truncate schedule if restrictionReviewDate is near
 */
export function generateDefaultSchedule(config: ScheduleConfig): WeekSchedule[];

/**
 * GEN-04: Validate custom schedule against restrictions
 *
 * Validation rules:
 * - Hours per day cannot exceed maxWorkHoursPerDay
 * - Days per week cannot exceed maxWorkDaysPerWeek
 * - Schedule cannot extend past restrictionReviewDate
 * - Max 2 hour/day increase per week (safe progression)
 * - Max 2 day/week increase per week
 */
export function validateCustomSchedule(
  schedule: WeekSchedule[],
  restrictions: FunctionalRestrictions,
  restrictionReviewDate: Date | null
): ScheduleValidation;

/**
 * GEN-07: Calculate total weekly hours
 */
export function calculateWeeklyHours(hoursPerDay: number, daysPerWeek: number): number;

/**
 * Generate partial hours schedule (single week at reduced capacity)
 */
export function generatePartialHoursSchedule(config: ScheduleConfig): WeekSchedule[];

/**
 * Generate normal hours schedule (full capacity from start)
 */
export function generateNormalHoursSchedule(config: ScheduleConfig): WeekSchedule[];
```

Implementation details:
- Use date-fns for all date arithmetic (addWeeks, differenceInWeeks, isAfter)
- Cap schedule at 12 weeks maximum
- Respect restriction review date strictly (GEN-08)
- Apply worker restriction caps (maxHoursPerDay, maxDaysPerWeek)
- Include helpful notes for each week (e.g., "Increased hours per day")
- Return empty schedule if no valid weeks possible
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit server/services/scheduleCalculator.ts`</verify>
  <done>scheduleCalculator.ts exports generateDefaultSchedule, validateCustomSchedule, calculateWeeklyHours with date-fns integration</done>
</task>

<task type="auto">
  <name>Task 3: Create Unit Tests</name>
  <files>server/services/planGenerator.test.ts</files>
  <action>
Create comprehensive unit tests using Vitest:

```typescript
import { describe, it, expect } from "vitest";
import { recommendPlanType, filterDutiesForPlan, generatePlanDuties } from "./planGenerator";
import {
  generateDefaultSchedule,
  validateCustomSchedule,
  calculateWeeklyHours
} from "./scheduleCalculator";

describe("Plan Generator Service", () => {
  describe("recommendPlanType (GEN-01)", () => {
    it("returns normal_hours when no restrictions and all duties suitable", () => {});
    it("returns normal_hours when no restrictions and >= 80% suitable", () => {});
    it("returns partial_hours when hour restrictions but duties OK", () => {});
    it("returns graduated_return when duty restrictions present", () => {});
    it("returns graduated_return when < 80% duties suitable", () => {});
    it("returns graduated_return as safe default when uncertain", () => {});
    it("includes warnings when some duties require modifications", () => {});
    it("handles empty duty list with warning", () => {});
    it("handles null restrictions with low confidence", () => {});
  });

  describe("filterDutiesForPlan (GEN-05, GEN-06)", () => {
    it("includes suitable duties without modification notes", () => {});
    it("includes suitable_with_modification duties with notes", () => {});
    it("excludes not_suitable duties with reason (GEN-06)", () => {});
    it("respects includeModifications flag", () => {});
    it("handles mixed suitability levels correctly", () => {});
  });

  describe("generatePlanDuties", () => {
    it("generates correct InsertRTWPlanDuty records", () => {});
    it("maps filtered duties to plan version", () => {});
  });
});

describe("Schedule Calculator Service", () => {
  describe("generateDefaultSchedule (GEN-02, GEN-03)", () => {
    it("generates 4->6->8 hour progression (GEN-03)", () => {});
    it("starts with 4 hrs/day, 3 days/week", () => {});
    it("increases days before hours", () => {});
    it("respects maxHoursPerDay restriction", () => {});
    it("respects maxDaysPerWeek restriction", () => {});
    it("truncates at restrictionReviewDate (GEN-08)", () => {});
    it("returns single week if review date is 1 week away", () => {});
    it("caps at 12 weeks maximum", () => {});
    it("includes helpful notes per week", () => {});
  });

  describe("validateCustomSchedule (GEN-04)", () => {
    it("passes valid schedule", () => {});
    it("fails when hours exceed maxWorkHoursPerDay", () => {});
    it("fails when days exceed maxWorkDaysPerWeek", () => {});
    it("fails when schedule extends past review date (GEN-08)", () => {});
    it("warns when hour increase > 2 per week", () => {});
    it("warns when day increase > 2 per week", () => {});
    it("allows decreasing hours (flexibility)", () => {});
  });

  describe("calculateWeeklyHours (GEN-07)", () => {
    it("calculates 4 hrs * 3 days = 12 hrs", () => {});
    it("calculates 8 hrs * 5 days = 40 hrs", () => {});
    it("handles decimal hours", () => {});
  });
});
```

Ensure tests cover:
- All requirements explicitly (GEN-01 through GEN-08)
- Edge cases: empty inputs, null restrictions, near review dates
- Boundary conditions: exactly 80% suitable, exactly at review date
- Integration between planGenerator and scheduleCalculator
  </action>
  <verify>`npm test -- --run server/services/planGenerator.test.ts` passes with all tests green</verify>
  <done>All unit tests pass, covering GEN-01 through GEN-08 explicitly</done>
</task>

</tasks>

<verification>
1. TypeScript: `npm run build` completes without errors
2. Unit tests: `npm test -- --run server/services/planGenerator.test.ts` all pass
3. Exports: Both services export documented types and functions
4. Integration: planGenerator can import from functionalAbilityCalculator
</verification>

<success_criteria>
- [ ] planGenerator.ts implements recommendPlanType with decision tree
- [ ] planGenerator.ts implements filterDutiesForPlan with inclusion/exclusion logic
- [ ] scheduleCalculator.ts implements generateDefaultSchedule with 4->6->8 progression
- [ ] scheduleCalculator.ts implements validateCustomSchedule with restriction checks
- [ ] All GEN-01 through GEN-08 requirements covered by unit tests
- [ ] Unit tests pass with > 90% coverage of new code
</success_criteria>

<output>
After completion, create `.planning/phases/05-plan-generator/05-01-SUMMARY.md`
</output>
