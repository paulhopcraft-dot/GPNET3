---
phase: 05-plan-generator
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - server/routes/rtwPlans.ts
  - server/routes.ts
  - server/storage.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/rtw-plans/recommend returns plan type and default schedule"
    - "POST /api/rtw-plans creates plan as draft with version 1"
    - "Server validates duties are suitable before accepting plan"
    - "Server validates schedule respects restriction review date"
    - "Created plans are persisted to database with all related records"
  artifacts:
    - path: "server/routes/rtwPlans.ts"
      provides: "RTW plans API endpoints"
      exports: ["default (router)"]
    - path: "server/routes.ts"
      provides: "Route registration"
      contains: "rtwPlansRouter"
    - path: "server/storage.ts"
      provides: "Database operations for RTW plans"
      contains: "createRTWPlan"
  key_links:
    - from: "server/routes/rtwPlans.ts"
      to: "server/services/planGenerator.ts"
      via: "import"
      pattern: "from.*planGenerator"
    - from: "server/routes/rtwPlans.ts"
      to: "server/services/scheduleCalculator.ts"
      via: "import"
      pattern: "from.*scheduleCalculator"
    - from: "server/routes.ts"
      to: "server/routes/rtwPlans.ts"
      via: "app.use"
      pattern: "rtwPlansRouter"
---

<objective>
Create RTW plans API endpoints for recommendation and plan creation (GEN-09, GEN-10).

Purpose: HTTP interface for frontend wizard to get recommendations and save draft plans with full validation.

Output:
- rtwPlans.ts router with recommend and create endpoints
- Storage methods for plan persistence
- Route registration in main routes.ts
</objective>

<execution_context>
@C:\Users\Paul\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Paul\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-plan-generator/05-RESEARCH.md

# Plan 01 outputs (services)
# Note: Reference 05-01-SUMMARY.md if available after execution

# Existing patterns
@server/routes/functionalAbility.ts
@server/routes/restrictions.ts
@server/routes.ts
@server/storage.ts

# Schema
@shared/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RTW Plans API Router</name>
  <files>server/routes/rtwPlans.ts</files>
  <action>
Create RTW plans router with recommendation and creation endpoints:

```typescript
/**
 * RTW Plans API Router
 * GEN-09: Preview plan (via recommend endpoint)
 * GEN-10: Save plan as draft (via POST endpoint)
 */

import { Router } from "express";
import { z } from "zod";
import { authorize, type AuthRequest } from "../middleware/auth";
import { requireCaseOwnership } from "../middleware/caseOwnership";
import { storage } from "../storage";
import { recommendPlanType, filterDutiesForPlan, generatePlanDuties } from "../services/planGenerator";
import { generateDefaultSchedule, validateCustomSchedule, generatePartialHoursSchedule, generateNormalHoursSchedule } from "../services/scheduleCalculator";
import { calculateDutySuitability } from "../services/functionalAbilityCalculator";
import { generateModificationSuggestions } from "../services/modificationSuggester";
import { logAuditEvent, AuditEventTypes, getRequestMetadata } from "../services/auditLogger";
import { rtwDuties, rtwPlans, rtwPlanVersions, rtwPlanDuties, rtwPlanSchedule, eq, and } from "@shared/schema";

const router = Router();

// Validation schemas
const recommendQuerySchema = z.object({
  caseId: z.string().min(1, "caseId required"),
  roleId: z.string().min(1, "roleId required"),
});

const createPlanSchema = z.object({
  caseId: z.string().min(1),
  roleId: z.string().min(1),
  planType: z.enum(["normal_hours", "partial_hours", "graduated_return"]),
  startDate: z.string().datetime(),
  schedule: z.array(z.object({
    weekNumber: z.number().min(1),
    hoursPerDay: z.number().min(1).max(12),
    daysPerWeek: z.number().min(1).max(7),
  })).min(1, "At least one week required"),
  selectedDutyIds: z.array(z.string()).min(1, "At least one duty required"),
});

/**
 * GET /api/rtw-plans/recommend
 * GEN-01, GEN-02, GEN-03: Get plan type recommendation and default schedule
 */
router.get("/recommend", authorize(), async (req: AuthRequest, res) => {
  try {
    const query = recommendQuerySchema.parse(req.query);
    const organizationId = req.user!.organizationId;

    // Get current restrictions for case
    const restrictions = await storage.getCurrentRestrictions(query.caseId, organizationId);
    if (!restrictions) {
      return res.status(404).json({ error: "No current restrictions found for this case" });
    }

    // Get duties for role with demands
    const duties = await storage.getRoleDutiesWithDemands(query.roleId, organizationId);
    if (duties.length === 0) {
      return res.status(404).json({ error: "No duties found for this role" });
    }

    // Calculate suitability for each duty
    const dutySuitability = duties.map(duty => {
      const result = calculateDutySuitability(duty.demands, restrictions, duty.isModifiable);
      const suggestions = generateModificationSuggestions(result.demandComparisons, duty.isModifiable);
      return {
        duty,
        suitability: result.overallSuitability,
        modificationSuggestions: suggestions,
      };
    });

    // Get plan type recommendation
    const recommendation = recommendPlanType(restrictions, dutySuitability);

    // Generate appropriate schedule based on plan type
    const scheduleConfig = {
      startDate: new Date(),
      restrictionReviewDate: restrictions.nextExaminationDate || null,
      maxHoursPerDay: restrictions.maxWorkHoursPerDay ?? null,
      maxDaysPerWeek: restrictions.maxWorkDaysPerWeek ?? null,
    };

    let defaultSchedule;
    switch (recommendation.planType) {
      case "normal_hours":
        defaultSchedule = generateNormalHoursSchedule(scheduleConfig);
        break;
      case "partial_hours":
        defaultSchedule = generatePartialHoursSchedule(scheduleConfig);
        break;
      case "graduated_return":
      default:
        defaultSchedule = generateDefaultSchedule(scheduleConfig);
        break;
    }

    // Filter duties for inclusion
    const filteredDuties = filterDutiesForPlan(dutySuitability, true);

    res.json({
      success: true,
      data: {
        recommendation,
        defaultSchedule,
        restrictionReviewDate: restrictions.nextExaminationDate,
        restrictions: {
          maxHoursPerDay: restrictions.maxWorkHoursPerDay,
          maxDaysPerWeek: restrictions.maxWorkDaysPerWeek,
        },
        duties: filteredDuties.map(d => ({
          dutyId: d.dutyId,
          dutyName: d.dutyName,
          suitability: d.suitability,
          isIncluded: d.isIncluded,
          modificationNotes: d.modificationNotes,
          excludedReason: d.excludedReason,
        })),
      },
    });
  } catch (err) {
    if (err instanceof z.ZodError) {
      return res.status(400).json({ error: "Validation failed", details: err.errors });
    }
    console.error("[RTW Plans] Recommend failed:", err);
    res.status(500).json({ error: "Failed to generate recommendation" });
  }
});

/**
 * POST /api/rtw-plans
 * GEN-10: Save plan as draft
 */
router.post("/", authorize(), async (req: AuthRequest, res) => {
  try {
    const planData = createPlanSchema.parse(req.body);
    const userId = req.user!.id;
    const organizationId = req.user!.organizationId;

    // Verify case belongs to organization
    const workerCase = await storage.getCaseById(planData.caseId, organizationId);
    if (!workerCase) {
      return res.status(404).json({ error: "Case not found" });
    }

    // Get restrictions and validate schedule
    const restrictions = await storage.getCurrentRestrictions(planData.caseId, organizationId);
    if (!restrictions) {
      return res.status(400).json({ error: "No current restrictions - cannot create plan" });
    }

    // Validate schedule against restrictions
    const scheduleValidation = validateCustomSchedule(
      planData.schedule.map((s, i) => ({
        weekNumber: s.weekNumber,
        hoursPerDay: s.hoursPerDay,
        daysPerWeek: s.daysPerWeek,
        totalHoursPerWeek: s.hoursPerDay * s.daysPerWeek,
        startDate: new Date(planData.startDate),
        endDate: new Date(planData.startDate),
      })),
      restrictions,
      restrictions.nextExaminationDate || null
    );

    if (!scheduleValidation.valid) {
      return res.status(400).json({
        error: "Schedule validation failed",
        details: scheduleValidation.errors,
      });
    }

    // Get selected duties and verify suitability
    const duties = await storage.getDutiesByIds(planData.selectedDutyIds, organizationId);
    if (duties.length !== planData.selectedDutyIds.length) {
      return res.status(400).json({ error: "One or more selected duties not found" });
    }

    // Verify no not_suitable duties included
    const dutySuitability = duties.map(duty => {
      const result = calculateDutySuitability(duty.demands, restrictions, duty.isModifiable);
      return { duty, suitability: result.overallSuitability };
    });

    const notSuitable = dutySuitability.filter(d => d.suitability === "not_suitable");
    if (notSuitable.length > 0) {
      return res.status(400).json({
        error: "Plan includes not-suitable duties",
        details: notSuitable.map(d => ({ dutyId: d.duty.id, dutyName: d.duty.name })),
      });
    }

    // Create plan using storage method
    const result = await storage.createRTWPlan({
      organizationId,
      caseId: planData.caseId,
      roleId: planData.roleId,
      planType: planData.planType,
      startDate: new Date(planData.startDate),
      restrictionReviewDate: restrictions.nextExaminationDate || null,
      createdBy: userId,
      schedule: planData.schedule,
      duties: filterDutiesForPlan(dutySuitability.map(d => ({
        duty: d.duty,
        suitability: d.suitability,
        modificationSuggestions: [],
      })), true),
    });

    // Log audit event
    await logAuditEvent({
      userId,
      organizationId,
      eventType: "rtw_plan_created" as any,
      resourceType: "rtw_plan",
      resourceId: result.planId,
      metadata: {
        caseId: planData.caseId,
        planType: planData.planType,
        weekCount: planData.schedule.length,
        dutyCount: planData.selectedDutyIds.length,
      },
      ...getRequestMetadata(req),
    });

    res.status(201).json({
      success: true,
      planId: result.planId,
      versionId: result.versionId,
      message: "RTW plan created as draft",
    });
  } catch (err) {
    if (err instanceof z.ZodError) {
      return res.status(400).json({ error: "Validation failed", details: err.errors });
    }
    console.error("[RTW Plans] Create failed:", err);
    res.status(500).json({ error: "Failed to create plan" });
  }
});

/**
 * GET /api/rtw-plans/:planId
 * Get plan details
 */
router.get("/:planId", authorize(), async (req: AuthRequest, res) => {
  try {
    const { planId } = req.params;
    const organizationId = req.user!.organizationId;

    const plan = await storage.getRTWPlanById(planId, organizationId);
    if (!plan) {
      return res.status(404).json({ error: "Plan not found" });
    }

    res.json({ success: true, data: plan });
  } catch (err) {
    console.error("[RTW Plans] Get failed:", err);
    res.status(500).json({ error: "Failed to get plan" });
  }
});

export default router;
```

Key implementation notes:
- Use existing authorize() middleware pattern from other routes
- Validate all input with Zod schemas
- Server-side validation of duty suitability (never trust client)
- Server-side validation of schedule against restrictions
- Log all plan creation with audit logger
- Return 201 for successful creation, 400 for validation errors
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit server/routes/rtwPlans.ts`</verify>
  <done>rtwPlans.ts exports router with GET /recommend and POST / endpoints</done>
</task>

<task type="auto">
  <name>Task 2: Add Storage Methods for RTW Plans</name>
  <files>server/storage.ts</files>
  <action>
Add storage methods for RTW plan operations to the existing storage.ts file.

Find the IStorage interface and add these method signatures:

```typescript
// In IStorage interface, add:
createRTWPlan(data: CreateRTWPlanData): Promise<{ planId: string; versionId: string }>;
getRTWPlanById(planId: string, organizationId: string): Promise<RTWPlanWithDetails | null>;
getRoleDutiesWithDemands(roleId: string, organizationId: string): Promise<RTWDutyWithDemands[]>;
getDutiesByIds(dutyIds: string[], organizationId: string): Promise<RTWDutyWithDemands[]>;
```

Add type definitions near other types:

```typescript
interface CreateRTWPlanData {
  organizationId: string;
  caseId: string;
  roleId: string;
  planType: string;
  startDate: Date;
  restrictionReviewDate: Date | null;
  createdBy: string;
  schedule: Array<{
    weekNumber: number;
    hoursPerDay: number;
    daysPerWeek: number;
  }>;
  duties: Array<{
    dutyId: string;
    dutyName: string;
    suitability: string;
    modificationNotes: string | null;
    excludedReason: string | null;
    isIncluded: boolean;
  }>;
}

interface RTWDutyWithDemands extends RTWDutyDB {
  demands: RTWDutyDemandsDB | null;
}

interface RTWPlanWithDetails {
  plan: RTWPlanDB;
  version: RTWPlanVersionDB;
  schedule: RTWPlanScheduleDB[];
  duties: RTWPlanDutyDB[];
}
```

Implement in DatabaseStorage class:

```typescript
async createRTWPlan(data: CreateRTWPlanData): Promise<{ planId: string; versionId: string }> {
  return await db.transaction(async (tx) => {
    // 1. Create plan
    const [plan] = await tx.insert(rtwPlans).values({
      organizationId: data.organizationId,
      caseId: data.caseId,
      roleId: data.roleId,
      planType: data.planType,
      status: "draft",
      version: 1,
      startDate: data.startDate,
      restrictionReviewDate: data.restrictionReviewDate,
      createdBy: data.createdBy,
    }).returning();

    // 2. Create version
    const [version] = await tx.insert(rtwPlanVersions).values({
      planId: plan.id,
      version: 1,
      dataJson: data,
      createdBy: data.createdBy,
      changeReason: "Initial plan creation",
    }).returning();

    // 3. Create schedule records
    const scheduleRecords = data.schedule.map(week => ({
      planVersionId: version.id,
      weekNumber: week.weekNumber,
      hoursPerDay: week.hoursPerDay.toString(),
      daysPerWeek: week.daysPerWeek,
    }));
    if (scheduleRecords.length > 0) {
      await tx.insert(rtwPlanSchedule).values(scheduleRecords);
    }

    // 4. Create duty records (only included ones)
    const dutyRecords = data.duties.filter(d => d.isIncluded).map(duty => ({
      planVersionId: version.id,
      dutyId: duty.dutyId,
      suitability: duty.suitability,
      modificationNotes: duty.modificationNotes,
      excludedReason: null,
      manuallyOverridden: false,
    }));
    if (dutyRecords.length > 0) {
      await tx.insert(rtwPlanDuties).values(dutyRecords);
    }

    return { planId: plan.id, versionId: version.id };
  });
}

async getRTWPlanById(planId: string, organizationId: string): Promise<RTWPlanWithDetails | null> {
  const [plan] = await db.select()
    .from(rtwPlans)
    .where(and(eq(rtwPlans.id, planId), eq(rtwPlans.organizationId, organizationId)))
    .limit(1);

  if (!plan) return null;

  const [version] = await db.select()
    .from(rtwPlanVersions)
    .where(and(eq(rtwPlanVersions.planId, planId), eq(rtwPlanVersions.version, plan.version)))
    .limit(1);

  const schedule = version ? await db.select()
    .from(rtwPlanSchedule)
    .where(eq(rtwPlanSchedule.planVersionId, version.id))
    .orderBy(rtwPlanSchedule.weekNumber) : [];

  const duties = version ? await db.select()
    .from(rtwPlanDuties)
    .where(eq(rtwPlanDuties.planVersionId, version.id)) : [];

  return { plan, version, schedule, duties };
}

async getRoleDutiesWithDemands(roleId: string, organizationId: string): Promise<RTWDutyWithDemands[]> {
  const duties = await db.select()
    .from(rtwDuties)
    .leftJoin(rtwDutyDemands, eq(rtwDuties.id, rtwDutyDemands.dutyId))
    .where(and(
      eq(rtwDuties.roleId, roleId),
      eq(rtwDuties.organizationId, organizationId),
      eq(rtwDuties.isActive, true)
    ));

  return duties.map(row => ({
    ...row.rtw_duties,
    demands: row.rtw_duty_demands,
  }));
}

async getDutiesByIds(dutyIds: string[], organizationId: string): Promise<RTWDutyWithDemands[]> {
  if (dutyIds.length === 0) return [];

  const duties = await db.select()
    .from(rtwDuties)
    .leftJoin(rtwDutyDemands, eq(rtwDuties.id, rtwDutyDemands.dutyId))
    .where(and(
      inArray(rtwDuties.id, dutyIds),
      eq(rtwDuties.organizationId, organizationId)
    ));

  return duties.map(row => ({
    ...row.rtw_duties,
    demands: row.rtw_duty_demands,
  }));
}
```

Add necessary imports at top of file:
- `import { rtwPlans, rtwPlanVersions, rtwPlanDuties, rtwPlanSchedule, rtwDuties, rtwDutyDemands } from "@shared/schema";`
- `import { inArray } from "drizzle-orm";`
  </action>
  <verify>TypeScript compiles: `npm run build` or `npx tsc --noEmit`</verify>
  <done>storage.ts has createRTWPlan, getRTWPlanById, getRoleDutiesWithDemands, getDutiesByIds methods</done>
</task>

<task type="auto">
  <name>Task 3: Register RTW Plans Router</name>
  <files>server/routes.ts</files>
  <action>
Register the new RTW plans router in the main routes file.

1. Add import at top with other route imports:
```typescript
import rtwPlansRouter from "./routes/rtwPlans";
```

2. Add route registration in registerRoutes function (after functionalAbilityRouter):
```typescript
// RTW Plan Generator routes (JWT-protected) - GEN-01 to GEN-10
app.use("/api/rtw-plans", authorize(), rtwPlansRouter);
```

Place after the existing functional ability routes (line ~107) for logical grouping.
  </action>
  <verify>Server starts without errors: `npm run dev` and check `/api/rtw-plans/recommend` responds (even if 400 for missing params)</verify>
  <done>RTW plans router registered at /api/rtw-plans endpoint</done>
</task>

</tasks>

<verification>
1. TypeScript: `npm run build` completes without errors
2. Server: `npm run dev` starts without errors
3. API test: `curl "http://localhost:5000/api/rtw-plans/recommend"` returns 400 (missing caseId/roleId)
4. Route exists: No 404 on the RTW plans endpoints
</verification>

<success_criteria>
- [ ] GET /api/rtw-plans/recommend returns plan type, schedule, and duty recommendations
- [ ] POST /api/rtw-plans creates plan as draft with version 1
- [ ] Server validates duties are suitable before saving
- [ ] Server validates schedule respects restrictions
- [ ] Audit logging captures plan creation events
- [ ] Storage methods persist all related records in transaction
</success_criteria>

<output>
After completion, create `.planning/phases/05-plan-generator/05-02-SUMMARY.md`
</output>
