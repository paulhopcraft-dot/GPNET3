---
phase: 06-plan-output
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - client/src/components/rtw/PlanDetailView.tsx
  - client/src/components/rtw/ManagerEmailSection.tsx
  - client/src/components/rtw/PlanPrintView.tsx
  - client/src/pages/rtw/PlanPage.tsx
  - client/src/App.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "Complete plan displays with all sections (OUT-01 to OUT-06)"
    - "Manager email displays and is editable before approval (OUT-07, OUT-08)"
    - "Print button triggers browser print dialog (OUT-09)"
    - "PDF export uses browser print-to-PDF (OUT-10)"
    - "Plan page is accessible at /rtw/plans/:planId route"
  artifacts:
    - path: "client/src/components/rtw/PlanDetailView.tsx"
      provides: "Complete plan view composing all sections"
      exports: ["PlanDetailView"]
    - path: "client/src/components/rtw/ManagerEmailSection.tsx"
      provides: "Email generation and editing component"
      exports: ["ManagerEmailSection"]
    - path: "client/src/components/rtw/PlanPrintView.tsx"
      provides: "Print wrapper with react-to-print"
      exports: ["PlanPrintView"]
    - path: "client/src/pages/rtw/PlanPage.tsx"
      provides: "Plan detail page"
      exports: ["default"]
  key_links:
    - from: "client/src/components/rtw/PlanDetailView.tsx"
      to: "/api/rtw-plans/:planId/details"
      via: "TanStack Query fetch"
      pattern: "useQuery.*rtw-plan-detail"
    - from: "client/src/components/rtw/ManagerEmailSection.tsx"
      to: "/api/rtw-plans/:planId/email"
      via: "TanStack Query fetch"
      pattern: "useQuery.*rtw-plan-email"
    - from: "client/src/components/rtw/PlanPrintView.tsx"
      to: "react-to-print"
      via: "useReactToPrint hook"
      pattern: "useReactToPrint"
    - from: "client/src/App.tsx"
      to: "client/src/pages/rtw/PlanPage.tsx"
      via: "React Router route"
      pattern: "Route.*rtw/plans"
---

<objective>
Create the complete plan detail view with print/PDF export functionality and email generation UI.

Purpose: Assemble all Phase 6 components into a complete plan output page with print support (OUT-09, OUT-10), email section (OUT-07, OUT-08), and route registration.
Output: PlanDetailView composing sections, ManagerEmailSection for email display/edit, PlanPrintView with react-to-print, PlanPage route.
</objective>

<execution_context>
@C:\Users\Paul\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Paul\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-plan-output/06-RESEARCH.md
@.planning/phases/06-plan-output/06-01-SUMMARY.md
@.planning/phases/06-plan-output/06-02-SUMMARY.md
@client/src/components/rtw/FunctionalAbilityMatrix.tsx
@client/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-to-print and Create Print View</name>
  <files>package.json, client/src/components/rtw/PlanPrintView.tsx</files>
  <action>
1. Install react-to-print:
   ```bash
   npm install react-to-print
   ```

2. Create `client/src/components/rtw/PlanPrintView.tsx`:

```tsx
/**
 * PlanPrintView
 * Wrapper component for print and PDF export functionality (OUT-09, OUT-10)
 * Uses react-to-print to trigger browser print dialog
 */

import { useRef } from "react";
import { useReactToPrint } from "react-to-print";
import { Button } from "@/components/ui/button";
import { Printer, FileDown } from "lucide-react";
import { PlanDetailView } from "./PlanDetailView";

interface PlanPrintViewProps {
  planId: string;
}

export function PlanPrintView({ planId }: PlanPrintViewProps) {
  const printRef = useRef<HTMLDivElement>(null);

  const handlePrint = useReactToPrint({
    contentRef: printRef,
    documentTitle: `RTW-Plan-${planId}`,
    pageStyle: `
      @page {
        size: A4 portrait;
        margin: 20mm 15mm;
      }
    `,
  });

  return (
    <div>
      {/* Print controls - hidden in print */}
      <div className="flex items-center gap-2 mb-4 print:hidden">
        <Button onClick={() => handlePrint()} variant="outline" size="sm">
          <Printer className="h-4 w-4 mr-2" />
          Print Plan
        </Button>
        <Button onClick={() => handlePrint()} variant="outline" size="sm">
          <FileDown className="h-4 w-4 mr-2" />
          Export PDF
        </Button>
        <span className="text-xs text-muted-foreground">
          (Select "Save as PDF" in print dialog for PDF export)
        </span>
      </div>

      {/* Printable content */}
      <div ref={printRef}>
        <PlanDetailView
          planId={planId}
          showPrintControls={false}
          showEmailSection={false}
        />
      </div>
    </div>
  );
}
```
  </action>
  <verify>
- react-to-print in package.json dependencies
- File exists: client/src/components/rtw/PlanPrintView.tsx
- `npm run build` succeeds
  </verify>
  <done>react-to-print installed and PlanPrintView wrapper created for print/PDF functionality</done>
</task>

<task type="auto">
  <name>Task 2: Create Manager Email Section Component</name>
  <files>client/src/components/rtw/ManagerEmailSection.tsx</files>
  <action>
Create `client/src/components/rtw/ManagerEmailSection.tsx` for OUT-07 and OUT-08:

```tsx
/**
 * ManagerEmailSection
 * Displays and allows editing of manager notification email
 * OUT-07: Generate manager email from plan
 * OUT-08: Email editable only before approval
 */

import { useState, useEffect } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Mail, Copy, RefreshCw, Loader2, Lock } from "lucide-react";
import { useToast } from "@/hooks/use-toast";

interface ManagerEmailSectionProps {
  planId: string;
  planStatus: string;
}

interface EmailDraft {
  subject: string;
  body: string;
}

export function ManagerEmailSection({ planId, planStatus }: ManagerEmailSectionProps) {
  const { toast } = useToast();
  const queryClient = useQueryClient();
  const [subject, setSubject] = useState("");
  const [body, setBody] = useState("");

  // OUT-08: Email editable only before approval
  const isLocked = planStatus === "approved";

  // Fetch email draft
  const { data: emailDraft, isLoading } = useQuery<EmailDraft>({
    queryKey: ["rtw-plan-email", planId],
    queryFn: async () => {
      const response = await fetch(`/api/rtw-plans/${planId}/email`);
      if (!response.ok) {
        throw new Error("Failed to fetch email");
      }
      const result = await response.json();
      return result.data || result;
    },
  });

  // Sync local state with fetched data
  useEffect(() => {
    if (emailDraft) {
      setSubject(emailDraft.subject);
      setBody(emailDraft.body);
    }
  }, [emailDraft]);

  // Regenerate email mutation
  const regenerateMutation = useMutation({
    mutationFn: async () => {
      const response = await fetch(`/api/rtw-plans/${planId}/email/regenerate`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });
      if (!response.ok) {
        throw new Error("Failed to regenerate email");
      }
      const result = await response.json();
      return result.data || result;
    },
    onSuccess: (data) => {
      setSubject(data.subject);
      setBody(data.body);
      queryClient.invalidateQueries({ queryKey: ["rtw-plan-email", planId] });
      toast({ title: "Email regenerated successfully" });
    },
    onError: () => {
      toast({ title: "Failed to regenerate email", variant: "destructive" });
    },
  });

  // Copy to clipboard
  const handleCopy = async () => {
    const fullEmail = `Subject: ${subject}\n\n${body}`;
    await navigator.clipboard.writeText(fullEmail);
    toast({ title: "Email copied to clipboard" });
  };

  if (isLoading) {
    return (
      <Card className="print:hidden">
        <CardContent className="flex items-center justify-center py-8">
          <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />
          <span className="ml-2 text-muted-foreground">Generating email...</span>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card className="print:hidden">
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Mail className="h-5 w-5" />
          Manager Notification Email
        </CardTitle>
        <CardDescription>
          {isLocked ? (
            <span className="flex items-center gap-1 text-amber-600">
              <Lock className="h-3 w-3" />
              Email locked after plan approval
            </span>
          ) : (
            "Edit the email before sending to the manager"
          )}
        </CardDescription>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* Subject line */}
        <div className="space-y-2">
          <Label htmlFor="email-subject">Subject</Label>
          <Input
            id="email-subject"
            value={subject}
            onChange={(e) => setSubject(e.target.value)}
            disabled={isLocked}
            placeholder="Email subject"
          />
        </div>

        {/* Email body */}
        <div className="space-y-2">
          <Label htmlFor="email-body">Body</Label>
          <Textarea
            id="email-body"
            value={body}
            onChange={(e) => setBody(e.target.value)}
            disabled={isLocked}
            rows={12}
            className="font-mono text-sm"
            placeholder="Email body will be generated..."
          />
        </div>

        {/* Actions */}
        <div className="flex flex-wrap gap-2">
          <Button onClick={handleCopy} variant="outline" size="sm">
            <Copy className="h-4 w-4 mr-2" />
            Copy to Clipboard
          </Button>
          {!isLocked && (
            <Button
              onClick={() => regenerateMutation.mutate()}
              variant="outline"
              size="sm"
              disabled={regenerateMutation.isPending}
            >
              {regenerateMutation.isPending ? (
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
              ) : (
                <RefreshCw className="h-4 w-4 mr-2" />
              )}
              Regenerate
            </Button>
          )}
        </div>

        {isLocked && (
          <Alert className="bg-amber-50 border-amber-200">
            <AlertDescription className="text-amber-800 text-sm">
              This plan has been approved. Email content cannot be modified.
              You can still copy the email to your clipboard.
            </AlertDescription>
          </Alert>
        )}
      </CardContent>
    </Card>
  );
}
```
  </action>
  <verify>
- File exists: client/src/components/rtw/ManagerEmailSection.tsx
- `npm run build` succeeds
  </verify>
  <done>ManagerEmailSection created with email display, editing (when allowed), regeneration, and copy functionality</done>
</task>

<task type="auto">
  <name>Task 3: Create PlanDetailView and PlanPage</name>
  <files>
    client/src/components/rtw/PlanDetailView.tsx
    client/src/pages/rtw/PlanPage.tsx
    client/src/App.tsx
  </files>
  <action>
1. Create `client/src/components/rtw/PlanDetailView.tsx`:

```tsx
/**
 * PlanDetailView
 * Complete RTW plan display composing all section components
 * Implements OUT-01 through OUT-06
 */

import { useQuery } from "@tanstack/react-query";
import { Loader2, AlertTriangle } from "lucide-react";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { PlanSummaryHeader } from "./PlanSummaryHeader";
import { MedicalConstraintsCard } from "./MedicalConstraintsCard";
import { ScheduleSection } from "./ScheduleSection";
import { DutiesSection } from "./DutiesSection";
import { FunctionalAbilityMatrix } from "./FunctionalAbilityMatrix";
import { ManagerEmailSection } from "./ManagerEmailSection";

interface PlanDetailViewProps {
  planId: string;
  showPrintControls?: boolean;
  showEmailSection?: boolean;
}

interface PlanDetailsResponse {
  success: boolean;
  data: {
    plan: {
      id: string;
      caseId: string;
      roleId: string;
      planType: string;
      status: string;
      startDate: string;
      restrictionReviewDate: string | null;
    };
    schedule: Array<{
      weekNumber: number;
      hoursPerDay: number;
      daysPerWeek: number;
    }>;
    duties: Array<{
      dutyId: string;
      dutyName: string;
      dutyDescription: string | null;
      suitability: string;
      modificationNotes: string | null;
      isIncluded: boolean;
      excludedReason: string | null;
    }>;
    workerCase: {
      id: string;
      workerName: string;
      company: string;
      dateOfInjury: string;
      workStatus: string;
    } | null;
    role: {
      id: string;
      name: string;
      description: string | null;
    } | null;
    restrictions: Record<string, any> | null;
  };
}

export function PlanDetailView({
  planId,
  showPrintControls = true,
  showEmailSection = true,
}: PlanDetailViewProps) {
  const { data, isLoading, error } = useQuery<PlanDetailsResponse>({
    queryKey: ["rtw-plan-detail", planId],
    queryFn: async () => {
      const response = await fetch(`/api/rtw-plans/${planId}/details`);
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || "Failed to load plan");
      }
      return response.json();
    },
    enabled: !!planId,
  });

  if (isLoading) {
    return (
      <div className="flex items-center justify-center py-12">
        <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
        <span className="ml-2 text-muted-foreground">Loading plan details...</span>
      </div>
    );
  }

  if (error) {
    return (
      <Alert variant="destructive">
        <AlertTriangle className="h-4 w-4" />
        <AlertDescription>
          {error instanceof Error ? error.message : "Failed to load plan"}
        </AlertDescription>
      </Alert>
    );
  }

  if (!data?.data) {
    return (
      <Alert>
        <AlertDescription>Plan not found</AlertDescription>
      </Alert>
    );
  }

  const { plan, schedule, duties, workerCase, role, restrictions } = data.data;
  const includedDuties = duties.filter(d => d.isIncluded);
  const excludedDuties = duties.filter(d => !d.isIncluded);

  return (
    <div className="space-y-6 print:space-y-4">
      {/* OUT-01: Plan summary with worker, role, injury */}
      {workerCase && role && (
        <PlanSummaryHeader
          workerName={workerCase.workerName}
          company={workerCase.company}
          dateOfInjury={workerCase.dateOfInjury}
          roleName={role.name}
          planType={plan.planType}
          planStatus={plan.status}
          startDate={plan.startDate}
        />
      )}

      {/* OUT-02: Medical constraints */}
      <MedicalConstraintsCard
        constraints={restrictions}
        restrictionReviewDate={plan.restrictionReviewDate}
      />

      {/* OUT-03: Physical demands matrix */}
      {workerCase && role && (
        <div className="plan-section">
          <FunctionalAbilityMatrix
            caseId={plan.caseId}
            roleId={plan.roleId}
          />
        </div>
      )}

      {/* OUT-05: Proposed schedule */}
      <ScheduleSection
        schedule={schedule}
        startDate={plan.startDate}
      />

      {/* OUT-04 & OUT-06: Duties (proposed and excluded) */}
      <DutiesSection
        includedDuties={includedDuties}
        excludedDuties={excludedDuties}
      />

      {/* OUT-07 & OUT-08: Manager email (hide in print) */}
      {showEmailSection && (
        <ManagerEmailSection
          planId={planId}
          planStatus={plan.status}
        />
      )}
    </div>
  );
}
```

2. Create `client/src/pages/rtw/PlanPage.tsx`:

```tsx
/**
 * PlanPage
 * Route: /rtw/plans/:planId
 * Full plan display page with print/PDF export
 */

import { useParams, Link } from "react-router-dom";
import { ArrowLeft } from "lucide-react";
import { Button } from "@/components/ui/button";
import { PlanPrintView } from "@/components/rtw/PlanPrintView";
import { ManagerEmailSection } from "@/components/rtw/ManagerEmailSection";
import { useQuery } from "@tanstack/react-query";

export default function PlanPage() {
  const { planId } = useParams<{ planId: string }>();

  // Fetch plan status for email section
  const { data: planData } = useQuery({
    queryKey: ["rtw-plan-basic", planId],
    queryFn: async () => {
      const response = await fetch(`/api/rtw-plans/${planId}`);
      if (!response.ok) throw new Error("Failed to fetch plan");
      return response.json();
    },
    enabled: !!planId,
  });

  if (!planId) {
    return <div>Plan ID required</div>;
  }

  return (
    <div className="container mx-auto py-6 max-w-5xl">
      {/* Header with back button */}
      <div className="flex items-center gap-4 mb-6 print:hidden">
        <Button variant="ghost" size="sm" asChild>
          <Link to="/rtw">
            <ArrowLeft className="h-4 w-4 mr-2" />
            Back to RTW Planner
          </Link>
        </Button>
        <h1 className="text-2xl font-bold">Return to Work Plan</h1>
      </div>

      {/* Print view with controls */}
      <PlanPrintView planId={planId} />

      {/* Email section (separate from printable content) */}
      {planData?.data?.plan && (
        <div className="mt-6">
          <ManagerEmailSection
            planId={planId}
            planStatus={planData.data.plan.status}
          />
        </div>
      )}
    </div>
  );
}
```

3. Update `client/src/App.tsx`:
   - Add import: `const PlanPage = lazy(() => import("@/pages/rtw/PlanPage"));`
   - Add route inside protected routes: `<Route path="/rtw/plans/:planId" element={<PlanPage />} />`
   - Place near other RTW-related routes
  </action>
  <verify>
- Files exist: PlanDetailView.tsx, PlanPage.tsx
- Route added to App.tsx
- `npm run build` succeeds
- Navigate to /rtw/plans/{planId} shows plan page
  </verify>
  <done>PlanDetailView and PlanPage created with all sections composed, print functionality enabled, and route registered</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Route /rtw/plans/:planId accessible and renders plan
3. Print button triggers browser print dialog
4. Manager email section shows generated email
5. Email editing disabled for approved plans
</verification>

<success_criteria>
- Complete plan view shows all OUT-01 to OUT-06 sections
- Print/PDF export works via react-to-print (OUT-09, OUT-10)
- Manager email displays and allows editing pre-approval (OUT-07, OUT-08)
- Route properly registered and accessible
- All components properly composed and styled
</success_criteria>

<output>
After completion, create `.planning/phases/06-plan-output/06-03-SUMMARY.md`
</output>
