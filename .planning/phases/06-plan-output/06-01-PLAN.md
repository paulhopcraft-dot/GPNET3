---
phase: 06-plan-output
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/routes/rtwPlans.ts
  - server/storage.ts
  - server/services/rtwEmailService.ts
autonomous: true

must_haves:
  truths:
    - "API returns complete plan with worker, role, and injury context (OUT-01)"
    - "API returns duties enriched with demand details for matrix display (OUT-03)"
    - "Email generation uses AI to create context-aware manager notification (OUT-07)"
  artifacts:
    - path: "server/routes/rtwPlans.ts"
      provides: "GET /api/rtw-plans/:planId/details endpoint"
      contains: "router.get.*details"
    - path: "server/services/rtwEmailService.ts"
      provides: "RTW plan email generation service"
      exports: ["generateRTWPlanEmail"]
  key_links:
    - from: "server/routes/rtwPlans.ts"
      to: "server/storage.ts"
      via: "storage methods for enriched plan data"
      pattern: "storage\\.get"
    - from: "server/routes/rtwPlans.ts"
      to: "server/services/rtwEmailService.ts"
      via: "email generation import"
      pattern: "generateRTWPlanEmail"
---

<objective>
Create backend API endpoints and services for displaying complete RTW plan details and generating manager notification emails.

Purpose: Enable frontend to fetch all data needed for plan display (OUT-01 to OUT-06) and manager email generation (OUT-07).
Output: New API endpoint GET /api/rtw-plans/:planId/details returning enriched plan data, and rtwEmailService for AI-powered email generation.
</objective>

<execution_context>
@C:\Users\Paul\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Paul\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-plan-output/06-RESEARCH.md
@server/routes/rtwPlans.ts
@server/services/emailDraftService.ts
@server/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RTW Email Generation Service</name>
  <files>server/services/rtwEmailService.ts</files>
  <action>
Create new service file `server/services/rtwEmailService.ts` following the existing emailDraftService.ts pattern:

1. Import Anthropic SDK (same pattern as emailDraftService)
2. Define RTW email type configuration:
   - `rtw_plan_notification`: For manager notification about new/updated RTW plan
   - Include subject line template and body guidance
3. Create `generateRTWPlanEmail` function:
   - Parameters: planDetails (plan, case, role, schedule, duties), organizationId
   - Build context string with: worker name, role, injury date, plan type, schedule summary, included duties, excluded duties
   - Use Claude Haiku model (same as emailDraftService)
   - System prompt: Professional IR/RTW manager drafting email to employer about RTW plan
   - Generate subject and body
   - Return { subject: string, body: string }
4. Add helper to format schedule summary (week 1: 4hrs/day x 5 days, etc.)
5. Add helper to format duties list (suitable, with modifications, excluded with reasons)

Model: claude-3-haiku-20240307 (consistent with emailDraftService)
  </action>
  <verify>
- File exists: server/services/rtwEmailService.ts
- TypeScript compiles: `npm run build`
- Exports generateRTWPlanEmail function
  </verify>
  <done>RTW email generation service created with AI-powered email drafting for manager notifications</done>
</task>

<task type="auto">
  <name>Task 2: Add Storage Methods for Plan Details</name>
  <files>server/storage.ts</files>
  <action>
Add new storage methods to support the plan details endpoint:

1. Add `getRTWPlanFullDetails` method:
   - Parameters: planId, organizationId
   - Returns: Plan + version + schedule + duties enriched with:
     - Worker case data (workerName, company, dateOfInjury, workStatus)
     - Role data (name, description)
     - Duty details (name, description, demands) for each plan duty
     - Current restrictions for the case
   - Uses existing methods: getRTWPlanById, getGPNet2CaseById, getRoleById, getDutiesByIds, getCurrentRestrictions
   - Join data into single response object

2. Add `savePlanEmail` method:
   - Parameters: planId, email { subject, body }
   - Stores in email_drafts table (reuse existing table) with:
     - type: "rtw_plan_notification"
     - resourceType: "rtw_plan"
     - resourceId: planId
   - Upsert pattern: update if exists, insert if new

3. Add `getPlanEmail` method:
   - Parameters: planId
   - Query email_drafts where resourceType='rtw_plan' and resourceId=planId
   - Return existing draft or null

Use existing Drizzle patterns. Include proper error handling.
  </action>
  <verify>
- TypeScript compiles: `npm run build`
- Storage interface exports new methods
  </verify>
  <done>Storage methods added for fetching enriched plan details and managing plan emails</done>
</task>

<task type="auto">
  <name>Task 3: Add Plan Details API Endpoint</name>
  <files>server/routes/rtwPlans.ts</files>
  <action>
Extend rtwPlans.ts router with two new endpoints:

1. GET /api/rtw-plans/:planId/details
   - Fetch complete plan data for display using storage.getRTWPlanFullDetails
   - Response structure:
     ```json
     {
       "success": true,
       "data": {
         "plan": { id, caseId, roleId, planType, status, startDate, restrictionReviewDate },
         "version": { id, versionNumber, dataJson },
         "schedule": [{ weekNumber, hoursPerDay, daysPerWeek }],
         "duties": [{
           dutyId, dutyName, dutyDescription, suitability, modificationNotes,
           isIncluded, excludedReason,
           demands: { sitting, standing, lifting, etc. }
         }],
         "workerCase": { id, workerName, company, dateOfInjury, workStatus },
         "role": { id, name, description },
         "restrictions": { maxHoursPerDay, maxDaysPerWeek, ... }
       }
     }
     ```
   - Handle 404 for missing plan

2. GET /api/rtw-plans/:planId/email
   - Check for existing email draft via storage.getPlanEmail
   - If exists, return it
   - If not, generate using rtwEmailService.generateRTWPlanEmail
   - Save generated email via storage.savePlanEmail
   - Return { subject, body }

3. POST /api/rtw-plans/:planId/email/regenerate
   - Always regenerate email (ignore existing)
   - Save new version
   - Return { subject, body }
   - Note: Only allowed when plan.status !== 'approved' (OUT-08)

Import rtwEmailService at top of file. Add proper logging.
  </action>
  <verify>
- TypeScript compiles: `npm run build`
- Manual test: `curl http://localhost:5000/api/rtw-plans/{planId}/details` returns enriched data
  </verify>
  <done>API endpoints created for full plan details and email generation, ready for frontend consumption</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without TypeScript errors
2. Server starts without errors
3. API endpoints respond:
   - GET /api/rtw-plans/:planId/details returns enriched plan data
   - GET /api/rtw-plans/:planId/email returns generated email
   - POST /api/rtw-plans/:planId/email/regenerate creates new email
</verification>

<success_criteria>
- Plan details endpoint returns all data needed for OUT-01 through OUT-06
- Email endpoint generates professional manager notification (OUT-07)
- Email regeneration works for non-approved plans
- TypeScript types are correct and complete
</success_criteria>

<output>
After completion, create `.planning/phases/06-plan-output/06-01-SUMMARY.md`
</output>
