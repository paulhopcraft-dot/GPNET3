---
phase: 11-system-wide-testing
plan: 05
type: execute
wave: 3
depends_on: ["11-02", "11-03", "11-04"]
files_modified:
  - tests/integration/performance/api-response-times.test.ts
  - tests/e2e/performance/page-load-times.spec.ts
autonomous: true

must_haves:
  truths:
    - "API endpoints respond within 5 second target"
    - "Dashboard page loads within 5 seconds"
    - "Case list page loads within 5 seconds"
    - "Performance metrics are logged for baseline establishment"
  artifacts:
    - path: "tests/integration/performance/api-response-times.test.ts"
      provides: "API performance tests using Vitest"
      contains: "toBeLessThan"
    - path: "tests/e2e/performance/page-load-times.spec.ts"
      provides: "Page load performance tests using Playwright"
      contains: "tag.*@performance"
  key_links:
    - from: "tests/e2e/performance/page-load-times.spec.ts"
      to: "tests/e2e/fixtures/auth.fixture.ts"
      via: "import for authenticatedPage"
      pattern: "import.*auth.fixture"
---

<objective>
Create performance tests to verify API and page load times meet targets.

Purpose: The system has a <5s response time target for all major endpoints. These tests establish a baseline and fail if performance degrades. Known issue: some endpoints take 8-63s which needs identification.

Output: API response time tests (Vitest) and page load time tests (Playwright).
</objective>

<execution_context>
@C:\Users\Paul\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Paul\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-system-wide-testing/11-RESEARCH.md
@.planning/phases/11-system-wide-testing/11-01-SUMMARY.md

# Fixtures from Plan 01
@tests/e2e/fixtures/auth.fixture.ts
@tests/e2e/fixtures/test-data.ts

# Existing vitest config
@vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API response time integration tests</name>
  <files>tests/integration/performance/api-response-times.test.ts</files>
  <action>
Create tests/integration/performance/ directory and api-response-times.test.ts:

```typescript
import { describe, it, expect, beforeAll } from 'vitest';

const API_BASE = process.env.API_BASE_URL || 'http://localhost:5000/api';
const PERFORMANCE_TARGET_MS = 5000;
const TEST_TIMEOUT_MS = 60000;

// Test credentials - should match seed data
const CREDENTIALS = {
  email: 'employer@test.com',
  password: 'password123'
};

describe('API Response Time Benchmarks', () => {
  let authCookie: string = '';

  beforeAll(async () => {
    try {
      const res = await fetch(`${API_BASE}/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(CREDENTIALS)
      });

      if (res.ok) {
        authCookie = res.headers.get('set-cookie') || '';
      } else {
        console.warn('Login failed - some tests may fail');
      }
    } catch (error) {
      console.warn('Could not authenticate - ensure server is running');
    }
  }, TEST_TIMEOUT_MS);

  const endpoints = [
    { path: '/employer/dashboard', target: PERFORMANCE_TARGET_MS, name: 'Employer Dashboard' },
    { path: '/gpnet2/cases', target: PERFORMANCE_TARGET_MS, name: 'Cases List' },
    { path: '/employer/workers', target: PERFORMANCE_TARGET_MS, name: 'Workers List' },
    { path: '/auth/me', target: 2000, name: 'Auth Check' },
  ];

  for (const { path, target, name } of endpoints) {
    it(`${name} responds within ${target}ms`, async () => {
      const start = performance.now();

      const res = await fetch(`${API_BASE}${path}`, {
        headers: { Cookie: authCookie }
      });

      const elapsed = performance.now() - start;

      console.log(`${name}: ${elapsed.toFixed(0)}ms (target: ${target}ms)`);

      // Log if slow but under target
      if (elapsed > target * 0.8) {
        console.warn(`  WARNING: ${name} approaching target (${(elapsed/target*100).toFixed(0)}% of limit)`);
      }

      expect(res.status).toBeLessThan(500); // Not server error
      expect(elapsed).toBeLessThan(target);
    }, TEST_TIMEOUT_MS);
  }

  it('identifies slow endpoints (> 8 seconds)', async () => {
    const slowEndpoints: { path: string; time: number }[] = [];

    const endpointsToCheck = [
      '/employer/dashboard',
      '/gpnet2/cases',
      '/employer/workers',
      '/notifications',
      '/actions',
    ];

    for (const path of endpointsToCheck) {
      try {
        const start = performance.now();
        await fetch(`${API_BASE}${path}`, {
          headers: { Cookie: authCookie }
        });
        const elapsed = performance.now() - start;

        if (elapsed > 8000) {
          slowEndpoints.push({ path, time: elapsed });
        }
      } catch {
        // Skip failed requests
      }
    }

    console.log('Slow endpoints (>8s):', slowEndpoints);

    // This is informational - don't fail the test
    // Just log for baseline establishment
  }, TEST_TIMEOUT_MS);

  it('case detail endpoint responds within target', async () => {
    // First get a case ID
    const casesRes = await fetch(`${API_BASE}/gpnet2/cases`, {
      headers: { Cookie: authCookie }
    });

    if (!casesRes.ok) {
      console.warn('Could not fetch cases - skipping case detail test');
      return;
    }

    const cases = await casesRes.json();
    if (!cases?.cases?.length) {
      console.warn('No cases found - skipping case detail test');
      return;
    }

    const caseId = cases.cases[0].id;

    const start = performance.now();
    const detailRes = await fetch(`${API_BASE}/cases/${caseId}`, {
      headers: { Cookie: authCookie }
    });
    const elapsed = performance.now() - start;

    console.log(`Case Detail (${caseId}): ${elapsed.toFixed(0)}ms`);

    expect(detailRes.status).toBeLessThan(500);
    expect(elapsed).toBeLessThan(PERFORMANCE_TARGET_MS);
  }, TEST_TIMEOUT_MS);
});
```

Uses Vitest for integration testing with performance assertions.
Logs actual response times for baseline establishment.
  </action>
  <verify>
    - File exists at tests/integration/performance/api-response-times.test.ts
    - `npm test -- tests/integration` runs without syntax errors
  </verify>
  <done>API performance tests created with 5s target assertions</done>
</task>

<task type="auto">
  <name>Task 2: Create page load time E2E tests</name>
  <files>tests/e2e/performance/page-load-times.spec.ts</files>
  <action>
Create tests/e2e/performance/ directory and page-load-times.spec.ts:

```typescript
import { test, expect } from '../fixtures/auth.fixture';
import { PERFORMANCE_TARGETS } from '../fixtures/test-data';

test.describe('Page Load Times', { tag: '@performance' }, () => {
  const TARGET_MS = PERFORMANCE_TARGETS?.dashboard || 5000;

  test('dashboard loads within target', async ({ authenticatedPage: page }) => {
    const startTime = Date.now();

    await page.goto('/');
    await page.waitForLoadState('networkidle');

    // Wait for actual content (not just initial HTML)
    await page.waitForSelector('text=/cases|dashboard|employer/i', { timeout: TARGET_MS });

    const loadTime = Date.now() - startTime;
    console.log(`Dashboard load time: ${loadTime}ms (target: ${TARGET_MS}ms)`);

    expect(loadTime).toBeLessThan(TARGET_MS);
  });

  test('cases page loads within target', async ({ authenticatedPage: page }) => {
    const startTime = Date.now();

    await page.goto('/cases');
    await page.waitForLoadState('networkidle');

    // Wait for table to appear
    await page.waitForSelector('table, [data-testid^="row-case-"]', { timeout: TARGET_MS });

    const loadTime = Date.now() - startTime;
    console.log(`Cases page load time: ${loadTime}ms (target: ${TARGET_MS}ms)`);

    expect(loadTime).toBeLessThan(TARGET_MS);
  });

  test('case detail loads within target', async ({ authenticatedPage: page }) => {
    // Navigate to cases first
    await page.goto('/cases');
    await page.waitForSelector('[data-testid^="row-case-"]', { timeout: 15000 });

    // Time the case detail load
    const startTime = Date.now();
    await page.locator('[data-testid^="row-case-"]').first().click();
    await page.waitForSelector('[data-testid="case-detail-panel"], [role="tablist"]', { timeout: TARGET_MS });

    const loadTime = Date.now() - startTime;
    console.log(`Case detail load time: ${loadTime}ms (target: ${TARGET_MS}ms)`);

    expect(loadTime).toBeLessThan(TARGET_MS);
  });

  test('employer portal loads within target', async ({ authenticatedPage: page }) => {
    const startTime = Date.now();

    await page.goto('/employer');
    await page.waitForLoadState('networkidle');

    // Wait for dashboard content
    await page.waitForSelector('text=/Symmetry|employer|dashboard/i', { timeout: TARGET_MS });

    const loadTime = Date.now() - startTime;
    console.log(`Employer portal load time: ${loadTime}ms (target: ${TARGET_MS}ms)`);

    expect(loadTime).toBeLessThan(TARGET_MS);
  });

  test('page load times summary', async ({ authenticatedPage: page }) => {
    const timings: { page: string; time: number }[] = [];

    const pages = [
      { path: '/', name: 'Home' },
      { path: '/cases', name: 'Cases' },
      { path: '/employer', name: 'Employer' },
    ];

    for (const { path, name } of pages) {
      const startTime = Date.now();
      await page.goto(path);
      await page.waitForLoadState('networkidle');
      const loadTime = Date.now() - startTime;
      timings.push({ page: name, time: loadTime });
    }

    console.log('\n=== Page Load Times Summary ===');
    for (const { page: pageName, time } of timings) {
      const status = time < TARGET_MS ? 'PASS' : 'FAIL';
      console.log(`${pageName}: ${time}ms [${status}]`);
    }
    console.log('================================\n');

    // All pages should be under target
    const allUnderTarget = timings.every(t => t.time < TARGET_MS);
    expect(allUnderTarget).toBe(true);
  });
});
```

Uses Playwright for browser-based performance testing.
Measures actual user-perceived load times including JavaScript execution.
  </action>
  <verify>
    - npm run test:e2e:performance -- --list shows page-load-times tests
    - Tests tagged with @performance
  </verify>
  <done>Page load E2E performance tests created</done>
</task>

<task type="auto">
  <name>Task 3: Update test-data.ts with performance targets</name>
  <files>tests/e2e/fixtures/test-data.ts</files>
  <action>
Ensure tests/e2e/fixtures/test-data.ts includes PERFORMANCE_TARGETS export:

Add if not already present:

```typescript
export const PERFORMANCE_TARGETS = {
  dashboard: 5000,    // 5 seconds for dashboard load
  caseList: 5000,     // 5 seconds for case list
  caseDetail: 5000,   // 5 seconds for case detail
  apiResponse: 5000,  // 5 seconds for any API call
  authCheck: 2000,    // 2 seconds for auth check (should be fast)
};
```

This centralizes performance targets for easy adjustment.
  </action>
  <verify>
    - PERFORMANCE_TARGETS exported from test-data.ts
    - Targets match Phase 11 requirements (<5s response times)
  </verify>
  <done>Performance targets centralized in test-data.ts</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm test -- tests/integration/performance` runs API tests
2. `npm run test:e2e:performance` runs page load tests
3. Performance targets are centralized and consistent
4. Tests log actual times for baseline establishment
</verification>

<success_criteria>
- tests/integration/performance/api-response-times.test.ts exists
- tests/e2e/performance/page-load-times.spec.ts exists
- All tests use 5s target (configurable via PERFORMANCE_TARGETS)
- Tests log actual response times for baseline analysis
- Slow endpoint detection test identifies any >8s responses
</success_criteria>

<output>
After completion, create `.planning/phases/11-system-wide-testing/11-05-SUMMARY.md`
</output>
