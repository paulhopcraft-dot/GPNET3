---
phase: 11-system-wide-testing
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - tests/e2e/smoke/health.spec.ts
  - tests/e2e/smoke/auth.spec.ts
  - tests/e2e/smoke/navigation.spec.ts
autonomous: true

must_haves:
  truths:
    - "Server health check passes before other tests"
    - "Login works with valid employer credentials"
    - "Login fails gracefully with invalid credentials (no infinite loop)"
    - "Main navigation links are accessible after login"
  artifacts:
    - path: "tests/e2e/smoke/health.spec.ts"
      provides: "Server health check test"
      contains: "tag.*@smoke"
    - path: "tests/e2e/smoke/auth.spec.ts"
      provides: "Authentication smoke tests"
      contains: "tag.*@smoke"
    - path: "tests/e2e/smoke/navigation.spec.ts"
      provides: "Navigation smoke tests"
      contains: "tag.*@smoke"
  key_links:
    - from: "tests/e2e/smoke/auth.spec.ts"
      to: "tests/e2e/fixtures/auth.fixture.ts"
      via: "import for authenticatedPage"
      pattern: "import.*auth.fixture"
---

<objective>
Create smoke tests that provide fast feedback on system health.

Purpose: Smoke tests run first (~2 min) and catch catastrophic failures before running longer test suites. They verify the server starts, auth works, and basic navigation is functional.

Output: Three smoke test files covering health, auth, and navigation.
</objective>

<execution_context>
@C:\Users\Paul\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Paul\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-system-wide-testing/11-RESEARCH.md
@.planning/phases/11-system-wide-testing/11-01-SUMMARY.md

# Fixtures from Plan 01
@tests/e2e/fixtures/auth.fixture.ts
@tests/e2e/fixtures/test-data.ts

# Existing auth patterns
@tests/e2e/auth-sessions.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create health check smoke test</name>
  <files>tests/e2e/smoke/health.spec.ts</files>
  <action>
Create tests/e2e/smoke/ directory and health.spec.ts:

```typescript
import { test, expect } from '@playwright/test';

test.describe('Health Check', { tag: '@smoke' }, () => {
  test('server responds to root URL', async ({ page }) => {
    const response = await page.goto('/');
    expect(response?.status()).toBeLessThan(500);
  });

  test('login page renders', async ({ page }) => {
    await page.goto('/login');
    await expect(page.locator('input[type="email"]')).toBeVisible({ timeout: 10000 });
    await expect(page.locator('input[type="password"]')).toBeVisible();
    await expect(page.locator('button[type="submit"]')).toBeVisible();
  });

  test('API health endpoint responds', async ({ request }) => {
    // Try common health check endpoints
    const healthRes = await request.get('/api/health').catch(() => null);
    const rootRes = await request.get('/').catch(() => null);

    // At least one should respond
    const anyResponse = (healthRes?.ok() || rootRes?.ok());
    expect(anyResponse).toBeTruthy();
  });
});
```

Tag all tests with @smoke for wave-based execution.
  </action>
  <verify>
    - npm run test:e2e:smoke -- --list shows health tests
    - File contains tag: '@smoke'
  </verify>
  <done>Health smoke tests created and tagged</done>
</task>

<task type="auto">
  <name>Task 2: Create authentication smoke tests</name>
  <files>tests/e2e/smoke/auth.spec.ts</files>
  <action>
Create tests/e2e/smoke/auth.spec.ts:

```typescript
import { test, expect } from '@playwright/test';
import { EMPLOYER_CREDENTIALS } from '../fixtures/test-data';

test.describe('Authentication', { tag: '@smoke' }, () => {
  test('login succeeds with valid credentials', async ({ page }) => {
    await page.goto('/login');
    await page.fill('input[type="email"]', EMPLOYER_CREDENTIALS.email);
    await page.fill('input[type="password"]', EMPLOYER_CREDENTIALS.password);
    await page.click('button[type="submit"]');

    // Should redirect away from login
    await expect(page).not.toHaveURL(/\/login/, { timeout: 15000 });

    // Should see some dashboard content
    await expect(page.locator('body')).not.toContainText('Invalid credentials');
  });

  test('login fails gracefully with invalid credentials', async ({ page }) => {
    await page.goto('/login');
    await page.fill('input[type="email"]', 'invalid@test.com');
    await page.fill('input[type="password"]', 'wrongpassword');
    await page.click('button[type="submit"]');

    // Should show error, not hang or loop
    await expect(page.locator('text=/invalid|error|failed/i')).toBeVisible({ timeout: 10000 });

    // Should still be on login page
    await expect(page).toHaveURL(/\/login/);
  });

  test('401 error does not cause infinite loop', async ({ page, context }) => {
    // Intercept auth check to simulate session expiry
    await context.route('**/api/auth/me', route => route.fulfill({ status: 401 }));

    await page.goto('/cases');

    // Should redirect to login, not loop
    await expect(page).toHaveURL(/\/login/, { timeout: 10000 });

    // Verify no excessive network requests (detect infinite loop)
    // Count requests made - should be small number, not hundreds
    let requestCount = 0;
    page.on('request', () => requestCount++);
    await page.waitForTimeout(2000);

    expect(requestCount).toBeLessThan(50);
  });

  test('logout works correctly', async ({ page }) => {
    // Login first
    await page.goto('/login');
    await page.fill('input[type="email"]', EMPLOYER_CREDENTIALS.email);
    await page.fill('input[type="password"]', EMPLOYER_CREDENTIALS.password);
    await page.click('button[type="submit"]');
    await expect(page).not.toHaveURL(/\/login/, { timeout: 15000 });

    // Find and click logout
    const logoutButton = page.locator('button:has-text("Logout"), button:has-text("Sign out"), a:has-text("Logout")').first();
    if (await logoutButton.isVisible({ timeout: 5000 }).catch(() => false)) {
      await logoutButton.click();
      await expect(page).toHaveURL(/\/login/);
    } else {
      // Logout via direct navigation if button not found
      await page.goto('/logout');
      await expect(page).toHaveURL(/\/login/);
    }
  });
});
```

Critical test: 401 infinite loop detection from research findings.
  </action>
  <verify>
    - npm run test:e2e:smoke -- --list shows auth tests
    - Tests include infinite loop detection
  </verify>
  <done>Auth smoke tests created with 401 loop detection</done>
</task>

<task type="auto">
  <name>Task 3: Create navigation smoke tests</name>
  <files>tests/e2e/smoke/navigation.spec.ts</files>
  <action>
Create tests/e2e/smoke/navigation.spec.ts:

```typescript
import { test, expect } from '../fixtures/auth.fixture';

test.describe('Navigation', { tag: '@smoke' }, () => {
  test('dashboard is accessible after login', async ({ authenticatedPage: page }) => {
    // After auth fixture login, should be on dashboard
    const dashboardIndicator = page.locator('text=/cases|dashboard|employer/i').first();
    await expect(dashboardIndicator).toBeVisible({ timeout: 10000 });
  });

  test('cases page is accessible', async ({ authenticatedPage: page }) => {
    await page.goto('/cases');
    await page.waitForLoadState('networkidle');

    // Should see cases heading or table
    const casesIndicator = page.locator('text=/cases|worker/i, table').first();
    await expect(casesIndicator).toBeVisible({ timeout: 10000 });
  });

  test('employer portal routes work', async ({ authenticatedPage: page }) => {
    // Test key employer routes don't 404
    const routes = [
      { path: '/', name: 'Home' },
      { path: '/cases', name: 'Cases' },
      { path: '/employer', name: 'Employer Dashboard' },
    ];

    for (const route of routes) {
      await page.goto(route.path);
      const response = await page.waitForResponse(resp => resp.url().includes(route.path) || resp.status() !== 0, { timeout: 5000 }).catch(() => null);

      // Should not be 404 or 500
      const content = await page.content();
      expect(content).not.toContain('404');
      expect(content).not.toContain('Not Found');
    }
  });

  test('sidebar/nav links are present', async ({ authenticatedPage: page }) => {
    // Look for common navigation elements
    const navLinks = page.locator('nav a, aside a, [role="navigation"] a');
    const count = await navLinks.count();

    // Should have at least a few nav links
    expect(count).toBeGreaterThan(0);
  });
});
```

Use authenticatedPage fixture from Plan 01 for logged-in state.
  </action>
  <verify>
    - npm run test:e2e:smoke -- --list shows navigation tests
    - Tests use auth fixture correctly
  </verify>
  <done>Navigation smoke tests created using auth fixture</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run test:e2e:smoke -- --list` shows all smoke tests
2. Tests are tagged with @smoke
3. `npm run test:e2e:smoke` runs all smoke tests (may require server running)
</verification>

<success_criteria>
- 3 smoke test files exist in tests/e2e/smoke/
- All tests tagged with @smoke
- Health checks verify server responds
- Auth tests include 401 infinite loop detection
- Navigation tests use auth fixture
</success_criteria>

<output>
After completion, create `.planning/phases/11-system-wide-testing/11-02-SUMMARY.md`
</output>
