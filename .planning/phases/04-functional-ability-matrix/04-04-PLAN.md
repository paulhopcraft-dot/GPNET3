---
phase: 04-functional-ability-matrix
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - client/src/components/rtw/FunctionalAbilityMatrix.tsx
  - client/src/components/rtw/DutySuitabilityRow.tsx
  - client/src/components/rtw/OverrideReasonDialog.tsx
autonomous: false

must_haves:
  truths:
    - "Matrix displays all duties with color-coded suitability"
    - "Each duty shows modification suggestions when applicable"
    - "Override button opens dialog for manual adjustment"
    - "Override requires reason input before submission"
    - "Manually overridden duties show indicator badge"
    - "Demand breakdown visible in expandable details"
  artifacts:
    - path: "client/src/components/rtw/FunctionalAbilityMatrix.tsx"
      provides: "Main matrix component fetching and displaying duties"
      min_lines: 60
    - path: "client/src/components/rtw/DutySuitabilityRow.tsx"
      provides: "Individual duty row with suitability display"
      min_lines: 50
    - path: "client/src/components/rtw/OverrideReasonDialog.tsx"
      provides: "Modal dialog for override submission"
      min_lines: 80
  key_links:
    - from: "client/src/components/rtw/FunctionalAbilityMatrix.tsx"
      to: "/api/functional-ability/matrix"
      via: "TanStack Query fetch"
      pattern: "useQuery.*functional-ability.*matrix"
    - from: "client/src/components/rtw/OverrideReasonDialog.tsx"
      to: "/api/functional-ability/override"
      via: "useMutation POST"
      pattern: "useMutation.*functional-ability.*override"
---

<objective>
Create the matrix UI component that displays suitability for all duties with color coding and override capability.

Purpose: FAM-08 requires a visual matrix display showing duties vs demand categories. FAM-09 requires override capability with UI for entering reasons. This plan delivers the complete user-facing interface.

Output: Three React components for matrix display, row display, and override dialog
</objective>

<execution_context>
@C:\Users\Paul\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Paul\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-functional-ability-matrix/04-RESEARCH.md

# Existing patterns and utilities
@client/src/lib/suitabilityUtils.ts (color/icon helpers from 04-02)
@client/src/lib/restrictionUtils.ts (existing pattern for display utilities)
@client/src/components/ui/card.tsx (shadcn Card)
@client/src/components/ui/badge.tsx (shadcn Badge)
@client/src/components/ui/button.tsx (shadcn Button)
@client/src/components/ui/dialog.tsx (shadcn Dialog)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FunctionalAbilityMatrix Component</name>
  <files>client/src/components/rtw/FunctionalAbilityMatrix.tsx</files>
  <action>
Create the main matrix component that fetches and displays suitability data.

**Props interface:**
```typescript
interface FunctionalAbilityMatrixProps {
  caseId: string;
  roleId: string;
  onOverrideSuccess?: () => void; // Callback when override completes
}
```

**Implementation:**

1. Use TanStack Query to fetch matrix data:
```typescript
const { data, isLoading, error, refetch } = useQuery({
  queryKey: ["functional-ability-matrix", caseId, roleId],
  queryFn: async () => {
    const response = await fetch(
      `/api/functional-ability/matrix?caseId=${caseId}&roleId=${roleId}`
    );
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message || "Failed to load matrix");
    }
    return response.json();
  },
  enabled: !!caseId && !!roleId,
});
```

2. Handle loading state with skeleton or spinner

3. Handle error state with error message

4. Handle empty state (no duties for role)

5. Show confidence warning if data.confidence < 0.8

6. Map over duties and render DutySuitabilityRow for each:
```tsx
<Card>
  <CardHeader>
    <CardTitle>Functional Ability Matrix</CardTitle>
    {data.data.warnings.length > 0 && (
      <div className="text-sm text-yellow-600">
        {data.data.warnings.map((w, i) => <p key={i}>{w}</p>)}
      </div>
    )}
  </CardHeader>
  <CardContent className="space-y-4">
    {data.data.duties.map(duty => (
      <DutySuitabilityRow
        key={duty.dutyId}
        duty={duty}
        onOverride={() => setOverrideTarget(duty)}
      />
    ))}
  </CardContent>
</Card>
```

7. State for override dialog:
```typescript
const [overrideTarget, setOverrideTarget] = useState<typeof data.data.duties[0] | null>(null);
```

8. Render OverrideReasonDialog when overrideTarget is set

Import: Card, CardHeader, CardTitle, CardContent from @/components/ui/card
Import: useQuery from @tanstack/react-query
  </action>
  <verify>
- `npm run build` passes
- Component renders with loading/error/data states
- TanStack Query hook configured correctly
  </verify>
  <done>
FunctionalAbilityMatrix component created with data fetching, loading/error states, duty list rendering, and override dialog state management.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DutySuitabilityRow Component</name>
  <files>client/src/components/rtw/DutySuitabilityRow.tsx</files>
  <action>
Create the individual duty row component with suitability display.

**Props interface:**
```typescript
interface DutySuitabilityRowProps {
  duty: {
    dutyId: string;
    dutyName: string;
    dutyDescription: string | null;
    suitability: SuitabilityLevel;
    reasons: string[];
    modificationSuggestions: string[];
    isModifiable: boolean;
    manuallyOverridden?: boolean;
    demandDetails: Array<{
      demand: string;
      frequency: string;
      capability: string;
      match: SuitabilityLevel;
    }>;
  };
  onOverride: () => void;
}
```

**Implementation:**

1. Use getSuitabilityBgColor for row background
2. Use getSuitabilityIcon with Lucide icons (Check, AlertTriangle, X)
3. Display duty name with icon
4. Show "Manually Adjusted" Badge if manuallyOverridden
5. Display suitability status with formatSuitability
6. Show modification suggestions in bulleted list (when applicable)
7. Expandable details section using HTML `<details>` element:
```tsx
<details className="mt-2">
  <summary className="text-sm cursor-pointer hover:underline">
    View demand breakdown ({duty.demandDetails.length} demands)
  </summary>
  <div className="mt-2 grid grid-cols-3 gap-2 text-xs">
    {duty.demandDetails.map(detail => (
      <div key={detail.demand} className="flex items-center gap-1">
        <span className={getSuitabilityColor(detail.match)}>
          {getSuitabilityIcon(detail.match) === "check" ? <Check className="w-3 h-3" /> :
           getSuitabilityIcon(detail.match) === "alert-triangle" ? <AlertTriangle className="w-3 h-3" /> :
           <X className="w-3 h-3" />}
        </span>
        <span>{detail.demand}</span>
      </div>
    ))}
  </div>
</details>
```

8. Override button:
```tsx
<Button variant="outline" size="sm" onClick={onOverride}>
  Override
</Button>
```

Import icons from lucide-react: Check, AlertTriangle, X
Import helpers from @/lib/suitabilityUtils
Import Badge from @/components/ui/badge
Import Button from @/components/ui/button
  </action>
  <verify>
- `npm run build` passes
- Component renders suitability with correct colors
- Demand details expandable
- Override button triggers callback
  </verify>
  <done>
DutySuitabilityRow component created with color-coded display, modification suggestions, expandable demand details, and override button.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create OverrideReasonDialog Component</name>
  <files>client/src/components/rtw/OverrideReasonDialog.tsx</files>
  <action>
Create the modal dialog for submitting suitability overrides.

**Props interface:**
```typescript
interface OverrideReasonDialogProps {
  open: boolean;
  onClose: () => void;
  planDutyId: string;
  dutyName: string;
  currentSuitability: SuitabilityLevel;
  onSuccess: () => void;
}
```

**Implementation:**

1. Local state for form fields:
```typescript
const [newSuitability, setNewSuitability] = useState<SuitabilityLevel>(currentSuitability);
const [reason, setReason] = useState("");
const [modificationNotes, setModificationNotes] = useState("");
```

2. useMutation for override submission:
```typescript
const overrideMutation = useMutation({
  mutationFn: async () => {
    const response = await fetch("/api/functional-ability/override", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        planDutyId,
        newSuitability,
        reason,
        modificationNotes: modificationNotes || undefined,
      }),
    });
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message || "Override failed");
    }
    return response.json();
  },
  onSuccess: () => {
    toast({ title: "Override recorded", description: `${dutyName} suitability adjusted` });
    onSuccess();
    onClose();
  },
  onError: (error: Error) => {
    toast({ title: "Override failed", description: error.message, variant: "destructive" });
  },
});
```

3. Form validation before submit:
```typescript
const handleSubmit = () => {
  if (reason.length < 10) {
    toast({
      title: "Reason required",
      description: "Please provide at least 10 characters",
      variant: "destructive"
    });
    return;
  }
  overrideMutation.mutate();
};
```

4. Dialog UI using shadcn Dialog:
- DialogHeader with title "Override Suitability Assessment"
- DialogDescription with duty name
- Current assessment display
- RadioGroup for new suitability selection (suitable, suitable_with_modification, not_suitable)
- Textarea for reason (required, min 10 chars, show character count)
- Conditional Textarea for modificationNotes (shown when suitable_with_modification selected)
- DialogFooter with Cancel and Save Override buttons
- Save button disabled when isPending or reason.length < 10

Import: Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter from @/components/ui/dialog
Import: Button from @/components/ui/button
Import: Label from @/components/ui/label
Import: Textarea from @/components/ui/textarea
Import: RadioGroup, RadioGroupItem from @/components/ui/radio-group
Import: useMutation, useQueryClient from @tanstack/react-query
Import: useToast from @/hooks/use-toast
  </action>
  <verify>
- `npm run build` passes
- Dialog renders with all form fields
- Validation prevents short reasons
- Mutation triggers on submit
  </verify>
  <done>
OverrideReasonDialog component created with form validation, suitability selection, reason input, and mutation submission.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Functional Ability Matrix UI with:
    - Main matrix component displaying all duties with suitability
    - Color-coded rows (green/yellow/red)
    - Modification suggestions displayed for applicable duties
    - Expandable demand breakdown for each duty
    - Override dialog with reason input and validation
  </what-built>
  <how-to-verify>
    1. Start the development server: `npm run dev`
    2. Navigate to a case that has an RTW plan (or will need one created first for testing)
    3. Select a role that has duties defined
    4. Verify the matrix displays:
       - Duties with color-coded suitability (green/yellow/red backgrounds)
       - "Suitable", "Suitable with Modification", or "Not Suitable" labels
       - Modification suggestions shown for yellow/red items
       - Expandable demand details
    5. Click "Override" on any duty
    6. Verify the dialog:
       - Shows current suitability
       - Has radio buttons for new suitability
       - Textarea for reason with character counter
       - Cannot submit with reason < 10 characters
       - Submit shows success toast
    7. After override, duty should show "Manually Adjusted" badge
  </how-to-verify>
  <resume-signal>Type "approved" if matrix displays correctly with override functionality, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` passes for client
2. Matrix fetches data from API and displays
3. Color coding matches suitability levels
4. Override dialog validates reason length
5. Override submission updates display
6. Manually overridden duties show indicator
</verification>

<success_criteria>
- Matrix view shows all duties with visual suitability indicators
- Green/yellow/red color scheme consistent
- Modification suggestions visible and actionable
- Override workflow complete with validation
- Demand breakdown accessible via expand
- User verification confirms visual correctness
</success_criteria>

<output>
After completion, create `.planning/phases/04-functional-ability-matrix/04-04-SUMMARY.md`
</output>
