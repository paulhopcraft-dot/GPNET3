---
phase: 04-functional-ability-matrix
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - server/routes/functionalAbility.ts
  - server/routes.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/functional-ability/override updates suitability with audit trail"
    - "Override requires reason of at least 10 characters"
    - "Override is logged to auditEvents table"
    - "Only admin and clinician roles can override"
    - "Original suitability preserved in audit log"
  artifacts:
    - path: "server/routes/functionalAbility.ts"
      provides: "Override API endpoint"
      contains: "router.post"
    - path: "server/routes.ts"
      provides: "Router mount point"
      contains: "functional-ability"
  key_links:
    - from: "server/routes/functionalAbility.ts"
      to: "server/storage.ts"
      via: "database updates and audit logging"
      pattern: "storage\\.db|auditEvents"
---

<objective>
Create the manual override API endpoint that allows authorized users to adjust calculated suitability with audit logging.

Purpose: FAM-09 requires manual override capability with logged reasons. This supports clinical judgment overriding algorithmic decisions while maintaining compliance through audit trails.

Output: POST /api/functional-ability/override endpoint with validation and audit logging
</objective>

<execution_context>
@C:\Users\Paul\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Paul\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-functional-ability-matrix/04-RESEARCH.md

# Existing patterns
@server/routes/restrictions.ts (existing API pattern)
@shared/schema.ts (rtwPlanDuties table with override fields, auditEvents table)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Override API Endpoint</name>
  <files>server/routes/functionalAbility.ts</files>
  <action>
Add POST /override endpoint to the functionalAbility router.

**Zod Schema for validation:**
```typescript
import { z } from "zod";

const overrideSchema = z.object({
  planDutyId: z.string().uuid(),
  newSuitability: z.enum(["suitable", "suitable_with_modification", "not_suitable"]),
  reason: z.string().min(10, "Override reason must be at least 10 characters"),
  modificationNotes: z.string().optional(),
});
```

**Implementation:**

1. Parse and validate request body with overrideSchema
2. Get userId from req.user
3. Query original plan duty to get current suitability:
```typescript
const [planDuty] = await storage.db
  .select()
  .from(rtwPlanDuties)
  .where(eq(rtwPlanDuties.id, override.planDutyId));

if (!planDuty) {
  return res.status(404).json({ error: "Plan duty not found" });
}

const originalSuitability = planDuty.suitability;
```

4. Update plan duty with override:
```typescript
await storage.db
  .update(rtwPlanDuties)
  .set({
    suitability: override.newSuitability,
    manuallyOverridden: true,
    overrideReason: override.reason,
    overriddenBy: userId,
    modificationNotes: override.modificationNotes || planDuty.modificationNotes,
  })
  .where(eq(rtwPlanDuties.id, override.planDutyId));
```

5. Log to audit events:
```typescript
await storage.db.insert(auditEvents).values({
  eventType: "rtw_duty_override",
  userId,
  resourceType: "rtw_plan_duty",
  resourceId: override.planDutyId,
  metadata: {
    originalSuitability,
    newSuitability: override.newSuitability,
    reason: override.reason,
    timestamp: new Date().toISOString(),
  },
});
```

6. Return success response:
```typescript
res.json({
  success: true,
  message: "Suitability override recorded",
  data: {
    planDutyId: override.planDutyId,
    previousSuitability: originalSuitability,
    newSuitability: override.newSuitability,
  }
});
```

**Error handling:**
- Zod validation errors: 400 with details
- Plan duty not found: 404
- Database errors: 500 with generic message

Import rtwPlanDuties, auditEvents from @shared/schema.
Import eq from drizzle-orm.
  </action>
  <verify>
- `npm run build` passes
- Override endpoint exists in router
- Zod validation rejects reasons under 10 characters
  </verify>
  <done>
POST /api/functional-ability/override endpoint created with validation, database update, and audit logging.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Authorization Check</name>
  <files>server/routes/functionalAbility.ts</files>
  <action>
Ensure the override endpoint has proper role-based authorization.

The route should use authorize() middleware that's already applied at the router level in routes.ts.

Add explicit role check inside the handler:
```typescript
// At the start of the handler, after parsing body
const userRole = req.user?.role;
if (!userRole || !["admin", "clinician"].includes(userRole)) {
  return res.status(403).json({
    error: "Forbidden",
    message: "Only admin and clinician users can override suitability assessments"
  });
}
```

Note: Check the actual user object structure in this codebase - may be req.user.role or req.user.userRole depending on JWT payload. Use the existing pattern from other protected routes.
  </action>
  <verify>
- Role check exists in handler
- Non-admin/clinician users get 403
  </verify>
  <done>
Authorization check added to override endpoint, restricting to admin and clinician roles.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. POST /api/functional-ability/override accepts valid payload
3. Validation rejects short reasons (<10 chars)
4. Override updates rtwPlanDuties table
5. Audit event created in auditEvents table
6. Non-admin users get 403 Forbidden
</verification>

<success_criteria>
- Override API endpoint functional with proper validation
- Audit trail captures original suitability, new suitability, reason, user, timestamp
- Role-based access control enforced
- Zod schema provides clear validation error messages
</success_criteria>

<output>
After completion, create `.planning/phases/04-functional-ability-matrix/04-03-SUMMARY.md`
</output>
