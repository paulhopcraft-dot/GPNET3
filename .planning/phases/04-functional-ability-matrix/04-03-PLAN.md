---
phase: 04-functional-ability-matrix
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - client/src/components/rtw/FunctionalAbilityMatrix.tsx
  - client/src/components/rtw/DemandCategoryCell.tsx
autonomous: true

must_haves:
  truths:
    - "Matrix displays duties as ROWS with demand categories as COLUMNS (FAM-08 true matrix)"
    - "Each cell is color-coded: green (suitable), yellow (with modification), red (not suitable)"
    - "Table headers show all demand categories: Sitting, Standing, Walking, Bending, Squatting, Kneeling, Twisting, Reaching (OH), Reaching (Fwd), Lifting, Carrying, Repetitive, Concentration, Stress, Pace"
    - "Duty name in first column, suitability cells in remaining columns"
    - "Hovering a cell shows tooltip with frequency/capability details"
    - "Overall duty suitability shown in final column with appropriate styling"
  artifacts:
    - path: "client/src/components/rtw/FunctionalAbilityMatrix.tsx"
      provides: "True matrix table component with rows=duties, cols=demands"
      min_lines: 100
    - path: "client/src/components/rtw/DemandCategoryCell.tsx"
      provides: "Individual cell component with color and tooltip"
      min_lines: 40
  key_links:
    - from: "client/src/components/rtw/FunctionalAbilityMatrix.tsx"
      to: "/api/functional-ability/matrix"
      via: "TanStack Query fetch"
      pattern: "useQuery.*functional-ability.*matrix"
    - from: "client/src/components/rtw/FunctionalAbilityMatrix.tsx"
      to: "client/src/lib/suitabilityUtils.ts"
      via: "color utilities import"
      pattern: "import.*getSuitabilityBgColor"
---

<objective>
Create the TRUE matrix UI component that displays duties vs demand categories as a table grid with color-coded cells.

Purpose: FAM-08 requires a visual matrix display showing duties as ROWS and demand categories as COLUMNS. This is NOT a card-based list - it's a true matrix/grid visualization where each cell shows the suitability match for that duty+demand combination.

Output: Matrix table component with color-coded cells and tooltips

**DESIGN SPECIFICATION (FAM-08):**
```
| Duty         | Sit | Stand | Walk | Bend | ... | Lift | Carry | Overall |
|--------------|-----|-------|------|------|-----|------|-------|---------|
| Filing       | G   |   Y   |  G   |  G   | ... |  G   |   G   |   G     |
| Warehouse    | G   |   G   |  G   |  R   | ... |  R   |   R   |   R     |
| Reception    | Y   |   Y   |  G   |  G   | ... |  G   |   G   |   Y     |

G = Green (suitable)
Y = Yellow (suitable with modification)
R = Red (not suitable)
```

**NO OVERRIDE IN PHASE 4:**
Override functionality is deferred to Phase 8 (Approval Workflow) when RTW plan instances exist.
Phase 4 shows a suitability PREVIEW on duty templates.
</objective>

<execution_context>
@C:\Users\Paul\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Paul\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-functional-ability-matrix/04-RESEARCH.md
@.planning/phases/04-functional-ability-matrix/04-02-SUMMARY.md

# Existing patterns and utilities
@client/src/lib/suitabilityUtils.ts (color/icon helpers from 04-02)
@client/src/components/ui/table.tsx (shadcn Table)
@client/src/components/ui/tooltip.tsx (shadcn Tooltip)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DemandCategoryCell Component</name>
  <files>client/src/components/rtw/DemandCategoryCell.tsx</files>
  <action>
Create a small cell component that displays the suitability match for a single demand with color and tooltip.

**Props interface:**
```typescript
interface DemandCategoryCellProps {
  demand: string;
  frequency: string;
  capability: string;
  match: SuitabilityLevel;
}
```

**Implementation:**
1. Use getSuitabilityBgColor() for cell background
2. Display a small icon or colored dot in the cell
3. Wrap in Tooltip from shadcn/ui:
   - Tooltip content shows:
     - Demand name
     - Duty requires: {frequency}
     - Worker capability: {capability}
     - Result: {formatSuitability(match)}

```tsx
<TooltipProvider>
  <Tooltip>
    <TooltipTrigger asChild>
      <td className={cn(
        "w-10 h-10 text-center border",
        getSuitabilityBgColor(match)
      )}>
        {match === "suitable" && <Check className="w-4 h-4 mx-auto text-green-600" />}
        {match === "suitable_with_modification" && <AlertTriangle className="w-4 h-4 mx-auto text-yellow-600" />}
        {match === "not_suitable" && <X className="w-4 h-4 mx-auto text-red-600" />}
      </td>
    </TooltipTrigger>
    <TooltipContent>
      <div className="text-xs space-y-1">
        <div className="font-medium">{demand}</div>
        <div>Duty requires: {frequency}</div>
        <div>Worker: {capability}</div>
        <div className={getSuitabilityColor(match)}>
          {formatSuitability(match)}
        </div>
      </div>
    </TooltipContent>
  </Tooltip>
</TooltipProvider>
```

Import: Tooltip, TooltipContent, TooltipProvider, TooltipTrigger from @/components/ui/tooltip
Import: Check, AlertTriangle, X from lucide-react
Import: getSuitabilityBgColor, getSuitabilityColor, formatSuitability from @/lib/suitabilityUtils
  </action>
  <verify>
- `npm run build` passes
- Component renders colored cell with tooltip
  </verify>
  <done>
DemandCategoryCell component created with color-coded background and tooltip showing demand details.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FunctionalAbilityMatrix Table Component</name>
  <files>client/src/components/rtw/FunctionalAbilityMatrix.tsx</files>
  <action>
Create the main matrix component as a TRUE TABLE with duties as rows and demand categories as columns.

**Props interface:**
```typescript
interface FunctionalAbilityMatrixProps {
  caseId: string;
  roleId: string;
}
```

**Demand category columns (in order):**
```typescript
const DEMAND_COLUMNS = [
  { key: "Sitting", label: "Sit" },
  { key: "Standing", label: "Stand" },
  { key: "Walking", label: "Walk" },
  { key: "Bending", label: "Bend" },
  { key: "Squatting", label: "Squat" },
  { key: "Kneeling", label: "Kneel" },
  { key: "Twisting", label: "Twist" },
  { key: "Reaching Overhead", label: "OH" },
  { key: "Reaching Forward", label: "Fwd" },
  { key: "Lifting", label: "Lift" },
  { key: "Carrying", label: "Carry" },
  { key: "Repetitive Movements", label: "Rep" },
  { key: "Concentration", label: "Conc" },
  { key: "Stress Tolerance", label: "Stress" },
  { key: "Work Pace", label: "Pace" },
];
```

**Implementation:**

1. Fetch matrix data with TanStack Query:
```typescript
const { data, isLoading, error } = useQuery({
  queryKey: ["functional-ability-matrix", caseId, roleId],
  queryFn: async () => {
    const response = await fetch(
      `/api/functional-ability/matrix?caseId=${caseId}&roleId=${roleId}`
    );
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message || "Failed to load matrix");
    }
    return response.json();
  },
  enabled: !!caseId && !!roleId,
});
```

2. Handle loading/error/empty states

3. Build helper to find demand detail:
```typescript
function getDemandDetail(
  demandDetails: Array<{demand: string; frequency: string; capability: string; match: SuitabilityLevel}>,
  demandKey: string
) {
  return demandDetails.find(d => d.demand === demandKey) || {
    demand: demandKey,
    frequency: "never",
    capability: "not_assessed",
    match: "suitable" as SuitabilityLevel
  };
}
```

4. Render as Table:
```tsx
<Card>
  <CardHeader>
    <CardTitle>Functional Ability Matrix</CardTitle>
    <CardDescription>
      Suitability preview for duty templates. Color key:
      <span className="text-green-600 ml-2">Green=Suitable</span>
      <span className="text-yellow-600 ml-2">Yellow=With Modification</span>
      <span className="text-red-600 ml-2">Red=Not Suitable</span>
    </CardDescription>
    {data?.data?.warnings?.length > 0 && (
      <Alert variant="warning">
        <AlertTriangle className="h-4 w-4" />
        <AlertDescription>
          {data.data.warnings.map((w, i) => <div key={i}>{w}</div>)}
        </AlertDescription>
      </Alert>
    )}
  </CardHeader>
  <CardContent>
    <div className="overflow-x-auto">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead className="sticky left-0 bg-white z-10">Duty</TableHead>
            {DEMAND_COLUMNS.map(col => (
              <TableHead key={col.key} className="text-center text-xs px-1 w-12">
                {col.label}
              </TableHead>
            ))}
            <TableHead className="text-center">Overall</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {data?.data?.duties?.map(duty => (
            <TableRow key={duty.dutyId}>
              <TableCell className="sticky left-0 bg-white z-10 font-medium">
                {duty.dutyName}
              </TableCell>
              {DEMAND_COLUMNS.map(col => {
                const detail = getDemandDetail(duty.demandDetails, col.key);
                return (
                  <DemandCategoryCell
                    key={col.key}
                    demand={detail.demand}
                    frequency={detail.frequency}
                    capability={detail.capability}
                    match={detail.match}
                  />
                );
              })}
              <TableCell className={cn(
                "text-center font-medium",
                getSuitabilityBgColor(duty.suitability)
              )}>
                {formatSuitability(duty.suitability)}
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  </CardContent>
</Card>
```

5. Make table horizontally scrollable for small screens with `overflow-x-auto`

6. Sticky first column (duty name) so it remains visible while scrolling

Import: Table, TableBody, TableCell, TableHead, TableHeader, TableRow from @/components/ui/table
Import: Card, CardContent, CardDescription, CardHeader, CardTitle from @/components/ui/card
Import: Alert, AlertDescription from @/components/ui/alert
Import: useQuery from @tanstack/react-query
Import: DemandCategoryCell from ./DemandCategoryCell
  </action>
  <verify>
- `npm run build` passes
- Component renders as a table with rows=duties, columns=demands
- Cells are color-coded
- Table scrolls horizontally on small screens
  </verify>
  <done>
FunctionalAbilityMatrix component created as TRUE matrix table with duties as rows, demand categories as columns, color-coded cells with tooltips, and sticky first column.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes for client
2. Matrix displays as TABLE with rows (duties) and columns (demand categories)
3. Each cell is color-coded (green/yellow/red)
4. Tooltips show demand details on hover
5. Overall suitability shown in final column
6. Table scrolls horizontally on narrow screens
7. Sticky first column keeps duty name visible
</verification>

<success_criteria>
- TRUE matrix visualization: duties as rows, demand categories as columns (FAM-08)
- Color-coded cells with consistent green/yellow/red scheme
- Tooltips provide detail on hover without cluttering the view
- Responsive horizontal scroll for mobile/narrow screens
- NO override button (deferred to Phase 8)
- Clean, scannable visualization of suitability across all duties
</success_criteria>

<output>
After completion, create `.planning/phases/04-functional-ability-matrix/04-03-SUMMARY.md`
</output>
