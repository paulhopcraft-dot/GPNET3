---
phase: 04-functional-ability-matrix
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - server/routes/functionalAbility.ts
  - server/routes.ts
  - client/src/lib/suitabilityUtils.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/functional-ability/matrix returns suitability for all duty TEMPLATES in a role"
    - "API requires caseId and roleId query parameters"
    - "API returns 404 if no current restrictions found"
    - "Response includes dutyId (template ID), NOT planDutyId (Phase 4 operates on templates)"
    - "Response includes duty-level breakdown with demandDetails"
    - "Suitability colors map: suitable=green, with_modification=yellow, not_suitable=red"
  artifacts:
    - path: "server/routes/functionalAbility.ts"
      provides: "Matrix calculation API endpoint for duty templates"
      exports: ["default (router)"]
    - path: "client/src/lib/suitabilityUtils.ts"
      provides: "Color and label utilities for suitability display"
      exports: ["getSuitabilityColor", "getSuitabilityBgColor", "formatSuitability"]
  key_links:
    - from: "server/routes/functionalAbility.ts"
      to: "server/services/functionalAbilityCalculator.ts"
      via: "import calculateDutySuitability"
      pattern: "import.*calculateDutySuitability"
    - from: "server/routes/functionalAbility.ts"
      to: "server/storage.ts"
      via: "getCurrentRestrictions, duty queries"
      pattern: "storage\\.getCurrentRestrictions|storage\\.db"
    - from: "server/routes.ts"
      to: "server/routes/functionalAbility.ts"
      via: "router mount"
      pattern: "app\\.use.*functional-ability"
---

<objective>
Create the API endpoint for calculating the functional ability matrix on duty TEMPLATES (not plan instances) and client-side utilities for displaying suitability.

Purpose: Bridge between the calculation services and the UI - provide a clean API contract and display helpers. Phase 4 operates on duty TEMPLATES for suitability preview BEFORE an RTW plan exists.

Output: API route at /api/functional-ability/matrix, suitability display utilities

**IMPORTANT ARCHITECTURE NOTE:**
Phase 4 calculates suitability on duty TEMPLATES (rtwDuties table) for preview purposes.
Override functionality requires plan INSTANCES (rtwPlanDuties table) which are created in Phase 5.
Override API is deferred to Phase 8 (Approval Workflow) when plan instances exist.
</objective>

<execution_context>
@C:\Users\Paul\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Paul\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-functional-ability-matrix/04-RESEARCH.md

# Existing patterns
@server/routes/restrictions.ts (existing API pattern for restrictions)
@server/storage.ts (getCurrentRestrictions method)
@client/src/lib/restrictionUtils.ts (existing color/label utilities pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Functional Ability API Route</name>
  <files>server/routes/functionalAbility.ts, server/routes.ts</files>
  <action>
Create new route file at `server/routes/functionalAbility.ts`:

**GET /api/functional-ability/matrix**
Query params: `caseId`, `roleId`

Implementation:
1. Extract caseId, roleId from query params
2. Get organizationId from req.user
3. Call `storage.getCurrentRestrictions(caseId, organizationId)` - return 404 if null
4. Query duties (TEMPLATES) for role:
```typescript
const duties = await storage.db
  .select({ duty: rtwDuties, demands: rtwDutyDemands })
  .from(rtwDuties)
  .leftJoin(rtwDutyDemands, eq(rtwDuties.id, rtwDutyDemands.dutyId))
  .where(and(
    eq(rtwDuties.roleId, roleId),
    eq(rtwDuties.organizationId, organizationId),
    eq(rtwDuties.isActive, true)
  ));
```
5. For each duty, call `calculateDutySuitability()` and `generateModificationSuggestions()`
6. Return response with **dutyId** (template ID, NOT planDutyId):
```typescript
{
  success: true,
  data: {
    caseId,
    roleId,
    calculatedAt: new Date().toISOString(),
    confidence: number, // minimum confidence across duties
    warnings: string[], // aggregated warnings
    // NOTE: This is a suitability PREVIEW on templates
    // Override requires plan instances (created in Phase 5, managed in Phase 8)
    duties: Array<{
      dutyId: string;  // Template ID from rtwDuties table
      dutyName: string;
      dutyDescription: string | null;
      suitability: SuitabilityLevel;
      reasons: string[];
      modificationSuggestions: string[];
      isModifiable: boolean;
      demandDetails: Array<{
        demand: string;
        frequency: DemandFrequency;
        capability: RestrictionCapability;
        match: SuitabilityLevel;
      }>;
    }>;
  }
}
```

**Add to server/routes.ts:**
```typescript
import functionalAbilityRouter from "./routes/functionalAbility";
// ... later in setup
app.use("/api/functional-ability", authorize(), functionalAbilityRouter);
```

Use authorize() middleware (already imported in routes.ts).
Import: eq, and from drizzle-orm, rtwDuties, rtwDutyDemands from @shared/schema.
  </action>
  <verify>
- `npm run build` passes
- API endpoint accessible at /api/functional-ability/matrix
- Verify with curl or Postman (manual test after server restart)
  </verify>
  <done>
API endpoint created, mounted in routes.ts, returns matrix data with suitability calculations for all duty TEMPLATES in role. Response uses dutyId (template ID) as this is a preview before plan creation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Suitability Display Utilities</name>
  <files>client/src/lib/suitabilityUtils.ts</files>
  <action>
Create client-side utilities for suitability display, following the pattern in restrictionUtils.ts.

**Types (import from @shared/schema if available, otherwise define locally):**
```typescript
export type SuitabilityLevel = "suitable" | "suitable_with_modification" | "not_suitable";
```

**Functions:**

1. `getSuitabilityColor(suitability: SuitabilityLevel): string`
   - suitable: "text-green-600"
   - suitable_with_modification: "text-yellow-600"
   - not_suitable: "text-red-600"

2. `getSuitabilityBgColor(suitability: SuitabilityLevel): string`
   - suitable: "bg-green-50 border-green-200"
   - suitable_with_modification: "bg-yellow-50 border-yellow-200"
   - not_suitable: "bg-red-50 border-red-200"

3. `getSuitabilityIcon(suitability: SuitabilityLevel): string`
   - suitable: "check" (Lucide icon name)
   - suitable_with_modification: "alert-triangle"
   - not_suitable: "x"

4. `formatSuitability(suitability: SuitabilityLevel): string`
   - suitable: "Suitable"
   - suitable_with_modification: "Suitable with Modification"
   - not_suitable: "Not Suitable"

5. `getSuitabilityBadgeVariant(suitability: SuitabilityLevel): "default" | "secondary" | "destructive"`
   - suitable: "default" (green in shadcn)
   - suitable_with_modification: "secondary" (yellow/amber)
   - not_suitable: "destructive" (red)

Include JSDoc comments for each function.
  </action>
  <verify>
- `npm run build` passes
- File exports all utility functions
- No TypeScript errors in client build
  </verify>
  <done>
suitabilityUtils.ts created with color, icon, label, and badge variant helpers for all three suitability levels.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes for both server and client
2. API endpoint returns expected JSON structure with dutyId (not planDutyId)
3. suitabilityUtils exports all required functions
4. API returns 404 with helpful message when no restrictions found
5. API handles missing demands gracefully (treats as "never" frequency)
</verification>

<success_criteria>
- GET /api/functional-ability/matrix?caseId=X&roleId=Y returns suitability matrix for duty templates
- Response uses dutyId (template ID) - this is a preview before plan creation
- Response includes demandDetails for drill-down
- Client utilities provide consistent color coding (green/yellow/red)
- API integrates with existing authorize() middleware
- NO override endpoint in this plan (deferred to Phase 8)
</success_criteria>

<output>
After completion, create `.planning/phases/04-functional-ability-matrix/04-02-SUMMARY.md`
</output>
