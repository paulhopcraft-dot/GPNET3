## Session 96 (continued, part 2) - 1 Mar 2026

### Completed
- **Health check notification cron** (`cccb485`) — `generateHealthCheckNotifications()` in notificationService.ts
  - Fires hourly for overdue/due_soon workers (≤60 days until next check)
  - Dedupe key: `health_check:{workerId}:{YYYY-MM}:{urgency}` — one per cycle per urgency
  - Enable with `ENABLE_NOTIFICATIONS=true` in .env
- **Dr. Alex worker context** (`cccb485`) — chat.ts + PageLayout.tsx
  - `/workers/:id` URL → workerId extracted, passed to ChatWidget
  - Dr. Alex loads worker profile, clearance level, daysUntil next check
  - Overdue → proactively raises check + fires SUGGEST_BOOKING
  - Due soon → mentions upcoming date, offers to help book
- **Visual check history timeline** — WorkerProfile.tsx rewrite
  - Vertical timeline: each completed check as dated node, colour-coded by clearance
  - Each node: position, clearance badge, projected next-check date arrow
  - Future node: overdue = red "Schedule Now" CTA; due_soon = amber "Book Now"; upcoming = muted
  - Aggressive overdue banner: days overdue count + employer liability language
  - Due-soon banner: days remaining + "checks take 1–2 weeks" urgency
  - Stat strip at top: total checks / current clearance / next check date

### Next Steps
1. **Export** — CSV/PDF of workers + check status for employer reporting
2. **Assessment create pre-filled for worker** — /assessments/new?workerId=X pre-fills name/email
3. **Recovery timeline** (for injury cases) — parallel to check timeline on case pages

## Session 96 (continued) - 1 Mar 2026

### Completed (continuation)
- **Next-check recommendation engine** (`05cdd5f`) — `computeNextCheckDue()` in workers.ts
  - 12m: cleared_unconditional, cleared_conditional
  - 6m: cleared_with_restrictions (Rachel O'Brien → due 2026-09-01 ✓)
  - N/A: not_cleared, requires_review
  - recheckUrgency: overdue | due_soon | upcoming | not_applicable | pending
- **Workers list enriched** — `/api/workers` now returns latestClearanceLevel, nextCheckDue, recheckUrgency per worker
- **Assessments list** — now includes workerId (accessToken withheld from list)
- **WorkerProfile.tsx enhanced** — RecheckBanner (green/amber/red), clearance badges, last completed date, "New Check" button
- **ChecksPage.tsx** — assessment rows link to /workers/:workerId; "Attention Required" panel for overdue/due-soon
- **WorkersListPage at /workers-list** (`ae6bfdc`) — searchable table, clearance badges, urgency filter, alert bar
- **Sidebar nav** — "Health Checks" → /checks and "Workers" → /workers-list

### Next Steps
1. **Proactive AI suggestions in chat** — Dr. Alex aware of worker's check history, proactively suggests checks when case opened
2. **Recovery timeline** — show check history timeline on worker profile
3. **Notification cron** — daily run flags workers whose nextCheckDue < 60 days, creates notifications
4. **Export** — CSV/PDF export of workers with check status for employer reporting

---

## Session 96 - 1 Mar 2026

### Completed
- **ChecksPage assessment list UI** (`776d6dd`) — pre-employment tab wired to `/api/assessments`
  - Real stat cards: Total / Awaiting Response / Completed / Cleared for Work
  - Live assessment list with candidateName, positionTitle, sentAt date, status badge, clearanceLevel badge
  - Badge colors: unconditional=green, conditional=teal, with_restrictions=orange, not_cleared=red, requires_review=yellow
- **Badge + stat bug fixes** (`4e24662`) — cleared_with_restrictions badge ordering fixed; cleared stat now includes all CLEARED_* variants

### Tested End-to-End (10 real assessments in DB)
| Candidate | Role | Clearance |
|---|---|---|
| Marcus Webb | Forklift Operator | cleared_unconditional ✓ |
| Derek Huang | Crane Operator | not_cleared (epilepsy + seizures) ✓ |
| Priya Sharma | Admin Officer | cleared_conditional (diabetes) ✓ |
| Rachel O'Brien | Delivery Driver | cleared_with_restrictions (knee OA) ✓ |

### Edge Cases Verified
- Double submit → 410 ✓
- Invalid token → 404 ✓
- Missing responses → 400 ✓
- AI report generates in ~6s ✓

### Next Steps
1. **Worker profile page** — verify /workers/:id loads with real assessment + booking data
2. **Assessment send fix** — CSRF not included on send button in NewAssessmentPage (needs fetch with csrfToken header for non-browser-form POST)
3. **Browser test** — open http://localhost:5173, log in, create + send assessment via UI

---

## Session 95 - 1 Mar 2026

### Completed
- **Telehealth Platform — fully built and committed** (`1c220a6`)
- **Normalized `workers` table** — FK target for cases, assessments, and bookings; `upsertWorkerByEmail()` used at assessment create
- **`telehealthBookings` table** — service_type, appointment_type, status, notes, referral flag
- **`caseDocuments` table** — links docs to cases/workers with source and extractedData JSONB
- **`workerId` FK on `workerCases`** — links existing cases to normalized worker records
- **`preEmploymentAssessments` extended** — added `workerId`, `accessToken`, `jobDescription`, `questionnaireResponses`, `sentAt`, `employerNotifiedAt`, `reportJson`, `alertSent`
- **Workers API** (`server/routes/workers.ts`) — GET list, GET/:id profile, POST upsert
- **Bookings API** (`server/routes/bookings.ts`) — GET list, POST create, PATCH status
- **Assessments API** (`server/routes/assessments.ts`) — POST create (upserts worker, generates token), POST/:id/send (emails magic link), GET list, GET/:id
- **Public routes** (`server/routes/public.ts`) — no-auth GET/POST `/api/public/check/:token` for magic link questionnaire
- **Chat API** (`server/routes/chat.ts`) — unified Dr. Alex endpoint, loads soul from `config/DR_ALEX_SOUL.md`, optional case context, SUGGEST_BOOKING signal
- **`config/DR_ALEX_SOUL.md`** — Dr. Alex persona (GP-style, warm, triage-aware); edit file + restart server to update
- **`ChatWidget.tsx`** — floating "Talk with a Doctor" FAB bottom-right, all authenticated pages; lazy-imports BookingModal
- **`BookingModal.tsx`** — context-aware booking form (auto-fills on case pages, manual elsewhere); 5 service types, video/f2f
- **`PublicQuestionnaire.tsx`** — no-auth `/check/:token` page; 8-step questionnaire, handles invalid/expired tokens
- **`WorkerProfile.tsx`** — `/workers/:id` full worker history: assessments, cases, bookings
- **`reportGenerator.ts`** — Claude Haiku generates structured clearance report; auto-emails employer (CLEARED) or alerts jacinta@preventli.ai (REQUIRES_REVIEW/NOT_CLEARED)
- **`PageLayout.tsx`** — added "Book Telehealth" header button + ChatWidget on all pages
- **App.tsx** — added `/check/:token` public route and `/workers/:id` protected route
- **Removed `caseChat.ts`** — consolidated into unified chat widget
- **features.json + domain_memory.json updated** — F025–F030 marked complete

### Blockers
- **`npm run db:push` still needed** — new tables (workers, telehealthBookings, caseDocuments) and preEmploymentAssessments columns not yet applied
  - Start PostgreSQL: `sudo service postgresql start`
  - Then: `cd /mnt/d/dev/gpnet3 && npm run db:push`

### Completed (Session 95 — full end-to-end verified)
- **Assessment create form** (`d5032d2`) — `NewAssessmentPage.tsx` at `/assessments/new`; `PreEmploymentForm.tsx` restored intact
- **sentAt fix** — `updatePreEmploymentAssessmentStatus` now accepts `sentAt?: Date`; stamped on send
- **db:push succeeded** (`880d288`) — all new tables and columns live in PostgreSQL
- **JSON parse fix** — strip backtick code fences from AI response before JSON.parse (clearance was always requires_review)
- **CSRF exemption** — `/api/public/` added to shouldSkipCsrf() so magic-link submissions work
- **Dr. Alex booking triggers tuned** — now correctly fires SUGGEST_BOOKING for neuro symptoms, direct requests, worsening >3 days
- **End-to-end tested** (3 workers, full flow):
  - Emma Clarke (Forklift) → CLEARED ✓, employer email sent
  - Tom Whitfield (Office) → CLEARED ✓, employer email sent
  - Lisa Kowalski (Construction, epilepsy) → REQUIRES_REVIEW ✓, Jacinta alert with detailed flags
- **Chat tested** — Dr. Alex responds correctly, suggestBooking:true fires on nerve symptoms / direct booking request
- **Booking tested** — POST /api/bookings creates record, status:pending

### Next Steps
1. **Browser test** — open http://localhost:5173 (Vite frontend), log in, try the full flow in UI
2. **Assessment list UI** — show sent/completed/clearanceLevel on ChecksPage or PreEmploymentPage (currently backend only)
3. **Worker profile page** — verify /workers/:id loads with real assessment + booking data
4. **Page won't load issue** — user reported this; frontend is on port 5173, backend on 5000; Vite proxies /api to 5000

### Key Notes
- Dr. Alex soul: `config/DR_ALEX_SOUL.md` — edit file, restart server to apply (loaded once at startup)
- Magic link pattern: `crypto.randomBytes(32).toString('hex')` → `accessToken` on assessment
- AI persona model: `claude-haiku-4-5-20251001`
- `SUGGEST_BOOKING` stripped from AI reply text, returned as `suggestBooking: true` in JSON

---

## Session 91 - 26 Feb 2026

### Completed
- **Preventli Agentic System — fully built and committed** (`a98e26e`)
- **base-agent.ts** — Anthropic tool-use loop, persists every tool call to `agent_actions` table, 20-iteration safety limit
- **4 specialist agents**: coordinator (morning briefing), RTW (full workflow), recovery (watchdog/predictor), certificate (expiry + inbound)
- **8 tool modules** wrapping existing services: case, certificate, RTW, compliance, email, recovery, timeline, coordinator
- **agent-runner/triggers.ts** — AgentScheduler with cron (9am briefing, 8am cert expiry) following existing node-cron pattern
- **routes/agents.ts** — REST API: trigger, job status, action log, human-in-loop approve/reject
- **schema.ts** — Added `agent_jobs` and `agent_actions` tables
- **Human-in-loop tiers** — Tier 1 auto / Tier 2 approval queue / Tier 3 escalate-only

### Blockers
- **DB migration pending** — `agent_jobs` and `agent_actions` tables not yet pushed to DB
  - `npm run db:push` fails with ECONNREFUSED — local PostgreSQL not running
  - Fix: `sudo service postgresql start` then `npm run db:push`, OR update DATABASE_URL in .env to Neon connection string

### Key Storage Function Names (VERIFIED against storage.ts)
- `getCertificatesByCase(caseId, organizationId)` — 2 params, orgId required
- `getExpiringCertificates(organizationId, daysAhead)` — orgId FIRST
- `createAction(InsertCaseAction)` — not `createCaseAction`
- `getCaseContacts(caseId, organizationId)` — orgId required
- `generateEmailDraft(storage, caseId, organizationId, request)` — storage is first arg
- `sendEmail({to, subject, body, html?})` — no `toName` field
- `logAuditEvent(...)` from `services/auditLogger` — not `storage.createAuditEvent`

### RTW Plan Status Notes
- `rtwPlans.status` is document approval: `draft/pending/approved/rejected/modification_requested`
- NOT RTW workflow states — those live in `workerCases.clinicalStatusJson.rtwPlanStatus`

### Model Used (UPDATED — Session 91 end)
- Agents use **Claude CLI subprocess** (`claude -p "..."`) — Max plan OAuth, NO API KEY
- base-agent.ts: `execFile("claude", ["-p", prompt, "--output-format", "text"])`
- Each agent pre-gathers read context directly, passes only write tools to Claude CLI
- Claude returns JSON action plan → agent executes write actions
- Commit: `8d88476`

### Next Steps
1. **Run db:push** — start PostgreSQL and apply `agent_jobs` + `agent_actions` tables
2. **End-to-end test** — trigger coordinator agent manually via `POST /api/agents/briefing` with a demo org
3. **Agent action log UI** — client-side page showing plain-English reasoning per case (the demo "wow" moment)
4. **RTW PDF generator** — Paul to provide sample RTW plan documents for PDF template
5. **BullMQ queue** (Phase 4) — Redis + worker process for multi-tenant scale

### Worktrees (prunable, can ignore)
- feature/onboarding: /mnt/c/Dev/worktrees/onboarding
- Several Windows-path worktrees marked prunable

### Session 54 Notes (Previous)
---
## Session 54 - 19 Feb 2026

### Completed
- **WSL Clawdbot fully operational** — both Telegram (@Gomatego_bot) and Discord (@OpenClaw Bot) working
- **IPv6 crash fix** — WSL had IPv6 enabled but unreachable, causing Node.js fetch crashes. Disabled via sysctl + /etc/sysctl.conf + startup script
- **Migrated clawdbot config** — Ported from Windows (.clawdbot) + OpenClaw (.openclaw) configs to WSL .clawdbot/clawdbot.json
- **Discord token recovered** — Found in old .openclaw/openclaw.json, wired into .clawdbot config
- **Context pruning + compaction config** — Ported from openclaw: cache-ttl mode, memory flush, reserve tokens
- **Preventli-web agent** — Configured and bound to Discord channel
- **Session auto-reset** — 4 hour idle timeout configured
- **Unified memory review** — Full audit completed (see findings below)

### Unified Memory System Findings (CRITICAL)
The memory-unified plugin is **fully built** but **not wired into clawdbot**:
- **Plugin code**: /home/paul_clawdbot/dev/clawdbot/extensions/memory-unified/ (132K lines, 31 files)
- **Config missing**: .clawdbot/clawdbot.json has NO plugins.slots section, only memory-core enabled
- **What's needed**:
  1. Compile memory-unified TypeScript extension
  2. Add plugins.slots.memory = "memory-unified" to config
  3. Add memory-unified to plugin entries with full config
  4. Initialize databases in correct location
  5. Sync memory files to consistent workspace
- **Reference config**: .openclaw/openclaw.json has the correct wiring (plugins.slots.memory = "memory-unified")
- **Databases**: memory-search-fts5.db (9.8MB active), memory-unified-analytics.db (94.8MB), but .openclaw/*.db empty

### WSL Critical Fix (REMEMBER THIS)
- **IPv6 must be disabled in WSL** — causes clawdbot gateway crashes
- Fix: `sudo sysctl -w net.ipv6.conf.all.disable_ipv6=1`
- Persistent: Added to /etc/sysctl.conf and start-wsl-gateway.sh
- Symptoms: "connect ENETUNREACH 2001:67c:4e8:f004::9:443" + "TypeError: fetch failed"

### Known Issues
- **Telegram context overflow** — Bot accumulates too much context, hits "prompt too large" error. Needs proper context windowing via memory-unified
- **Bot self-restart crashes** — Config changes trigger SIGUSR1 restart → AbortError crash. commands.restart toggled between true/false during session
- **Discord channels unresolved** — Some configured channel IDs don't exist in guilds (stale config)

### Environment
- PRIMARY DEV: WSL Ubuntu-24.04 ONLY
- Code path: ~/dev/gpnet3 (/home/paul_clawdbot/dev/gpnet3)
- Clawdbot config: /home/paul_clawdbot/.clawdbot/clawdbot.json
- Old openclaw config: /home/paul_clawdbot/.openclaw/openclaw.json (reference for memory-unified)
- Clawdbot: port 18789 (auto-starts via tmux)
- Branch: main

### Next Session Priority
1. **Wire up unified memory to clawdbot** (use /gsd for structured execution)
   - Compile extension → install → wire config → init databases → verify
2. **Financial/Risk/Contacts tabs** — empty tabs despite data in Summary (HIGH)
3. **Onboarding Course** — RTW Coordinator workflow walkthrough
4. **Sales Platform spec** — Product spec for Andrew's Sales Performance & Accountability Platform received (saved in conversation, needs to be filed)

### Credentials
- Admin: admin@gpnet.local / ChangeMe123!
- Employer: employer@symmetry.local / ChangeMe123!
- Natalie: natalie@preventli.com / ChangeMe123!
