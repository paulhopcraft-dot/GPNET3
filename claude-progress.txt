# GPNet3 Progress Snapshot
**Date:** 2025-12-20
**Session:** Certificate Ingestion Engine Implemented
**Branch:** wip-gpnet-claims
**Latest Commit:** (pending commit)

## Completed This Session

### Certificate Ingestion Engine (FEATURE COMPLETE)
Implemented auto-extraction of medical certificate data from PDF/image attachments using Claude Vision.

**Pipeline Flow:**
```
Email+PDF → Freshdesk → Sync → Fetch Attachment → Claude Vision OCR → Store Certificate
```

**Key Components:**
1. **Freshdesk Attachment Fetching** (server/services/freshdesk.ts)
   - Updated fetchTickets() to include `?include=description,attachments`
   - Added FreshdeskAttachment interface

2. **PDF/Image Processor** (server/services/pdfProcessor.ts - NEW)
   - Downloads attachments from Freshdesk
   - Converts to base64 for Claude Vision
   - Filters for certificate file types (PDF, images)

3. **Claude Vision OCR** (server/services/certificateService.ts)
   - Uses claude-sonnet-4-20250514 for document analysis
   - Extracts: issue date, start/end dates, practitioner, capacity, restrictions
   - Confidence scoring (< 0.8 = requires review)

4. **Certificate Pipeline** (server/services/certificatePipeline.ts - NEW)
   - Orchestrates the full extraction flow
   - Creates certificate records with OCR data
   - Flags low-confidence extractions for review

5. **Freshdesk Sync Integration** (server/routes.ts)
   - Sync endpoint processes certificate attachments automatically
   - Controlled via `processCertificates` query param

6. **Review Queue UI** (client/src/pages/CertificateReviewPage.tsx - NEW)
   - Lists certificates with requiresReview=true
   - Displays extracted fields for verification
   - Allows manual correction and approval
   - Route: /certificates/review

**API Endpoints Added:**
- `GET /api/certificates/review-queue` - Get certificates needing review
- `POST /api/certificates/:id/review` - Mark as reviewed (existing)

## Feature Status
- Completed: 3/17 (initialize_harness, claims_intake_flow, certificate_ingestion_engine)
- Next: medical_flags_and_red_risk, return_to_work_planner

## Files Changed This Session
- server/services/freshdesk.ts - Added attachment fetching
- server/services/pdfProcessor.ts - NEW: PDF/image processing
- server/services/certificateService.ts - Claude Vision OCR implementation
- server/services/certificatePipeline.ts - NEW: Pipeline orchestration
- server/storage.ts - Added getCertificatesRequiringReview()
- server/routes.ts - Integrated certificate processing into sync
- server/routes/certificates.ts - Added review-queue endpoint
- client/src/pages/CertificateReviewPage.tsx - NEW: Review UI
- client/src/App.tsx - Added /certificates/review route
- factori/features.json - Updated certificate_ingestion_engine to pass

## Test Commands
```bash
npm run seed              # Re-seed multi-tenant data
npm run dev               # Dev server on port 5000
npm test                  # Run all tests
```

## Environment Variables Required
```
ANTHROPIC_API_KEY=sk-ant-...  # For Claude Vision OCR
FRESHDESK_DOMAIN=your-domain
FRESHDESK_API_KEY=your-key
```

## Login Credentials
| User | Email | Password | Role | Org |
|------|-------|----------|------|-----|
| Admin | admin@gpnet.local | ChangeMe123! | admin | all |
| Employer | employer@symmetry.local | ChangeMe123! | employer | org-alpha |
| Doctor | doctor@harborclinic.local | ChangeMe123! | clinician | org-beta |
