# Ralph Loop Command

## Metadata
```yaml
name: ralph-loop
description: Launch Ralph autonomous development loop
version: 1.0.0
category: ralph
requires_project: true
requires_validation: true
dangerous: false
```

## Purpose

Launches Ralph autonomous development system for overnight feature implementation.
Ralph executes user stories one by one with fresh Claude context per iteration,
verifying each implementation with browser automation.

## Usage

```bash
/ralph-loop [max_iterations]
```

**Arguments:**
- `max_iterations` (optional): Maximum iterations to run (default: 10)

## Prerequisites

### Required Before Execution:
1. **PRD Validation**: Must run `/prd-harden` first - Ralph checks for `.ralph-approved.json`
2. **Development Server**: Local dev server should be running (e.g., `npm run dev`)
3. **features.json**: Must exist with properly formatted user stories
4. **Git Repository**: Clean working directory (Ralph creates commits)

### Auto-Checked by Ralph:
- Browser testing dependencies (Puppeteer)
- Server connectivity at configured URL
- features.json format and content
- PRD approval file existence and age

## How Ralph Works

### Execution Flow:
1. **Pre-flight Checks** - Validates all requirements
2. **Iteration Loop** - One user story per iteration:
   - Spawns fresh Claude context
   - Reads assigned user story from features.json
   - Implements the story functionality
   - Verifies with browser automation
   - Updates features.json with results
   - Commits successful implementations
3. **Final Report** - Generates execution summary

### Browser Verification:
Ralph uses the dev-browser skill to verify implementations:
```bash
# Element verification
browser_verify: exists #login-form

# Text content verification
browser_verify: text .error-message contains 'Invalid email'

# Navigation verification
browser_verify: url-contains '/dashboard'

# Form interaction verification
browser_verify: fill #email-input 'test@example.com'
browser_verify: click #submit-button
```

## Safety Features

### Validation Gates:
- **No PRD approval** ‚Üí Ralph refuses to execute
- **No features.json** ‚Üí Guides to run `/prd-generator`
- **Server unreachable** ‚Üí Warns about dev server status
- **Dependencies missing** ‚Üí Attempts installation or fails safely

### Execution Safety:
- **Fresh context per iteration** - Prevents state accumulation
- **One story per iteration** - Maintains focus and determinism
- **Browser verification required** - Objective success criteria
- **Automatic rollback** - Undoes failed implementations
- **Git commits** - Preserves working states

### Error Handling:
- **Loud failures** - Clear error messages and debugging info
- **Automatic rollback** - Uses rollback procedures from features.json
- **Detailed logging** - All actions logged to `ralph/progress.txt`
- **Safe exit** - Graceful shutdown on unrecoverable errors

## Output Files

### Generated by Ralph:
- **`ralph/progress.txt`** - Detailed execution log
- **`.ralph-approved.json`** - PRD validation state (checked, not created)
- **Git commits** - One per successful user story
- **Screenshots** - Debug images in project root (as needed)

### Updated by Ralph:
- **`features.json`** - User story completion status

## Configuration

### Default Settings:
```json
"ralphConfig": {
  "maxIterations": 10,
  "serverUrl": "http://localhost:3000",
  "browserTimeout": 30000,
  "rollbackOnFailure": true,
  "commitEachStory": true
}
```

### Override in features.json:
```json
{
  "features": [...],
  "ralphConfig": {
    "maxIterations": 20,
    "serverUrl": "http://localhost:8080",
    "browserTimeout": 60000
  }
}
```

## Examples

### Basic Usage:
```bash
# Run with defaults (max 10 iterations)
/ralph-loop

# Run with custom max iterations
/ralph-loop 5
```

### Typical Workflow:
```bash
# 1. Generate PRD
/prd-generator "Add shopping cart functionality"

# 2. Validate PRD (mandatory)
/prd-harden

# 3. Start development server
npm run dev

# 4. Launch Ralph overnight
/ralph-loop
```

### Morning Review:
```bash
# Check execution results
cat ralph/progress.txt

# Review git history
git log --oneline

# See remaining work
jq '.features[]?.userStories[]? | select(.passes==false)' features.json
```

## Success Scenarios

### Complete Success:
```
[Ralph] üéâ ALL USER STORIES COMPLETE!
Feature implementation finished successfully.

Final Report:
- Stories Completed: 8/8
- Total Time: 127 minutes
- All browser verifications passed
```

### Partial Completion:
```
[Ralph] ‚è∏Ô∏è Execution stopped with 2 stories remaining
Check progress.txt for details on completed/failed stories.

Next Steps:
1. Review failed stories in features.json
2. Check browser verification issues
3. Run /ralph-loop again to continue
```

## Error Scenarios

### Common Errors and Solutions:

**"PRD not approved for Ralph execution"**
```bash
# Solution: Run PRD hardening first
/prd-harden
```

**"features.json not found"**
```bash
# Solution: Create PRD first
/prd-generator "Your feature description"
```

**"Cannot reach development server"**
```bash
# Solution: Start your dev server
npm run dev
# or
npm start
# or your project's dev command
```

**"Browser verification failed"**
- Check element selectors in your implementation
- Verify dev server is serving the correct pages
- Review screenshots in project directory
- Check `ralph/progress.txt` for detailed error info

## Integration with Toolkit

### Auto-Triggers:
- **Test before commit** - Ralph runs tests if configured
- **Progress tracking** - Updates `claude-progress.txt`
- **Status after completion** - Shows next recommended actions

### Related Commands:
- **`/prd-generator`** - Create initial PRD
- **`/prd-harden`** - Validate PRD (required before Ralph)
- **`/status`** - Check project status and Ralph results
- **`/review`** - Review Ralph's implementations
- **`/continue`** - Continue incomplete Ralph work manually

## Advanced Usage

### Custom Server URLs:
```bash
# For non-standard dev server ports
# Edit features.json ralphConfig.serverUrl before running
```

### Project-Specific Setup:
```bash
# Copy Ralph to specific projects
./copy-to-project.sh --project myproject
cd ../myproject
/ralph-loop
```

### Monitoring Execution:
```bash
# In another terminal, monitor progress
tail -f ralph/progress.txt

# Check current iteration status
ps aux | grep ralph
```

### Debugging Failed Stories:
```bash
# Review failed story details
jq '.features[]?.userStories[]? | select(.passes==false)' features.json

# Check browser screenshots
ls -la *.png

# Review git diff for partial implementations
git diff HEAD~1
```

## Best Practices

### For Optimal Results:
1. **Start with simple stories** - Test Ralph on basic functionality first
2. **Ensure dev server stability** - Reliable server improves success rate
3. **Use specific selectors** - Clear element IDs/classes work better
4. **Test acceptance criteria manually** - Verify they work before Ralph runs
5. **Keep stories atomic** - 30 minutes or less per story

### Monitoring Guidelines:
- Check progress every few hours if running during day
- Review morning logs for overnight runs
- Monitor disk space (Ralph creates screenshots)
- Keep git repository clean before starting

This command launches the full Ralph autonomous development experience,
turning validated PRDs into working features through overnight execution.